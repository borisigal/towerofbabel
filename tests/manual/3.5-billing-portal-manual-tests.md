# Story 3.5 - Manual Testing Scenarios

**Story:** Account Settings & Billing Portal
**CRITICAL:** Cancelled User Access Control (Financially Sensitive)

---

## Prerequisites

- Local development environment running
- Test Lemon Squeezy account configured
- Test users for each tier: trial, payg, pro, cancelled
- Browser DevTools open (Network tab for API calls)

---

## Test Scenario 1: Pro User - Manage Billing Flow

**Objective:** Verify Pro user can access Customer Portal successfully

**Steps:**
1. Sign in as Pro user (active subscription)
2. Navigate to `/dashboard/settings`
3. Verify "Billing & Subscription" section displays:
   - Current Plan: "Pro Subscription"
   - Monthly Cost: "$10.00"
   - Next Renewal: [future date]
   - Subscription Status: "active"
   - "Manage Billing" button visible
4. Click "Manage Billing" button
5. Verify loading spinner appears on button
6. Wait for redirect to Lemon Squeezy portal
7. Verify portal URL contains: `lemonsqueezy.com`
8. In portal, verify:
   - TowerOfBabel branding visible (logo, colors)
   - Subscription details correct
   - "Update payment method" option available
   - "Cancel subscription" option available
9. Click "Return to app" link in portal
10. Verify redirect to `/dashboard?billing=returned`
11. Verify success toast: "Billing Updated"
12. Verify query param cleared from URL

**Expected Result:** ✅ Pro user can manage billing successfully

**Critical Check:** No errors in console, API returns 200 status

---

## Test Scenario 2: PAYG User - Manage Billing Flow

**Objective:** Verify PAYG user can access Customer Portal

**Steps:**
1. Sign in as PAYG user (pay-as-you-go subscription)
2. Navigate to `/dashboard/settings`
3. Verify "Billing & Subscription" section displays:
   - Current Plan: "Pay-As-You-Go"
   - Monthly Cost: "Usage-based ($0.50 per interpretation)"
   - Usage: "Unlimited messages (pay per use)"
   - "Manage Billing" button visible
4. Click "Manage Billing" button
5. Verify redirect to Lemon Squeezy portal
6. In portal, verify payment method can be updated
7. Return to app

**Expected Result:** ✅ PAYG user can manage billing successfully

---

## Test Scenario 3: Trial User - No Billing Access

**Objective:** Verify trial user sees upgrade message (no portal access)

**Steps:**
1. Sign in as Trial user (no subscription)
2. Navigate to `/dashboard/settings`
3. Verify "Billing & Subscription" section displays:
   - Current Plan: "Free Trial"
   - Usage: "[X] of 10 free messages remaining"
   - Message: "No billing information yet. Upgrade to Pro to manage billing."
   - "Upgrade to Pro" button visible (NOT "Manage Billing")
   - NO "Manage Billing" button

**Expected Result:** ✅ Trial user sees upgrade message, no portal access

---

## Test Scenario 4: CRITICAL - Cancelled User BLOCKED from Dashboard

**Objective:** Verify cancelled user is COMPLETELY blocked from dashboard access

**CRITICAL SECURITY TEST - FINANCIALLY SENSITIVE**

**Steps:**
1. Sign in as user with CANCELLED subscription (tier='cancelled' in database)
2. Attempt to navigate to `/dashboard`
3. **CRITICAL:** Verify IMMEDIATE redirect to `/subscription-required`
4. Verify subscription-required page displays:
   - Warning icon (red)
   - Title: "Subscription Required"
   - Message: "Your subscription has been cancelled"
   - Cancellation date displayed
   - "View Pricing Plans" button
   - "Contact Support" button
5. Attempt to directly access `/dashboard/settings`
6. **CRITICAL:** Verify redirect to `/subscription-required` (blocked)
7. Attempt to directly access `/dashboard/interpret`
8. **CRITICAL:** Verify redirect to `/subscription-required` (blocked)
9. Check browser console for security audit log (if dev mode)

**Expected Result:** ✅ Cancelled user is COMPLETELY BLOCKED from ALL dashboard routes

**Critical Validation:**
- ❌ Cancelled user CANNOT access dashboard
- ❌ Cancelled user CANNOT interpret messages
- ❌ Cancelled user CANNOT access settings
- ✅ Security audit log created (check server logs)

**Financial Impact:** If this test fails, cancelled users may access paid features without paying

---

## Test Scenario 5: Portal API - Rate Limiting

**Objective:** Verify rate limiting prevents abuse

**Steps:**
1. Sign in as Pro user
2. Open browser DevTools → Network tab
3. Navigate to `/dashboard/settings`
4. Rapidly click "Manage Billing" button 15 times
5. Verify after 10 requests:
   - API returns 429 (Too Many Requests)
   - Toast shows: "Too many requests. Please try again later."
   - Rate limit headers present: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset
6. Wait 1 minute
7. Try again - should work

**Expected Result:** ✅ Rate limiting protects API from abuse

---

## Test Scenario 6: Portal API - Error Handling

**Objective:** Verify graceful error handling when Lemon Squeezy API fails

**Steps:**
1. Sign in as Pro user
2. **Simulate failure:** Temporarily disconnect internet or block lemonsqueezy.com
3. Navigate to `/dashboard/settings`
4. Click "Manage Billing" button
5. Verify error toast displays: "Failed to access billing portal. Please try again."
6. Verify button returns to normal state (not stuck loading)
7. Verify no crash or blank screen

**Expected Result:** ✅ Errors handled gracefully with user-friendly message

---

## Test Scenario 7: Cancelled User - Webhook Flow (End-to-End)

**Objective:** Verify subscription cancellation immediately blocks access

**Steps:**
1. Sign in as Pro user (active subscription)
2. Verify dashboard access works
3. Navigate to Lemon Squeezy dashboard (test mode)
4. Cancel the user's subscription
5. Verify webhook received (check server logs)
6. Verify database updated: `tier = 'cancelled'`
7. **CRITICAL:** In user browser, try to navigate to `/dashboard`
8. **CRITICAL:** Verify IMMEDIATE redirect to `/subscription-required`
9. Verify no delay - access blocked instantly

**Expected Result:** ✅ Cancellation immediately blocks dashboard access

**Critical Check:** Verify database-as-source-of-truth pattern works (even if JWT is stale)

---

## Test Scenario 8: Mobile Responsiveness

**Objective:** Verify billing section works on mobile devices

**Steps:**
1. Open DevTools → Device Toolbar (iPhone 12 Pro)
2. Sign in as Pro user
3. Navigate to `/dashboard/settings`
4. Verify responsive layout:
   - Billing section stacks vertically
   - "Manage Billing" button full-width on mobile
   - Text readable at mobile size
   - No horizontal scroll
5. Click "Manage Billing" button
6. Verify portal opens and is mobile-friendly

**Expected Result:** ✅ Billing section works on mobile devices

---

## Test Scenario 9: Accessibility (WCAG 2.1 AA)

**Objective:** Verify keyboard navigation and screen reader support

**Steps:**
1. Sign in as Pro user
2. Navigate to `/dashboard/settings` using keyboard only (Tab key)
3. Verify "Manage Billing" button is keyboard accessible
4. Press Enter on button
5. Verify portal opens
6. Test with screen reader (NVDA/JAWS):
   - Verify billing section has proper headings
   - Verify button has descriptive label
   - Verify subscription status is announced

**Expected Result:** ✅ Billing section is fully accessible

---

## Test Scenario 10: Browser Compatibility

**Objective:** Verify billing portal works across browsers

**Browsers to test:**
- ✅ Chrome (latest)
- ✅ Firefox (latest)
- ✅ Safari (latest)
- ✅ Edge (latest)

**Steps for each browser:**
1. Sign in as Pro user
2. Navigate to `/dashboard/settings`
3. Click "Manage Billing" button
4. Verify redirect to Lemon Squeezy portal works
5. Verify return flow works

**Expected Result:** ✅ Works consistently across all browsers

---

## Critical Failure Scenarios (Must NOT occur)

❌ **CRITICAL FAILURE:** Cancelled user can access dashboard
❌ **CRITICAL FAILURE:** Trial user can access Customer Portal
❌ **CRITICAL FAILURE:** API call succeeds without authentication
❌ **CRITICAL FAILURE:** Rate limiting bypassed
❌ **CRITICAL FAILURE:** Portal URL exposed in client-side code

---

## Test Sign-Off

**Tester:** ___________________________
**Date:** ___________________________
**All Scenarios Passed:** ☐ Yes ☐ No
**Critical Scenarios Passed:** ☐ Yes ☐ No

**Notes:**
