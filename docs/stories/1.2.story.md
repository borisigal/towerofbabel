# Story 1.2: Set Up Vercel Deployment Pipeline

<!-- Powered by BMAD™ Core -->

## Status

**Draft**

---

## Story

**As a** developer,
**I want** Vercel connected to the Git repository with automatic deployments for preview and production,
**so that** every code change is automatically deployed and testable in live environments.

---

## Acceptance Criteria

1. Vercel project created and linked to Git repository (GitHub/GitLab)
2. Automatic preview deployments configured for all branches (unique URL per branch)
3. Production deployment configured for main branch (custom domain optional for MVP)
4. **UPDATED:** Environment variables configured in Vercel dashboard from .env.local.example template:
   - All variables from template added to Vercel (preview and production environments)
   - Placeholder values replaced with actual service credentials (where available)
5. Successful deployment verified with accessible preview URL
6. Build logs show successful Next.js build with no errors
7. Health-check route (/api/health) returns 200 OK in deployed preview environment
   - Response shows `{"status": "ok", "timestamp": "...", "database": "pending"}`

---

## Tasks / Subtasks

- [ ] **Task 1: Create and Link Vercel Project to Git Repository** (AC: 1)
  - [ ] Sign up for Vercel account (if not already created)
  - [ ] Install Vercel CLI globally: `npm install -g vercel`
  - [ ] Link project to Git provider (GitHub/GitLab) via Vercel dashboard
  - [ ] Import TowerOfBabel repository to Vercel
  - [ ] Verify Git repository connection established
  - [ ] Configure project settings (framework preset: Next.js, root directory: `./`)

- [ ] **Task 2: Configure Automatic Preview Deployments** (AC: 2)
  - [ ] Enable automatic preview deployments in Vercel project settings
  - [ ] Configure preview deployment trigger: all branches (except main)
  - [ ] Set build command: `npm run build` (default Next.js)
  - [ ] Set install command: `npm install`
  - [ ] Verify preview deployment generates unique URL per branch
  - [ ] Test preview deployment by creating a test branch and pushing commit

- [ ] **Task 3: Configure Production Deployment** (AC: 3)
  - [ ] Configure production deployment trigger: main branch only
  - [ ] Set production build settings (same as preview: `npm run build`)
  - [ ] Custom domain configuration: SKIP for MVP (optional per AC #3)
  - [ ] Verify production deployment uses main branch
  - [ ] Document production URL for team access

- [ ] **Task 4: Configure Environment Variables in Vercel** (AC: 4)
  - [ ] Access Vercel project settings → Environment Variables
  - [ ] Add all variables from .env.local.example to Vercel dashboard [Source: Story 1.1 completion notes]
  - [ ] Configure variable scope for each:
    - Preview environment (all branches except main)
    - Production environment (main branch only)
  - [ ] **IMPORTANT:** Use placeholder values for now (actual credentials added in later stories):
    - DATABASE_URL: Placeholder (Story 1.3 will provide actual Supabase connection string)
    - NEXT_PUBLIC_SUPABASE_URL: Placeholder (Story 1.3)
    - NEXT_PUBLIC_SUPABASE_ANON_KEY: Placeholder (Story 1.3)
    - STRIPE_SECRET_KEY: Placeholder (Epic 3)
    - STRIPE_WEBHOOK_SECRET: Placeholder (Epic 3)
    - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: Placeholder (Epic 3)
    - LLM_PROVIDER: `openai` (default, can change after benchmarking)
    - OPENAI_API_KEY: Placeholder (Epic 2)
    - KV_REST_API_URL: Will be auto-populated when KV instance created (Story 1.5B)
    - KV_REST_API_TOKEN: Will be auto-populated when KV instance created (Story 1.5B)
    - SENTRY_DSN: Placeholder (Story 1.5B)
    - COST_LIMIT_DAILY: `50` (default)
    - COST_LIMIT_HOURLY: `5` (default)
    - COST_LIMIT_USER_DAILY: `1` (default)
  - [ ] Document which variables need real values in future stories

- [ ] **Task 5: Trigger Initial Deployment** (AC: 5, 6)
  - [ ] Push latest main branch code to trigger production deployment
  - [ ] Monitor Vercel build logs for errors
  - [ ] Verify build succeeds with no TypeScript/ESLint errors
  - [ ] Verify deployment completes successfully
  - [ ] Access deployed production URL
  - [ ] Save production URL for verification

- [ ] **Task 6: Verify Health-Check Route in Deployed Environment** (AC: 7)
  - [ ] Access deployed production URL + `/api/health`
  - [ ] Verify HTTP 200 OK response
  - [ ] Verify JSON response structure:
    ```json
    {
      "status": "ok",
      "timestamp": "<ISO-8601 timestamp>",
      "database": "pending"
    }
    ```
  - [ ] Verify timestamp is current (not stale/cached)
  - [ ] Test health-check route in preview environment as well

- [ ] **Task 7: Test Preview Deployment Workflow** (AC: 2)
  - [ ] Create a test feature branch (e.g., `test/deployment-check`)
  - [ ] Make a small change (e.g., update README.md)
  - [ ] Push branch to Git repository
  - [ ] Verify Vercel automatically creates preview deployment
  - [ ] Access preview URL and verify changes visible
  - [ ] Verify preview URL is unique to branch
  - [ ] Test health-check route in preview environment
  - [ ] Delete test branch after verification

- [ ] **Task 8: Document Deployment Process in README** (AC: 1-7)
  - [ ] Update README.md with deployment section
  - [ ] Document Vercel project URL
  - [ ] Document production URL
  - [ ] Document how to trigger deployments (push to Git)
  - [ ] Document how to access preview deployments (create branch, push)
  - [ ] Document environment variable configuration process
  - [ ] Note that preview deployments have unique URLs per branch

---

## Dev Notes

### Vercel Platform Overview

**Platform Selection Rationale** [Source: architecture/2-high-level-architecture.md#platform-and-infrastructure-choice]:

Vercel was selected for the following reasons:
1. **PRD explicitly recommends Vercel** for hosting
2. **Fastest time to production:** Zero DevOps overhead, automatic HTTPS, automatic deployments
3. **Cost efficiency:** Generous free tier sufficient for MVP
4. **Developer experience:** Preview URLs for every PR (essential for rapid iteration)
5. **Edge network:** Global CDN with automatic replication
6. **Serverless architecture:** Auto-scaling without capacity planning

**Platform Services Used:**
- **Hosting:** Vercel Edge Functions (Next.js API routes), global CDN
- **CI/CD:** Automatic deployment via Git integration (preview + production)
- **Analytics:** Vercel Analytics (Core Web Vitals monitoring - built-in)
- **Monitoring:** Basic metrics included, enhanced with Sentry in Story 1.5B

### Deployment Architecture

**Continuous Deployment Workflow** [Source: architecture/2-high-level-architecture.md]:

```
Developer Push → Git Repository → Vercel Build → Deploy to Edge Network
                                     ↓
                              Build Process:
                              1. npm install
                              2. TypeScript compilation
                              3. ESLint checks
                              4. Next.js build
                              5. Asset optimization
                              6. Deploy to CDN
```

**Deployment Environments:**
- **Production:** Main branch → vercel.app production URL
- **Preview:** All other branches → unique preview URLs (e.g., `towerofbabel-git-feature-xyz.vercel.app`)
- **Local:** Development server (localhost:3000)

**Deployment Regions** [Source: architecture/2-high-level-architecture.md]:
- **Primary region:** US East (lowest latency for ~60% of target market per PRD)
- **Global edge network:** Automatic CDN distribution
- **Static assets:** Automatic global replication
- **Database:** Single region initially (US East on Supabase), can enable multi-region post-launch

### Environment Variables Configuration

**Environment Variable Management** [Source: architecture/13-development-workflow.md]:

Vercel supports environment variables at three levels:
1. **Production:** Used for main branch deployments
2. **Preview:** Used for all branch preview deployments
3. **Development:** Downloaded to local `.env.local` via Vercel CLI (optional)

**Variable Configuration Approach for Story 1.2:**
- Add ALL variables from .env.local.example to Vercel dashboard
- Use placeholder values for services not yet configured (Supabase, Stripe, LLM, Sentry)
- Use actual default values for configuration variables (cost limits)
- Future stories will update placeholder values with real credentials

**Critical Variables (Placeholders for Now):**
- `DATABASE_URL`: Story 1.3 will provide Supabase PostgreSQL connection string with PgBouncer
- `NEXT_PUBLIC_SUPABASE_URL`: Story 1.3 will provide Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Story 1.3 will provide Supabase anonymous key
- `KV_REST_API_URL` + `KV_REST_API_TOKEN`: Story 1.5B will auto-create when Vercel KV instance added
- `SENTRY_DSN`: Story 1.5B will provide Sentry project DSN
- `STRIPE_*`: Epic 3 will provide Stripe credentials
- `LLM API keys`: Epic 2 will provide after Week 1 benchmarking

**Configuration Variables (Use Defaults):**
- `LLM_PROVIDER`: `openai` (default, can change after benchmarking)
- `COST_LIMIT_DAILY`: `50`
- `COST_LIMIT_HOURLY`: `5`
- `COST_LIMIT_USER_DAILY`: `1`
- `PRO_MESSAGE_LIMIT`: `100`

### Git Repository Integration

**Repository Connection Process:**
1. Navigate to Vercel dashboard → "Add New Project"
2. Select Git provider (GitHub or GitLab)
3. Authorize Vercel to access repository
4. Import TowerOfBabel repository
5. Vercel auto-detects Next.js framework preset
6. Configure project settings (default settings should work)
7. Deploy

**Automatic Deployment Triggers:**
- **Push to main branch:** Triggers production deployment
- **Push to any other branch:** Triggers preview deployment with unique URL
- **Pull request creation:** Automatically generates preview deployment comment with URL
- **Commit to open PR:** Updates existing preview deployment

**Branch Protection (Optional but Recommended):**
- Require PR reviews before merging to main
- Require passing build checks (Vercel deployment must succeed)
- Enable status checks from Vercel deployment

### Build Configuration

**Next.js Build Process** [Source: architecture/3-tech-stack.md]:

Vercel automatically runs the following during deployment:
1. **Install dependencies:** `npm install` (uses package-lock.json for reproducibility)
2. **TypeScript compilation:** `tsc --noEmit` (type checking)
3. **ESLint checks:** `npm run lint` (if script exists)
4. **Next.js build:** `npm run build`
   - Turbopack for development, Webpack for production
   - Automatic code splitting
   - Tree-shaking for minimal bundle size
   - Image optimization
   - Static generation for static pages
   - Server-side rendering preparation
5. **Deploy to Edge:** Upload optimized assets to global CDN

**Build Settings (Auto-Detected):**
- **Framework Preset:** Next.js
- **Build Command:** `npm run build` (or `next build`)
- **Install Command:** `npm install`
- **Output Directory:** `.next` (automatic)
- **Node.js Version:** 18.x or 20.x (Vercel default, compatible with Next.js 14)

**Build Optimization:**
- Next.js 14 uses Turbopack for faster builds in development
- Production builds use Webpack for mature stability
- Automatic tree-shaking removes unused code
- Image optimization via Next.js Image component
- Font optimization via Next.js Font loading

### Health-Check Route Verification

**Health-Check Route Created in Story 1.1** [Source: Story 1.1 completion notes]:

The `/api/health` route was created in Story 1.1 and returns:
```json
{
  "status": "ok",
  "timestamp": "<ISO-8601 timestamp>",
  "database": "pending"
}
```

**Purpose in Story 1.2:**
- **Deployment verification:** Confirms Next.js API routes work in Vercel environment
- **Routing verification:** Confirms Next.js App Router correctly routes `/api/health` to `app/api/health/route.ts`
- **Build verification:** Confirms TypeScript compilation succeeded
- **Environment verification:** Confirms deployed application is running (not just static files)

**Expected Response:**
- HTTP Status: `200 OK`
- Content-Type: `application/json`
- Body: JSON object with `status`, `timestamp`, `database` fields
- `database` field will show `"pending"` until Story 1.3 (no database configured yet)

**Evolution in Future Stories:**
- Story 1.3: Update to test database connection, return `"connected"` when database reachable
- Story 1.5B: Add KV and Sentry status fields

### Preview Deployment Workflow

**Preview URL Format:**
- Pattern: `{project-name}-git-{branch-name}-{team-name}.vercel.app`
- Example: `towerofbabel-git-feature-dashboard-acme.vercel.app`
- Each branch gets a unique, persistent URL
- URL remains consistent across commits to the same branch

**Preview Deployment Benefits:**
1. **Isolated testing:** Test features without affecting production
2. **Shareable URLs:** Send preview links to stakeholders for review
3. **Automatic updates:** New commits to branch automatically update preview
4. **PR integration:** GitHub/GitLab displays preview URL in PR comments
5. **Environment parity:** Preview uses same build process as production

**Common Use Cases:**
- Feature development: Test new features before merging to main
- Bug fixes: Verify fixes work in deployed environment
- Stakeholder review: Share preview URLs for non-technical feedback
- QA testing: Test in production-like environment

### Vercel CLI (Optional)

**Vercel CLI Installation:**
```bash
npm install -g vercel
```

**Useful Commands:**
- `vercel login`: Authenticate with Vercel account
- `vercel link`: Link local project to Vercel project
- `vercel env pull`: Download environment variables to `.env.local`
- `vercel dev`: Run local development server with Vercel environment
- `vercel deploy`: Manual deployment (not needed with Git integration)
- `vercel logs`: View deployment logs

**When to Use Vercel CLI:**
- Downloading production environment variables to local development (optional)
- Debugging deployment issues locally
- Manual deployments (rare, Git integration is preferred)

**Note:** Vercel CLI is NOT required for this story. Git integration handles all deployments automatically.

### Deployment Checklist Reference

**From Architecture Document** [Source: architecture/15-deployment-strategy.md]:

Pre-Launch checklist (Epic 1 Complete) includes:
1. [ ] All environment variables configured in Vercel ← **THIS STORY (placeholders)**
2. [ ] Supabase RLS policies enabled ← Story 1.3
3. [ ] Prisma migrations applied to production database ← Story 1.3
4. [ ] Sentry project created and DSN configured ← Story 1.5B
5. [ ] Stripe webhook endpoint registered ← Epic 3
6. [ ] Cost circuit breaker tested with mock LLM calls ← Story 1.5C
7. [ ] Integration tests passing ← Story 1.5A
8. [ ] Lighthouse score ≥ 90 ← Epic 5

### Build Error Troubleshooting

**Common Build Errors and Solutions:**

1. **TypeScript compilation errors:**
   - Cause: Type errors not caught locally
   - Solution: Run `npm run build` locally before pushing
   - Verify: `tsc --noEmit` passes locally

2. **ESLint errors:**
   - Cause: Linting rules violations
   - Solution: Run `npm run lint` locally, fix errors
   - Auto-fix: `npm run lint -- --fix`

3. **Missing environment variables:**
   - Cause: Code references environment variable not configured in Vercel
   - Solution: Add missing variable to Vercel dashboard
   - Note: Placeholder values are OK for Story 1.2

4. **Dependency installation failures:**
   - Cause: package-lock.json out of sync
   - Solution: Delete package-lock.json, run `npm install`, commit new lock file
   - Ensure: package-lock.json is committed (required per architecture)

5. **Next.js build errors:**
   - Cause: Invalid Next.js configuration
   - Solution: Check next.config.js for syntax errors
   - Test: Run `npm run build` locally

**Debugging Build Failures:**
1. Check Vercel build logs (accessible from deployment page)
2. Look for specific error message in logs
3. Reproduce error locally: `npm run build`
4. Fix error, commit, push to trigger new deployment
5. Monitor new deployment logs

### Infrastructure as Code (Optional)

**vercel.json Configuration** [Source: architecture/3-tech-stack.md]:

Vercel supports optional `vercel.json` configuration file for infrastructure as code. For Story 1.2, this is **NOT required** (Vercel auto-detects Next.js settings).

**Optional vercel.json (Future Enhancement):**
```json
{
  "buildCommand": "npm run build",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["iad1"],
  "env": {
    "NODE_ENV": "production"
  }
}
```

**When to Add vercel.json:**
- Custom build commands needed
- Specific region requirements (default: global is fine)
- Advanced routing rules (not needed for Story 1.2)
- Custom headers or redirects (defer to later stories)

**For Story 1.2:** Skip vercel.json creation. Vercel auto-detection works perfectly for Next.js projects.

### Deployment Success Verification Checklist

After completing all tasks, verify:
- [ ] Vercel project created and linked to Git repository
- [ ] Main branch triggers production deployment automatically
- [ ] Feature branches trigger preview deployments with unique URLs
- [ ] Production URL accessible and loads Next.js application
- [ ] Health-check route returns 200 OK with correct JSON structure
- [ ] Build logs show successful TypeScript compilation
- [ ] Build logs show successful Next.js build
- [ ] No build errors in Vercel dashboard
- [ ] Environment variables configured (even if placeholders)
- [ ] README.md updated with deployment instructions

### Previous Story Integration

**Dependencies from Story 1.1** [Source: Story 1.1 completion notes]:

This story depends on Story 1.1 completion:
- ✅ Next.js 14.2.33 project with TypeScript 5.3 initialized
- ✅ Git repository initialized and committed to main branch
- ✅ Health-check route created at `app/api/health/route.ts`
- ✅ .env.local.example created with comprehensive environment variable documentation
- ✅ README.md created with project setup instructions
- ✅ All tests passing (Vitest)
- ✅ TypeScript compilation succeeds
- ✅ ESLint and Prettier configured

**What This Story Enables:**

Story 1.2 completion enables:
- **Story 1.3:** Deployment pipeline ready for database migrations via `prisma migrate deploy`
- **Story 1.4:** Authentication testing in deployed environment
- **Story 1.5A:** Dashboard accessible via deployed URL
- **All future stories:** Continuous deployment for rapid iteration

### Dependencies on Future Stories

**What Story 1.2 Does NOT Include:**

The following will be added in later stories:
- **Database connection:** Story 1.3 will update environment variables with real Supabase credentials
- **Authentication:** Story 1.4 will add Supabase Auth configuration
- **Monitoring:** Story 1.5B will add Vercel KV and Sentry
- **Custom domain:** Epic 5 (optional for MVP per AC #3)
- **CI/CD enhancements:** Linting checks, test runs (can be added later if desired)

### Testing

**Deployment Testing Requirements:**

For this story, testing consists of:
1. **Manual verification:** Access deployed URLs and verify application loads
2. **Health-check validation:** Call `/api/health` endpoint, verify 200 OK response
3. **Build log review:** Verify no errors in Vercel build logs
4. **Preview deployment test:** Create test branch, verify unique preview URL generated

**No Automated Tests Required:**
- This story is about infrastructure configuration, not code changes
- Existing unit tests from Story 1.1 will run during Vercel build process
- Integration tests will be added in Story 1.5A

**Future Testing Enhancements:**
- Epic 5: Add Lighthouse performance testing
- Epic 5: Add end-to-end deployment smoke tests

### Common Pitfalls to Avoid

1. **Forgetting to configure environment variables:** Deployment will build but may fail at runtime. Add ALL variables from .env.local.example, even with placeholder values.

2. **Not testing preview deployments:** Always test preview URL workflow to ensure feature branch deployments work.

3. **Skipping health-check verification:** This route validates Next.js API routes work in Vercel environment. Don't skip this verification step.

4. **Using incorrect Git branch for production:** Ensure main branch (not master or other) is configured for production deployments.

5. **Not documenting deployment URLs:** Update README.md with production URL so team knows where to access deployed application.

6. **Expecting database to work:** Database is NOT configured yet (Story 1.3). Health-check will show `"database": "pending"` - this is expected.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Story created and enriched with architecture context | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results
*To be populated by QA agent*
