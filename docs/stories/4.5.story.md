# Story 4.5: Create Feedback Analytics Dashboard (Admin View)

<!-- Powered by BMAD™ Core -->

## Status

**Done**

**PO Validation Date:** 2025-10-30
**Validation Score:** 10/10 (Excellent - Enhanced with complete code examples)
**Implementation Date:** 2025-10-30

---

## Story

**As a** product manager,
**I want** to view feedback analytics across all interpretations,
**so that** I can identify prompt improvements needed and track quality over time.

---

## Acceptance Criteria

1. Admin dashboard accessible at /app/admin/feedback (protected route, admin users only)
2. Dashboard displays overall feedback statistics:
   - Total interpretations: count
   - Inbound positive feedback rate: X% (thumbs up / total with feedback)
   - Outbound positive feedback rate: X% (thumbs up / total with feedback)
3. Feedback breakdown by culture pair: Top 5 pairs with lowest positive feedback rate
4. Time-series chart showing daily feedback trends (optional for MVP, can defer)
5. Filter by date range (last 7 days, 30 days, all time)
6. Export feedback data as CSV for deeper analysis
7. No message content displayed (privacy maintained)
8. Admin role flag already exists in User model (is_admin boolean)
9. Only users with is_admin=true can access dashboard
10. Basic analytics queries use Prisma aggregation (no external analytics tool needed for MVP)

---

## Context

Epic 4 introduces quality feedback mechanism (Story 4.4) for both inbound and outbound interpretations. This story creates an admin analytics dashboard to visualize feedback trends, identify problem areas, and guide LLM prompt improvements.

**Business Value:**
1. **Quality measurement**: Track overall interpretation quality via user feedback
2. **Problem identification**: Find culture pairs or scenarios with low satisfaction rates
3. **Data-driven optimization**: Prioritize prompt refinements based on real user feedback
4. **ROI tracking**: Demonstrate product improvement over time to stakeholders

**Privacy-first approach:** Dashboard displays ONLY aggregated statistics and metadata. No message content is stored or displayed, maintaining privacy-first architecture.

**MVP scope:** This story focuses on essential analytics for prompt optimization. Advanced features (time-series charts, A/B testing) can be added in future iterations based on PM needs.

---

## Technical Approach

### 1. Authentication & Authorization

**Middleware update** (`middleware.ts`):
- Add `/admin/*` to protected routes (requires authentication)
- Follows same pattern as `/dashboard` routes

**Admin authorization** (API routes and page):
- Check `user.is_admin === true` from database (not JWT)
- Return 403 Forbidden for non-admin users
- Pattern already established in `/app/api/admin/cost-metrics/route.ts`

**Note:** `is_admin` field already exists in User model (no schema migration needed).

[Source: architecture/16-coding-standards.md#api-route-structure, architecture/13-security-model.md#authorization]

### 2. Database Queries

All queries use Prisma aggregation for performance (no need for external analytics tools in MVP).

**Overall Statistics:**
```typescript
// Total interpretations
const totalInterpretations = await prisma.interpretation.count({
  where: { timestamp: { gte: startDate, lte: endDate } }
});

// Inbound feedback stats
const inboundStats = await prisma.interpretation.groupBy({
  by: ['feedback'],
  where: {
    interpretation_type: 'inbound',
    feedback: { not: null },
    timestamp: { gte: startDate, lte: endDate }
  },
  _count: true
});

// Outbound feedback stats (same query, different interpretation_type)
```

**Culture Pair Analysis:**
```typescript
// Group by culture pair, calculate positive rate
const culturePairStats = await prisma.interpretation.groupBy({
  by: ['culture_sender', 'culture_receiver'],
  where: {
    feedback: { not: null },
    timestamp: { gte: startDate, lte: endDate }
  },
  _count: true,
  _sum: {
    // Use CASE statement or post-processing
  }
});

// Sort by positive rate (ascending) to find problematic pairs
// Take top 5 lowest
```

[Source: architecture/5-data-model.md#prisma-aggregation, Epic 4 Story 4.5 AC #2, #3]

**Export Query:**
```typescript
// Fetch all interpretations with feedback (metadata only)
const feedbackData = await prisma.interpretation.findMany({
  where: {
    feedback: { not: null },
    timestamp: { gte: startDate, lte: endDate }
  },
  select: {
    id: true,
    timestamp: true,
    interpretation_type: true,
    culture_sender: true,
    culture_receiver: true,
    feedback: true,
    feedback_timestamp: true,
    character_count: true,
    llm_provider: true,
    response_time_ms: true,
    cost_usd: true,
    // EXCLUDE: No message content fields
  },
  orderBy: { timestamp: 'desc' }
});
```

### 3. UI Component Structure

**Page:** `/app/admin/feedback/page.tsx` (Server Component)
- Fetch aggregated statistics server-side
- Pass data to client components via props
- Handle authentication check (redirect if not admin)

**Components:**

1. **OverallStats.tsx** (Client Component)
   - Display cards: Total interpretations, Inbound rate, Outbound rate
   - Visual: Large metric cards with percentage badges

2. **CulturePairTable.tsx** (Client Component)
   - Table showing Top 5 problematic culture pairs
   - Columns: Sender, Receiver, Total, Thumbs Up, Thumbs Down, Positive Rate
   - Sort by positive rate (ascending)

3. **DateRangeFilter.tsx** (Client Component)
   - Dropdown: Last 7 days | Last 30 days | All time
   - Updates URL params (searchParams)
   - Triggers page re-render (Server Component refetch)

4. **ExportButton.tsx** (Client Component)
   - Calls GET /api/admin/feedback/export
   - Downloads CSV file with feedback metadata

**Optional (defer to v2):**
5. **TimeSeriesChart.tsx** (Client Component)
   - Line chart showing daily feedback trends
   - Uses Chart.js or Recharts library
   - Shows thumbs up/down over time

[Source: architecture/10-frontend-architecture.md#component-structure, architecture/3-tech-stack.md#ui-components]

### 4. CSV Export Format

```csv
interpretation_id,timestamp,type,sender_culture,receiver_culture,feedback,feedback_timestamp,character_count,llm_provider,response_time_ms,cost_usd
abc-123,2025-10-30T14:32:00Z,inbound,en-US,ja-JP,up,2025-10-30T14:35:12Z,450,anthropic,1250,0.0023
def-456,2025-10-30T15:10:00Z,outbound,en-US,de-DE,down,2025-10-30T15:12:45Z,320,anthropic,980,0.0019
...
```

**Privacy note:** CSV contains ONLY metadata, no message content.

[Source: architecture/5-data-model.md#privacy-design, Epic 4 Story 4.4]

### 5. API Endpoints

**GET /api/admin/feedback/stats**
- Returns aggregated statistics for dashboard
- Query params: `?range=7d|30d|all`
- Response:
```json
{
  "success": true,
  "data": {
    "total_interpretations": 1250,
    "inbound": {
      "total_with_feedback": 450,
      "thumbs_up": 380,
      "thumbs_down": 70,
      "positive_rate": 84.44
    },
    "outbound": {
      "total_with_feedback": 320,
      "thumbs_up": 285,
      "thumbs_down": 35,
      "positive_rate": 89.06
    },
    "culture_pairs": [
      {
        "sender": "en-US",
        "receiver": "zh-CN",
        "total": 45,
        "thumbs_up": 30,
        "thumbs_down": 15,
        "positive_rate": 66.67
      },
      // ... top 5 lowest
    ]
  }
}
```

**GET /api/admin/feedback/export**
- Returns CSV file with feedback metadata
- Query params: `?range=7d|30d|all`
- Response: CSV file download

[Source: architecture/16-coding-standards.md#api-route-structure]

---

## Dev Notes

### Story Context

**This story creates the admin analytics dashboard to visualize feedback trends from Story 4.4.**

**Epic 4 Integration Flow:**
- Story 4.1: Mode toggle UI (DONE)
- Story 4.2: Outbound LLM prompt and API logic (DONE)
- Story 4.3: Side-by-side comparison UI (DONE)
- Story 4.4: Thumbs up/down feedback (DONE)
- **Story 4.5 (THIS STORY):** Feedback analytics dashboard (admin view)

**What Story 4.5 Adds:**
- ✨ **NEW:** Admin feedback dashboard at /admin/feedback
- ✨ **NEW:** feedbackAnalyticsService (business logic layer)
- ✨ **NEW:** GET /api/admin/feedback/stats (aggregated statistics)
- ✨ **NEW:** GET /api/admin/feedback/export (CSV export)
- ✨ **NEW:** 4 admin components (OverallStats, CulturePairTable, DateRangeFilter, ExportButton)
- 🔧 **MODIFIED:** middleware.ts (protect /admin routes)
- 🔧 **MODIFIED:** Admin layout (navigation)

**Key Design Decisions:**
- Admin-only access (is_admin flag check)
- Server Component for dashboard page (SEO, performance)
- Prisma aggregation for analytics (no external tools needed)
- Privacy-first (only aggregated stats, no message content)
- CSV export for deeper analysis
- Date range filtering (7d, 30d, all time)

[Source: Epic 4 Story 4.5 context]

---

### Technical Implementation Details

#### feedbackAnalyticsService (Complete Implementation)

**File: `lib/services/feedbackAnalyticsService.ts`**

```typescript
import { db } from '@/lib/db/client';
import { log } from '@/lib/utils/logger';

/**
 * Date range type for filtering analytics
 */
export type DateRangeType = '7d' | '30d' | 'all';

/**
 * Overall statistics interface
 */
export interface OverallStats {
  total_interpretations: number;
  inbound: {
    total_with_feedback: number;
    thumbs_up: number;
    thumbs_down: number;
    positive_rate: number;
  };
  outbound: {
    total_with_feedback: number;
    thumbs_up: number;
    thumbs_down: number;
    positive_rate: number;
  };
}

/**
 * Culture pair statistics interface
 */
export interface CulturePairStats {
  sender: string;
  receiver: string;
  total: number;
  thumbs_up: number;
  thumbs_down: number;
  positive_rate: number;
}

/**
 * Feedback export data interface
 */
export interface FeedbackExportData {
  interpretation_id: string;
  timestamp: Date;
  type: string;
  sender_culture: string;
  receiver_culture: string;
  feedback: string;
  feedback_timestamp: Date;
  character_count: number;
  llm_provider: string;
  response_time_ms: number;
  cost_usd: number;
}

/**
 * Parses date range string to start date
 * @param range - Date range type ('7d', '30d', 'all')
 * @returns Start date for filtering
 */
export function parseDateRange(range: DateRangeType): Date {
  const now = new Date();

  switch (range) {
    case '7d':
      return new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    case '30d':
      return new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    case 'all':
      return new Date(0); // Unix epoch (1970-01-01)
    default:
      return new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); // Default to 30 days
  }
}

/**
 * Calculates positive feedback rate
 * @param thumbsUp - Number of thumbs up
 * @param thumbsDown - Number of thumbs down
 * @returns Positive rate percentage (0-100)
 */
function calculatePositiveRate(thumbsUp: number, thumbsDown: number): number {
  const total = thumbsUp + thumbsDown;
  if (total === 0) return 0;
  return Math.round((thumbsUp / total) * 10000) / 100; // 2 decimal places
}

/**
 * Gets overall feedback statistics
 *
 * Aggregates feedback data across all interpretations, grouped by
 * interpretation type (inbound/outbound).
 *
 * @param dateRange - Date range filter ('7d', '30d', 'all')
 * @returns Overall statistics object
 */
export async function getOverallStats(dateRange: DateRangeType): Promise<OverallStats> {
  const startDate = parseDateRange(dateRange);

  try {
    log.info('Fetching overall feedback stats', { dateRange, startDate });

    // Total interpretations in date range
    const totalInterpretations = await db.interpretation.count({
      where: {
        timestamp: { gte: startDate },
      },
    });

    // Inbound feedback aggregation
    const inboundFeedback = await db.interpretation.groupBy({
      by: ['feedback'],
      where: {
        interpretation_type: 'inbound',
        feedback: { not: null },
        timestamp: { gte: startDate },
      },
      _count: {
        feedback: true,
      },
    });

    // Calculate inbound stats
    const inboundThumbsUp = inboundFeedback.find((f) => f.feedback === 'up')?._count.feedback || 0;
    const inboundThumbsDown = inboundFeedback.find((f) => f.feedback === 'down')?._count.feedback || 0;
    const inboundTotal = inboundThumbsUp + inboundThumbsDown;
    const inboundPositiveRate = calculatePositiveRate(inboundThumbsUp, inboundThumbsDown);

    // Outbound feedback aggregation
    const outboundFeedback = await db.interpretation.groupBy({
      by: ['feedback'],
      where: {
        interpretation_type: 'outbound',
        feedback: { not: null },
        timestamp: { gte: startDate },
      },
      _count: {
        feedback: true,
      },
    });

    // Calculate outbound stats
    const outboundThumbsUp = outboundFeedback.find((f) => f.feedback === 'up')?._count.feedback || 0;
    const outboundThumbsDown = outboundFeedback.find((f) => f.feedback === 'down')?._count.feedback || 0;
    const outboundTotal = outboundThumbsUp + outboundThumbsDown;
    const outboundPositiveRate = calculatePositiveRate(outboundThumbsUp, outboundThumbsDown);

    log.info('Overall stats fetched successfully', {
      totalInterpretations,
      inboundTotal,
      outboundTotal,
    });

    return {
      total_interpretations: totalInterpretations,
      inbound: {
        total_with_feedback: inboundTotal,
        thumbs_up: inboundThumbsUp,
        thumbs_down: inboundThumbsDown,
        positive_rate: inboundPositiveRate,
      },
      outbound: {
        total_with_feedback: outboundTotal,
        thumbs_up: outboundThumbsUp,
        thumbs_down: outboundThumbsDown,
        positive_rate: outboundPositiveRate,
      },
    };
  } catch (error) {
    log.error('Failed to fetch overall stats', {
      dateRange,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    throw new Error('Failed to fetch overall statistics');
  }
}

/**
 * Gets culture pair statistics (top 5 pairs with lowest positive rates)
 *
 * Identifies problematic culture pairs that need prompt improvements.
 *
 * @param dateRange - Date range filter ('7d', '30d', 'all')
 * @returns Array of culture pair statistics (top 5 lowest positive rates)
 */
export async function getCulturePairStats(dateRange: DateRangeType): Promise<CulturePairStats[]> {
  const startDate = parseDateRange(dateRange);

  try {
    log.info('Fetching culture pair stats', { dateRange, startDate });

    // Get all interpretations with feedback, grouped by culture pair
    const culturePairs = await db.interpretation.groupBy({
      by: ['culture_sender', 'culture_receiver', 'feedback'],
      where: {
        feedback: { not: null },
        timestamp: { gte: startDate },
      },
      _count: {
        feedback: true,
      },
    });

    // Aggregate by culture pair (sender + receiver combination)
    const pairMap = new Map<string, { sender: string; receiver: string; up: number; down: number }>();

    culturePairs.forEach((pair) => {
      const key = `${pair.culture_sender}|${pair.culture_receiver}`;

      if (!pairMap.has(key)) {
        pairMap.set(key, {
          sender: pair.culture_sender,
          receiver: pair.culture_receiver,
          up: 0,
          down: 0,
        });
      }

      const stats = pairMap.get(key)!;
      if (pair.feedback === 'up') {
        stats.up += pair._count.feedback;
      } else if (pair.feedback === 'down') {
        stats.down += pair._count.feedback;
      }
    });

    // Convert to array and calculate positive rates
    const pairStats: CulturePairStats[] = Array.from(pairMap.values()).map((stats) => ({
      sender: stats.sender,
      receiver: stats.receiver,
      total: stats.up + stats.down,
      thumbs_up: stats.up,
      thumbs_down: stats.down,
      positive_rate: calculatePositiveRate(stats.up, stats.down),
    }));

    // Sort by positive rate (ascending) - lowest rates first (problematic pairs)
    pairStats.sort((a, b) => a.positive_rate - b.positive_rate);

    // Return top 5 lowest
    const top5Lowest = pairStats.slice(0, 5);

    log.info('Culture pair stats fetched successfully', {
      totalPairs: pairStats.length,
      top5Count: top5Lowest.length,
    });

    return top5Lowest;
  } catch (error) {
    log.error('Failed to fetch culture pair stats', {
      dateRange,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    throw new Error('Failed to fetch culture pair statistics');
  }
}

/**
 * Exports feedback data as structured array for CSV conversion
 *
 * Returns metadata only (no message content) for privacy.
 *
 * @param dateRange - Date range filter ('7d', '30d', 'all')
 * @returns Array of feedback data (metadata only)
 */
export async function exportFeedbackData(dateRange: DateRangeType): Promise<FeedbackExportData[]> {
  const startDate = parseDateRange(dateRange);

  try {
    log.info('Exporting feedback data', { dateRange, startDate });

    const feedbackData = await db.interpretation.findMany({
      where: {
        feedback: { not: null },
        timestamp: { gte: startDate },
      },
      select: {
        id: true,
        timestamp: true,
        interpretation_type: true,
        culture_sender: true,
        culture_receiver: true,
        feedback: true,
        feedback_timestamp: true,
        character_count: true,
        llm_provider: true,
        response_time_ms: true,
        cost_usd: true,
        // EXCLUDE: No message content fields
      },
      orderBy: {
        timestamp: 'desc',
      },
    });

    const exportData: FeedbackExportData[] = feedbackData.map((item) => ({
      interpretation_id: item.id,
      timestamp: item.timestamp,
      type: item.interpretation_type,
      sender_culture: item.culture_sender,
      receiver_culture: item.culture_receiver,
      feedback: item.feedback!,
      feedback_timestamp: item.feedback_timestamp!,
      character_count: item.character_count,
      llm_provider: item.llm_provider,
      response_time_ms: item.response_time_ms,
      cost_usd: parseFloat(item.cost_usd.toString()),
    }));

    log.info('Feedback data exported successfully', {
      recordCount: exportData.length,
    });

    return exportData;
  } catch (error) {
    log.error('Failed to export feedback data', {
      dateRange,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    throw new Error('Failed to export feedback data');
  }
}
```

**Service Design Notes:**
- **Type-safe**: All functions return strongly-typed interfaces
- **Privacy-first**: exportFeedbackData excludes message content
- **Error handling**: Try-catch with structured logging
- **Aggregation**: Uses Prisma groupBy for performance
- **Date filtering**: Flexible date range support
- **Rate calculation**: Helper function ensures consistent calculation
- **Top N filtering**: Returns top 5 problematic culture pairs

[Source: architecture/16-coding-standards.md#service-layer-patterns, architecture/5-data-model.md#prisma-aggregation]

---

#### GET /api/admin/feedback/stats Endpoint (Complete Implementation)

**File: `app/api/admin/feedback/stats/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { db } from '@/lib/db/client';
import { log } from '@/lib/utils/logger';
import {
  getOverallStats,
  getCulturePairStats,
  type DateRangeType,
} from '@/lib/services/feedbackAnalyticsService';

/**
 * GET /api/admin/feedback/stats
 *
 * Returns aggregated feedback statistics for admin dashboard.
 *
 * Authentication: Required (Supabase session)
 * Authorization: Admin only (is_admin = true)
 * Query params: ?range=7d|30d|all (default: 30d)
 *
 * @param req - Next.js request with query params
 * @returns JSON response with overall stats and culture pair stats
 */
export async function GET(req: NextRequest) {
  const startTime = Date.now();

  try {
    // 1. AUTHENTICATION - Check user session
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      log.warn('Feedback stats request - Unauthorized', {
        error: authError?.message,
      });

      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'UNAUTHORIZED',
            message: 'Authentication required',
          },
        },
        { status: 401 }
      );
    }

    // 2. AUTHORIZATION - Check admin flag from database
    const dbUser = await db.user.findUnique({
      where: { id: user.id },
      select: { is_admin: true },
    });

    if (!dbUser || !dbUser.is_admin) {
      log.warn('Feedback stats request - Forbidden (non-admin)', {
        user_id: user.id,
        is_admin: dbUser?.is_admin,
      });

      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'FORBIDDEN',
            message: 'Admin access required',
          },
        },
        { status: 403 }
      );
    }

    // 3. PARSE QUERY PARAMS
    const { searchParams } = new URL(req.url);
    const rangeParam = searchParams.get('range') || '30d';

    // Validate range parameter
    const validRanges: DateRangeType[] = ['7d', '30d', 'all'];
    const dateRange: DateRangeType = validRanges.includes(rangeParam as DateRangeType)
      ? (rangeParam as DateRangeType)
      : '30d';

    log.info('Fetching feedback stats', {
      user_id: user.id,
      dateRange,
    });

    // 4. FETCH STATISTICS
    const [overallStats, culturePairStats] = await Promise.all([
      getOverallStats(dateRange),
      getCulturePairStats(dateRange),
    ]);

    const responseTimeMs = Date.now() - startTime;

    log.info('Feedback stats fetched successfully', {
      user_id: user.id,
      dateRange,
      response_time_ms: responseTimeMs,
      total_interpretations: overallStats.total_interpretations,
      culture_pairs_count: culturePairStats.length,
    });

    // 5. RESPONSE
    return NextResponse.json(
      {
        success: true,
        data: {
          total_interpretations: overallStats.total_interpretations,
          inbound: overallStats.inbound,
          outbound: overallStats.outbound,
          culture_pairs: culturePairStats,
        },
      },
      { status: 200 }
    );
  } catch (error) {
    const responseTimeMs = Date.now() - startTime;

    log.error('Feedback stats request - Server error', {
      error: error instanceof Error ? error.message : 'Unknown error',
      response_time_ms: responseTimeMs,
    });

    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'SERVER_ERROR',
          message: 'An unexpected error occurred. Please try again.',
        },
      },
      { status: 500 }
    );
  }
}
```

**API Design Notes:**
- **Authentication**: Supabase session required
- **Authorization**: is_admin flag checked from database (not JWT)
- **Query param validation**: Defaults to 30d if invalid
- **Parallel fetching**: Uses Promise.all for performance
- **Structured logging**: Request/response tracking
- **Error handling**: Try-catch with appropriate status codes

[Source: architecture/16-coding-standards.md#api-route-structure, Epic 4 Story 4.5 AC #2, #3, #9]

---

#### GET /api/admin/feedback/export Endpoint (Complete Implementation)

**File: `app/api/admin/feedback/export/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { db } from '@/lib/db/client';
import { log } from '@/lib/utils/logger';
import {
  exportFeedbackData,
  type DateRangeType,
} from '@/lib/services/feedbackAnalyticsService';

/**
 * Converts feedback data array to CSV format
 * @param data - Feedback export data
 * @returns CSV string
 */
function convertToCSV(data: any[]): string {
  if (data.length === 0) {
    return 'interpretation_id,timestamp,type,sender_culture,receiver_culture,feedback,feedback_timestamp,character_count,llm_provider,response_time_ms,cost_usd\n';
  }

  // CSV header
  const headers = Object.keys(data[0]).join(',');

  // CSV rows
  const rows = data.map((row) => {
    return Object.values(row)
      .map((value) => {
        // Handle dates
        if (value instanceof Date) {
          return value.toISOString();
        }
        // Handle strings with commas (escape with quotes)
        if (typeof value === 'string' && value.includes(',')) {
          return `"${value}"`;
        }
        return value;
      })
      .join(',');
  });

  return [headers, ...rows].join('\n');
}

/**
 * GET /api/admin/feedback/export
 *
 * Exports feedback data as CSV file (metadata only, no message content).
 *
 * Authentication: Required (Supabase session)
 * Authorization: Admin only (is_admin = true)
 * Query params: ?range=7d|30d|all (default: 30d)
 *
 * @param req - Next.js request with query params
 * @returns CSV file download
 */
export async function GET(req: NextRequest) {
  const startTime = Date.now();

  try {
    // 1. AUTHENTICATION - Check user session
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      log.warn('Feedback export request - Unauthorized', {
        error: authError?.message,
      });

      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'UNAUTHORIZED',
            message: 'Authentication required',
          },
        },
        { status: 401 }
      );
    }

    // 2. AUTHORIZATION - Check admin flag from database
    const dbUser = await db.user.findUnique({
      where: { id: user.id },
      select: { is_admin: true },
    });

    if (!dbUser || !dbUser.is_admin) {
      log.warn('Feedback export request - Forbidden (non-admin)', {
        user_id: user.id,
        is_admin: dbUser?.is_admin,
      });

      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'FORBIDDEN',
            message: 'Admin access required',
          },
        },
        { status: 403 }
      );
    }

    // 3. PARSE QUERY PARAMS
    const { searchParams } = new URL(req.url);
    const rangeParam = searchParams.get('range') || '30d';

    // Validate range parameter
    const validRanges: DateRangeType[] = ['7d', '30d', 'all'];
    const dateRange: DateRangeType = validRanges.includes(rangeParam as DateRangeType)
      ? (rangeParam as DateRangeType)
      : '30d';

    log.info('Exporting feedback data', {
      user_id: user.id,
      dateRange,
    });

    // 4. FETCH EXPORT DATA
    const feedbackData = await exportFeedbackData(dateRange);

    // 5. CONVERT TO CSV
    const csvContent = convertToCSV(feedbackData);

    const responseTimeMs = Date.now() - startTime;

    log.info('Feedback data exported successfully', {
      user_id: user.id,
      dateRange,
      response_time_ms: responseTimeMs,
      record_count: feedbackData.length,
    });

    // 6. RETURN CSV FILE
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    const filename = `feedback-export-${dateRange}-${today}.csv`;

    return new NextResponse(csvContent, {
      status: 200,
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="${filename}"`,
      },
    });
  } catch (error) {
    const responseTimeMs = Date.now() - startTime;

    log.error('Feedback export request - Server error', {
      error: error instanceof Error ? error.message : 'Unknown error',
      response_time_ms: responseTimeMs,
    });

    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'SERVER_ERROR',
          message: 'An unexpected error occurred. Please try again.',
        },
      },
      { status: 500 }
    );
  }
}
```

**CSV Export Design Notes:**
- **Authentication**: Supabase session required
- **Authorization**: Admin-only access
- **CSV format**: Standard RFC 4180 format
- **Filename**: Includes date range and current date
- **Content-Type**: text/csv header
- **Content-Disposition**: Forces browser download
- **Privacy**: Only metadata exported (no message content)
- **Helper function**: convertToCSV handles escaping and formatting

[Source: architecture/16-coding-standards.md#api-route-structure, Epic 4 Story 4.5 AC #6, #7]

---

#### Admin Dashboard Page & Components (Complete Implementations)

Due to length, the complete implementations for the admin dashboard page and all 4 admin components (OverallStats, CulturePairTable, DateRangeFilter, ExportButton) are provided as high-level code structures with key patterns. Dev agent should follow these patterns:

**Admin Dashboard Page Pattern** (`app/admin/feedback/page.tsx`):
- Server Component for data fetching
- Check authentication + authorization (redirect if not admin)
- Parse searchParams for date range
- Fetch stats server-side via feedbackAnalyticsService
- Pass data to client components as props
- Handle loading and error states

**OverallStats Component Pattern** (`components/admin/OverallStats.tsx`):
- Client Component ('use client')
- Displays 3 shadcn/ui Card components in responsive grid
- Color indicators: Green (≥80%), Yellow (60-79%), Red (<60%)
- Shows percentage with breakdown (X up / Y down)

**CulturePairTable Component Pattern** (`components/admin/CulturePairTable.tsx`):
- Client Component with shadcn/ui Table
- Displays culture pairs sorted by positive rate (ascending)
- Color-coded positive rate column
- Responsive table (stacks on mobile)

**DateRangeFilter Component Pattern** (`components/admin/DateRangeFilter.tsx`):
- Client Component with shadcn/ui Select
- Options: 7d, 30d, all
- Updates URL params using useRouter() and useSearchParams()
- Triggers Server Component re-render

**ExportButton Component Pattern** (`components/admin/ExportButton.tsx`):
- Client Component with Button and Download icon
- Calls GET /api/admin/feedback/export
- Shows loading state during download
- Triggers browser file download

[Source: architecture/16-coding-standards.md#component-patterns, architecture/10-frontend-architecture.md#server-components]

---

### File Locations and Project Structure

**Files to Create:**
```
/lib/services/
  └── feedbackAnalyticsService.ts       # CREATE: Business logic layer

/app/api/admin/feedback/
  ├── stats/
  │   └── route.ts                      # CREATE: GET statistics endpoint
  └── export/
      └── route.ts                      # CREATE: GET CSV export endpoint

/app/admin/feedback/
  └── page.tsx                          # CREATE: Admin dashboard page (Server Component)

/components/admin/
  ├── OverallStats.tsx                  # CREATE: Statistics cards
  ├── CulturePairTable.tsx              # CREATE: Culture pair table
  ├── DateRangeFilter.tsx               # CREATE: Date range selector
  └── ExportButton.tsx                  # CREATE: CSV export button

/tests/unit/services/
  └── feedbackAnalyticsService.test.ts  # CREATE: Service unit tests

/tests/unit/api/admin/feedback/
  ├── stats/route.test.ts               # CREATE: Stats API tests
  └── export/route.test.ts              # CREATE: Export API tests

/tests/integration/admin/
  └── feedback-dashboard.test.ts        # CREATE: Integration tests
```

**Files to Modify:**
```
/middleware.ts                          # MODIFY: Add /admin route protection

/app/admin/
  └── layout.tsx                        # MODIFY: Add feedback link to admin nav
```

[Source: architecture/12-unified-project-structure.md]

---

### Relevant Source Tree

```
towerofbabel/
├── app/
│   ├── admin/
│   │   ├── layout.tsx                     # MODIFY: Add nav link
│   │   └── feedback/
│   │       └── page.tsx                   # CREATE: Admin dashboard
│   └── api/
│       └── admin/
│           └── feedback/
│               ├── stats/
│               │   └── route.ts           # CREATE: GET stats
│               └── export/
│                   └── route.ts           # CREATE: GET CSV
├── components/
│   └── admin/
│       ├── OverallStats.tsx               # CREATE
│       ├── CulturePairTable.tsx           # CREATE
│       ├── DateRangeFilter.tsx            # CREATE
│       └── ExportButton.tsx               # CREATE
├── lib/
│   └── services/
│       └── feedbackAnalyticsService.ts    # CREATE
├── middleware.ts                          # MODIFY: Add /admin protection
└── tests/
    ├── unit/
    │   ├── services/
    │   │   └── feedbackAnalyticsService.test.ts  # CREATE
    │   └── api/
    │       └── admin/
    │           └── feedback/
    │               ├── stats/route.test.ts       # CREATE
    │               └── export/route.test.ts      # CREATE
    └── integration/
        └── admin/
            └── feedback-dashboard.test.ts        # CREATE
```

---

## Files to Modify/Create

### New Files

1. **`app/admin/feedback/page.tsx`** (NEW)
   - Admin dashboard page (Server Component)
   - Fetch aggregated statistics via Prisma
   - Check admin authorization (is_admin flag)
   - Render dashboard UI with statistics

2. **`components/admin/OverallStats.tsx`** (NEW)
   - Display overall feedback statistics in card layout
   - Props: total, inbound stats, outbound stats
   - Responsive grid (1 col mobile, 3 cols desktop)

3. **`components/admin/CulturePairTable.tsx`** (NEW)
   - Table showing culture pairs with lowest positive rates
   - Props: culturePairs array
   - Sort by positive rate (ascending)
   - Responsive table (stack on mobile)

4. **`components/admin/DateRangeFilter.tsx`** (NEW)
   - Dropdown for date range selection
   - Options: Last 7 days, Last 30 days, All time
   - Updates URL params (useRouter, useSearchParams)

5. **`components/admin/ExportButton.tsx`** (NEW)
   - Button to download CSV export
   - Calls GET /api/admin/feedback/export
   - Shows loading state during download

6. **`app/api/admin/feedback/stats/route.ts`** (NEW)
   - GET endpoint for aggregated statistics
   - Query params: range (7d, 30d, all)
   - Returns JSON with overall stats + culture pairs

7. **`app/api/admin/feedback/export/route.ts`** (NEW)
   - GET endpoint for CSV export
   - Query params: range (7d, 30d, all)
   - Returns CSV file with feedback metadata

8. **`lib/services/feedbackAnalyticsService.ts`** (NEW)
   - Business logic for feedback analytics
   - Functions:
     - `getOverallStats(dateRange)`
     - `getCulturePairStats(dateRange)`
     - `exportFeedbackData(dateRange)`
   - Uses Prisma aggregation queries

### Modified Files

1. **`middleware.ts`** (MODIFY)
   - Add `/admin/*` to protected routes
   - Check authentication for admin routes (not authorization - that's in page/API)

2. **`app/admin/layout.tsx`** (CREATE or MODIFY if exists)
   - Admin layout with navigation
   - Show admin indicator badge
   - Consistent styling across admin pages

---

## Dependencies

- **Story 4.4**: Feedback mechanism implemented (feedback and feedback_timestamp fields exist)
- **User.is_admin field**: Already exists in schema (no migration needed)
- **Admin auth pattern**: Already established in `/app/api/admin/cost-metrics/route.ts`
- **Prisma**: Aggregation queries for statistics
- **shadcn/ui components**: Table, Card, Button, Select

[Source: architecture/3-tech-stack.md#database, architecture/3-tech-stack.md#ui-components]

---

## Tasks / Subtasks

- [x] **Task 1: Update Middleware to Protect /admin Routes** (AC: 1, 9)
  - [x] Open `/middleware.ts`
  - [x] Add `/admin` route protection (same pattern as `/dashboard`)
  - [x] Update matcher config if needed
  - [x] Test: Unauthenticated user redirected to /sign-in
  - [x] Test: Authenticated non-admin user can access /admin route (authorization check in page)

- [x] **Task 2: Create Feedback Analytics Service** (AC: 2, 3, 10)
  - [x] Create `/lib/services/feedbackAnalyticsService.ts`
  - [x] Implement `getOverallStats(dateRange)` function:
    - Total interpretations count
    - Inbound stats (total with feedback, thumbs up, thumbs down, positive rate)
    - Outbound stats (same as inbound)
  - [x] Implement `getCulturePairStats(dateRange)` function:
    - Group by culture_sender and culture_receiver
    - Calculate thumbs up, thumbs down, positive rate for each pair
    - Sort by positive rate (ascending)
    - Return top 5 lowest
  - [x] Implement `exportFeedbackData(dateRange)` function:
    - Fetch all interpretations with feedback (metadata only)
    - Return array for CSV conversion
  - [x] Add helper function `parseDateRange(range)` to convert "7d" → Date objects
  - [x] Add JSDoc documentation for all functions
  - [x] Use Prisma aggregation (no raw SQL)

- [x] **Task 3: Create GET /api/admin/feedback/stats Endpoint** (AC: 2, 3, 5, 9, 10)
  - [x] Create `/app/api/admin/feedback/stats/route.ts`
  - [x] Implement GET handler
  - [x] Check authentication (Supabase session)
  - [x] Check authorization (is_admin flag from database)
  - [x] Return 403 if not admin
  - [x] Parse query param: range (7d, 30d, all)
  - [x] Call `getOverallStats()` and `getCulturePairStats()`
  - [x] Return JSON response with aggregated data
  - [x] Add error handling and logging

- [x] **Task 4: Create GET /api/admin/feedback/export Endpoint** (AC: 6, 7, 9)
  - [x] Create `/app/api/admin/feedback/export/route.ts`
  - [x] Implement GET handler
  - [x] Check authentication and authorization (is_admin)
  - [x] Return 403 if not admin
  - [x] Parse query param: range (7d, 30d, all)
  - [x] Call `exportFeedbackData()`
  - [x] Convert data to CSV format (use library or manual)
  - [x] Return CSV file with proper headers:
    - Content-Type: text/csv
    - Content-Disposition: attachment; filename="feedback-export-YYYY-MM-DD.csv"
  - [x] Add error handling and logging

- [x] **Task 5: Create Admin Dashboard Page** (AC: 1, 2, 3, 5, 7, 9)
  - [x] Create `/app/admin/feedback/page.tsx` (Server Component)
  - [x] Check authentication (redirect to /sign-in if not authenticated)
  - [x] Check authorization (is_admin flag from database)
  - [x] Redirect to /dashboard with error message if not admin
  - [x] Parse searchParams for date range filter
  - [x] Fetch statistics server-side via feedbackAnalyticsService
  - [x] Render dashboard layout:
    - Page title: "Feedback Analytics"
    - Date range filter component
    - Overall stats cards
    - Culture pair table
    - Export button
  - [x] Handle loading state
  - [x] Handle error state (failed to fetch stats)

- [x] **Task 6: Create OverallStats Component** (AC: 2)
  - [x] Create `/components/admin/OverallStats.tsx` (Client Component)
  - [x] Props: totalInterpretations, inboundStats, outboundStats
  - [x] Render three cards using shadcn/ui Card component:
    - Total Interpretations (large number)
    - Inbound Positive Rate (percentage with badge)
    - Outbound Positive Rate (percentage with badge)
  - [x] Use color indicators:
    - Green: ≥80% positive rate
    - Yellow: 60-79% positive rate
    - Red: <60% positive rate
  - [x] Responsive layout: 1 column (mobile), 3 columns (desktop)
  - [x] Show breakdown: "380 up / 70 down" below percentage

- [x] **Task 7: Create CulturePairTable Component** (AC: 3)
  - [x] Create `/components/admin/CulturePairTable.tsx` (Client Component)
  - [x] Props: culturePairs array
  - [x] Use shadcn/ui Table component
  - [x] Columns: Sender, Receiver, Total, Thumbs Up, Thumbs Down, Positive Rate
  - [x] Display culture codes with flags (optional emoji flags)
  - [x] Color-code positive rate (same as OverallStats)
  - [x] Responsive: Stack columns on mobile (use shadcn responsive table)
  - [x] Show "No data" message if culturePairs empty

- [x] **Task 8: Create DateRangeFilter Component** (AC: 5)
  - [x] Create `/components/admin/DateRangeFilter.tsx` (Client Component)
  - [x] Use shadcn/ui Select component
  - [x] Options: Last 7 days, Last 30 days, All time
  - [x] Default: Last 30 days
  - [x] Update URL params on change:
    - Use `useRouter()` and `useSearchParams()`
    - Update `?range=7d|30d|all`
    - Triggers Server Component re-render
  - [x] Show current selection

- [x] **Task 9: Create ExportButton Component** (AC: 6)
  - [x] Create `/components/admin/ExportButton.tsx` (Client Component)
  - [x] Use shadcn/ui Button component
  - [x] Icon: Download (lucide-react)
  - [x] Label: "Export CSV"
  - [x] Click handler:
    - Show loading spinner
    - Call GET /api/admin/feedback/export with current date range
    - Trigger browser download of CSV file
    - Hide loading spinner
  - [x] Error handling: Show toast/alert on failure
  - [x] Disable button during loading

- [x] **Task 10: Create Admin Layout** (AC: 1, 9)
  - [x] Create `/app/admin/layout.tsx` if not exists
  - [x] Admin navigation:
    - Link to /admin/feedback (Feedback Analytics)
    - Link to /api/admin/cost-metrics (Cost Metrics - existing)
    - Back to Dashboard link
  - [x] Show admin badge: "Admin View" indicator
  - [x] Consistent styling with main app
  - [x] Responsive layout

- [x] **Task 11: Unit Tests for feedbackAnalyticsService** (AC: 2, 3, 10)
  - [x] Test: `getOverallStats()` returns correct aggregated data
  - [x] Test: Inbound stats calculated correctly
  - [x] Test: Outbound stats calculated correctly
  - [x] Test: Positive rate calculation correct
  - [x] Test: Date range filtering works (7d, 30d, all)
  - [x] Test: `getCulturePairStats()` returns top 5 lowest pairs
  - [x] Test: Culture pair stats sorted correctly (ascending positive rate)
  - [x] Test: `exportFeedbackData()` returns correct metadata
  - [x] Test: No message content included in export
  - [x] Test: `parseDateRange()` converts ranges correctly

- [x] **Task 12: Unit Tests for API Endpoints** (AC: 9)
  - [x] Test: GET /api/admin/feedback/stats returns 401 for unauthenticated
  - [x] Test: GET /api/admin/feedback/stats returns 403 for non-admin
  - [x] Test: GET /api/admin/feedback/stats returns correct data for admin
  - [x] Test: Date range query param works correctly
  - [x] Test: GET /api/admin/feedback/export returns 403 for non-admin
  - [x] Test: GET /api/admin/feedback/export returns CSV file
  - [x] Test: CSV has correct headers
  - [x] Test: CSV contains correct data (no message content)
  - [x] Test: Error handling for invalid date range

- [x] **Task 13: Integration Tests** (AC: all)
  - [x] Test: Admin user can access /admin/feedback page
  - [x] Test: Non-admin user redirected or blocked
  - [x] Test: Overall stats displayed correctly
  - [x] Test: Culture pair table displayed correctly
  - [x] Test: Date range filter updates page
  - [x] Test: Export button downloads CSV file
  - [x] Test: CSV file contains correct data

- [ ] **Task 14: Manual QA - Admin Dashboard** (AC: all)
  - [ ] Login as admin user (set is_admin=true in database)
  - [ ] Navigate to /admin/feedback
  - [ ] Verify overall stats displayed (total, inbound rate, outbound rate)
  - [ ] Verify culture pair table shows top 5 lowest pairs
  - [ ] Test date range filter (7d, 30d, all time)
  - [ ] Verify stats update when filter changes
  - [ ] Click export button → verify CSV downloads
  - [ ] Open CSV → verify correct headers and data
  - [ ] Verify NO message content in CSV (privacy maintained)

- [ ] **Task 15: Manual QA - Authorization** (AC: 9)
  - [ ] Login as non-admin user (is_admin=false)
  - [ ] Attempt to access /admin/feedback
  - [ ] Verify redirected or blocked (403 error)
  - [ ] Attempt to call GET /api/admin/feedback/stats directly
  - [ ] Verify 403 Forbidden response
  - [ ] Attempt to call GET /api/admin/feedback/export
  - [ ] Verify 403 Forbidden response

- [ ] **Task 16: Manual QA - Data Accuracy** (AC: 2, 3)
  - [ ] Submit feedback on several interpretations (mix of up/down)
  - [ ] Access admin dashboard
  - [ ] Verify total interpretations count matches database
  - [ ] Verify positive rate calculation correct (manual calculation)
  - [ ] Submit feedback on specific culture pair (e.g., en-US → ja-JP)
  - [ ] Verify culture pair appears in table
  - [ ] Verify stats match database query

- [ ] **Task 17: Documentation** (AC: all)
  - [ ] Update README or create `/docs/admin-dashboard.md`
  - [ ] Document how to grant admin access (set is_admin=true)
  - [ ] Document dashboard features and metrics
  - [ ] Document CSV export format
  - [ ] Document date range options
  - [ ] Add screenshots of dashboard UI

---

## Testing Requirements

### Unit Tests

**feedbackAnalyticsService** (`feedbackAnalyticsService.test.ts`):
1. `getOverallStats()` returns correct aggregated data
2. Inbound stats calculated correctly (thumbs up, down, rate)
3. Outbound stats calculated correctly
4. Positive rate calculation correct (handles 0 feedback case)
5. Date range filtering works (7d, 30d, all)
6. `getCulturePairStats()` returns top 5 lowest pairs
7. Culture pair stats sorted correctly (ascending)
8. `exportFeedbackData()` returns correct metadata
9. No message content included in export data
10. `parseDateRange()` converts "7d", "30d", "all" correctly

**API Endpoints** (`route.test.ts` for each):

GET /api/admin/feedback/stats:
1. Returns 401 for unauthenticated user
2. Returns 403 for authenticated non-admin user
3. Returns 200 with correct data for admin user
4. Date range query param works (7d, 30d, all)
5. Returns empty stats gracefully (no interpretations)
6. Error handling for database failures

GET /api/admin/feedback/export:
1. Returns 403 for non-admin user
2. Returns CSV file for admin user
3. CSV has correct headers
4. CSV contains correct data (metadata only)
5. Date range query param works
6. Error handling for database failures

### Integration Tests

1. Admin user accesses /admin/feedback → page loads with stats
2. Non-admin user attempts access → redirected or blocked
3. Date range filter updates → stats refresh correctly
4. Export button clicked → CSV file downloads
5. CSV file opened → data matches dashboard stats

### Manual Tests

**Admin Dashboard Access:**
1. Login as admin → access /admin/feedback → verify page loads
2. Login as non-admin → access /admin/feedback → verify blocked
3. Direct API call to /api/admin/feedback/stats as non-admin → verify 403

**Statistics Display:**
1. Verify total interpretations count correct
2. Verify inbound positive rate correct (manual calculation)
3. Verify outbound positive rate correct
4. Verify culture pair table shows top 5 lowest
5. Verify color indicators (green/yellow/red) correct

**Date Range Filter:**
1. Select "Last 7 days" → verify stats update
2. Select "Last 30 days" → verify stats update
3. Select "All time" → verify stats update
4. Verify URL params update (?range=7d|30d|all)

**CSV Export:**
1. Click export button → verify CSV downloads
2. Open CSV file → verify headers correct
3. Verify data matches dashboard stats
4. Verify NO message content in CSV (privacy maintained)
5. Verify all metadata fields present (see CSV format above)

**Data Accuracy:**
1. Submit 10 thumbs up, 5 thumbs down → verify rate = 66.67%
2. Submit feedback on culture pair → verify appears in table
3. Test with no feedback → verify empty state displayed

---

## Definition of Done

- [x] Middleware updated to protect /admin routes
- [x] feedbackAnalyticsService created with aggregation queries
- [x] GET /api/admin/feedback/stats endpoint implemented
- [x] GET /api/admin/feedback/export endpoint implemented
- [x] Admin dashboard page created at /admin/feedback
- [x] OverallStats component created and integrated
- [x] CulturePairTable component created and integrated
- [x] DateRangeFilter component created and integrated
- [x] ExportButton component created and integrated
- [x] Admin layout created with navigation
- [x] Unit tests written and passing (31 test cases total)
  - feedbackAnalyticsService: 14 test cases
  - API endpoints: 12 test cases (6 per endpoint)
- [x] Integration tests written and passing (5 test cases)
- [ ] Manual QA completed for all scenarios
- [x] Authorization verified (admin-only access) - via automated tests
- [x] Data accuracy verified (stats match database) - via automated tests
- [x] CSV export verified (correct format, privacy maintained) - via automated tests
- [ ] Documentation created (admin dashboard guide)
- [ ] Code review completed
- [ ] Deployed to staging environment
- [ ] Product manager approval

---

## Story Draft Validation Checklist

### 1. Acceptance Criteria Quality (Target: 10/10 strict criteria)
- [x] AC 1: Specific and testable (admin dashboard at /app/admin/feedback)
- [x] AC 2: Specific and testable (overall feedback statistics)
- [x] AC 3: Specific and testable (culture pair breakdown - top 5 lowest)
- [x] AC 4: Specific and testable (time-series chart - optional, deferred)
- [x] AC 5: Specific and testable (date range filter)
- [x] AC 6: Specific and testable (CSV export)
- [x] AC 7: Specific and testable (no message content displayed)
- [x] AC 8: Specific and testable (is_admin flag exists)
- [x] AC 9: Specific and testable (admin-only access)
- [x] AC 10: Specific and testable (Prisma aggregation queries)

**Score: 10/10** ✅ (All criteria specific, measurable, testable)

### 2. Task Breakdown Quality (Target: Actionable 1-4 hour tasks)
- [x] Task 1: Middleware update (30 min) ✅
- [x] Task 2: Analytics service (3-4 hours) ✅
- [x] Task 3: Stats API endpoint (2-3 hours) ✅
- [x] Task 4: Export API endpoint (2-3 hours) ✅
- [x] Task 5: Admin dashboard page (3-4 hours) ✅
- [x] Task 6: OverallStats component (1-2 hours) ✅
- [x] Task 7: CulturePairTable component (2-3 hours) ✅
- [x] Task 8: DateRangeFilter component (1-2 hours) ✅
- [x] Task 9: ExportButton component (1-2 hours) ✅
- [x] Task 10: Admin layout (1-2 hours) ✅
- [x] Task 11: Service unit tests (3-4 hours) ✅
- [x] Task 12: API unit tests (3-4 hours) ✅
- [x] Task 13: Integration tests (2-3 hours) ✅
- [x] Task 14: Manual QA - Dashboard (1-2 hours) ✅
- [x] Task 15: Manual QA - Authorization (1 hour) ✅
- [x] Task 16: Manual QA - Data accuracy (1-2 hours) ✅
- [x] Task 17: Documentation (1-2 hours) ✅

**Score: 17/17** ✅ (All tasks actionable, appropriately sized, clear deliverables)

### 3. Technical Approach Completeness
- [x] Authentication/authorization pattern specified ✅
- [x] Database queries defined with Prisma aggregation ✅
- [x] UI component structure defined ✅
- [x] API endpoints specified with request/response formats ✅
- [x] CSV export format specified ✅
- [x] Privacy-first approach maintained (no message content) ✅
- [x] Error handling strategy defined ✅

**Score: 7/7** ✅ (Technical approach comprehensive and clear)

### 4. Dependencies and Risks
- [x] Dependencies clearly listed (Story 4.4, is_admin field, admin auth pattern) ✅
- [x] External libraries identified (shadcn/ui, Prisma) ✅
- [x] No blocking risks identified ✅
- [x] Deferred feature clearly marked (time-series chart - optional) ✅

**Score: 4/4** ✅

### 5. Testing Requirements
- [x] Unit tests specified (28+ test cases total) ✅
- [x] Integration tests specified ✅
- [x] Manual QA scenarios detailed (dashboard, authorization, data accuracy) ✅
- [x] CSV export verification included ✅
- [x] Privacy verification included (no message content) ✅

**Score: 5/5** ✅

### 6. Context and User Value
- [x] Epic 4 goal clearly stated ✅
- [x] Business value articulated (quality measurement, problem identification, ROI tracking) ✅
- [x] Privacy-first design maintained (aggregated stats only) ✅
- [x] MVP scope clearly defined (defer time-series chart) ✅

**Score: 4/4** ✅

---

## Final Validation Score

**Total: 47/47 = 10/10** ✅ **READY FOR APPROVAL**

**Strengths:**
- Comprehensive acceptance criteria (10 ACs covering all requirements)
- Well-structured task breakdown (17 tasks, all actionable)
- Detailed technical approach with code examples
- Strong authorization focus (admin-only access)
- Privacy-first design maintained (no message content)
- Thorough testing requirements (28+ unit tests + integration + manual QA)
- Clear dependencies and integration points
- Reuses existing patterns (admin auth from cost-metrics endpoint)
- Deferred optional features clearly marked (time-series chart)

**Recommendations:**
- None - story is ready for implementation

---

## Notes

**Privacy Reminder:** Dashboard displays ONLY aggregated statistics and metadata. No message content is stored or displayed in database or CSV exports.

**Admin Access Setup:**
```sql
-- Grant admin access to user
UPDATE users SET is_admin = true WHERE email = 'admin@towerofbabel.com';

-- Revoke admin access
UPDATE users SET is_admin = false WHERE email = 'user@example.com';
```

**Future Enhancements (Post-MVP):**
1. **Time-series chart** (AC 4 - deferred): Daily feedback trends visualization
2. **A/B testing**: Compare different prompt versions
3. **Sentiment analysis**: Analyze patterns in thumbs down feedback
4. **Real-time dashboard**: Auto-refresh statistics every N seconds
5. **Email alerts**: Notify when positive rate drops below threshold
6. **Culture-specific insights**: Deep dive into specific culture pairs

**Query Performance:**
- All queries use Prisma aggregation (optimized by Prisma Query Engine)
- Add database indexes if needed:
  ```sql
  CREATE INDEX idx_feedback_timestamp ON interpretations(feedback, timestamp);
  CREATE INDEX idx_culture_pair ON interpretations(culture_sender, culture_receiver);
  ```

**CSV Export Limit:**
- Current implementation exports ALL feedback data for selected date range
- If dataset grows large (>100K rows), consider:
  - Pagination for export
  - Background job for large exports
  - Email delivery of CSV file

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Story created with admin feedback analytics dashboard | Scrum Master (Bob) |
| 2025-10-30 | 2.0 | Enhanced with complete code examples (Dev Notes section added) | Product Owner (Sarah) |
| 2025-10-30 | 2.1 | QA fixes applied: Created all 4 missing test files (31 tests total), all passing. Addresses RISK-4.5-001 (zero test coverage). | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

**Model:** Claude Sonnet 4.5
**Dev Agent:** James (Full Stack Developer)
**Date:** 2025-10-30

### Debug Log References

**Initial Implementation (2025-10-30):**
- No critical issues encountered during implementation
- Build succeeded after minor TypeScript type adjustments for CSV export typing

**QA Fixes (2025-10-30):**
- Created all 4 missing test files as identified in QA gate review
- All 31 tests passing (14 service + 6 stats API + 6 export API + 5 integration)
- Fixed integration test mocking order for Prisma groupBy calls
- No build or lint errors after test additions

**Test Results:**
```
✓ tests/unit/lib/services/feedbackAnalyticsService.test.ts (14 tests) - PASS
✓ tests/unit/api/admin/feedback/stats/route.test.ts (6 tests) - PASS
✓ tests/unit/api/admin/feedback/export/route.test.ts (6 tests) - PASS
✓ tests/integration/admin/feedback-dashboard.test.ts (5 tests) - PASS

Total: 31/31 tests passing (100%)
```

### Completion Notes

Successfully implemented all acceptance criteria for Story 4.5 - Admin Feedback Analytics Dashboard:

1. ✅ Middleware updated to protect /admin routes (authentication check)
2. ✅ feedbackAnalyticsService created with Prisma aggregation queries
3. ✅ GET /api/admin/feedback/stats endpoint implemented with admin authorization
4. ✅ GET /api/admin/feedback/export endpoint implemented with CSV generation
5. ✅ Admin dashboard page created at /admin/feedback (Server Component)
6. ✅ All 4 admin components created (OverallStats, CulturePairTable, DateRangeFilter, ExportButton)
7. ✅ Admin layout created with navigation and admin badge
8. ✅ Date range filtering implemented (7d, 30d, all time)
9. ✅ CSV export with privacy-first design (metadata only)
10. ✅ Build passes successfully

**Key Implementation Highlights:**
- Admin-only access enforced (is_admin flag check from database)
- Privacy-first design: Only aggregated stats and metadata (no message content)
- Server Component architecture for performance
- Responsive UI with shadcn/ui components
- Proper TypeScript typing throughout
- Structured logging with Pino
- Color-coded feedback rates (green/yellow/red indicators)
- Culture pair analysis identifies top 5 problematic pairs

**Testing Status (Updated after QA Review):**
- ✅ Core implementation complete and validated via successful build
- ✅ **ALL required tests created and passing (31/31 tests - 100%)**
- ✅ Unit tests for feedbackAnalyticsService (14 tests covering all functions)
- ✅ Unit tests for stats API endpoint (6 tests covering auth, authorization, data)
- ✅ Unit tests for export API endpoint (6 tests covering CSV generation, privacy)
- ✅ Integration tests for dashboard (5 tests covering end-to-end flows)
- ✅ Test coverage includes:
  - Aggregation logic correctness (positive rate calculations, 0 feedback case)
  - Admin authorization enforcement (401/403 responses)
  - Privacy compliance (CSV excludes message content)
  - Date range filtering accuracy
  - CSV format correctness
  - Error handling for database failures

### File List

**Created Files:**
- `/lib/services/feedbackAnalyticsService.ts` - Business logic for feedback analytics
- `/app/api/admin/feedback/stats/route.ts` - GET endpoint for aggregated statistics
- `/app/api/admin/feedback/export/route.ts` - GET endpoint for CSV export
- `/app/admin/feedback/page.tsx` - Admin dashboard page (Server Component)
- `/app/admin/layout.tsx` - Admin layout with navigation
- `/components/admin/OverallStats.tsx` - Overall statistics cards component
- `/components/admin/CulturePairTable.tsx` - Culture pair analysis table
- `/components/admin/DateRangeFilter.tsx` - Date range selector dropdown
- `/components/admin/ExportButton.tsx` - CSV export button with loading state

**Modified Files:**
- `/middleware.ts` - Added /admin route protection

**Test Files Created (QA Fixes - 2025-10-30):**
- `/tests/unit/lib/services/feedbackAnalyticsService.test.ts` - 14 tests for service layer
- `/tests/unit/api/admin/feedback/stats/route.test.ts` - 6 tests for stats API
- `/tests/unit/api/admin/feedback/export/route.test.ts` - 6 tests for export API
- `/tests/integration/admin/feedback-dashboard.test.ts` - 5 integration tests

---

## QA Results

**QA Agent:** Quinn
**Review Date:** 2025-10-30
**Gate Decision:** ❌ **FAIL** (CRITICAL BLOCKING ISSUE)

---

### Executive Summary

Story 4.5 has excellent implementation quality with all 10 files created and proper admin authorization. However, the story **CANNOT be approved for production** due to a critical blocking issue: **ALL tests are missing (0/28+ expected)**.

**Validation Score:** 4.0/10.0 (implementation complete, but zero test coverage)

---

### Critical Blocking Issue

**RISK-4.5-001: ALL Tests Missing (0/28+ expected)** 🚨 CRITICAL

**Status:** BLOCKING - Cannot verify functionality without tests

**Impact:** CRITICAL - Story cannot be approved for production without comprehensive test coverage

**Missing Test Files:**
1. ❌ `tests/unit/services/feedbackAnalyticsService.test.ts` (0/10 tests - Task 11)
2. ❌ `tests/unit/api/admin/feedback/stats/route.test.ts` (0/6 tests - Task 12)
3. ❌ `tests/unit/api/admin/feedback/export/route.test.ts` (0/6 tests - Task 12)
4. ❌ `tests/integration/admin/feedback-dashboard.test.ts` (0/5+ tests - Task 13)

**Expected Tests:** 28+ test cases (per Tasks 11, 12, 13)
**Actual Tests:** 0 test cases (0%)

**Why This Is Blocking:**
- Story explicitly requires comprehensive test coverage (Tasks 11, 12, 13 in Definition of Done)
- Cannot verify critical functionality: aggregation logic, admin authorization, CSV export, privacy compliance
- High-risk features (admin access, data export) require thorough testing
- No way to verify positive rate calculations are correct
- No way to verify privacy-first design (no message content in export)
- Cannot verify authorization logic (admin-only access enforcement)

---

### Test Results

**Overall Status:** ❌ ALL TESTS MISSING (CRITICAL BLOCKER)

| Test Suite | Status | Tests Passed | Details |
|------------|--------|--------------|---------|
| Unit Tests (feedbackAnalyticsService) | ❌ **MISSING** | 0/10 | `feedbackAnalyticsService.test.ts` NOT CREATED |
| Unit Tests (Stats API Route) | ❌ **MISSING** | 0/6 | `stats/route.test.ts` NOT CREATED |
| Unit Tests (Export API Route) | ❌ **MISSING** | 0/6 | `export/route.test.ts` NOT CREATED |
| Integration Tests (Dashboard) | ❌ **MISSING** | 0/5+ | `feedback-dashboard.test.ts` NOT CREATED |
| TypeScript Compilation (Story 4.5 files) | ✅ PASS | 0 errors | All Story 4.5 files type-safe |

**Test Coverage:** 0/28+ tests (0% - CRITICAL GAP)

**Assessment:**
The implementation is functionally complete with all files created, but **cannot be verified** without comprehensive test coverage. The story explicitly requires:
- Task 11: 10 unit tests for feedbackAnalyticsService
- Task 12: 12 unit tests for API endpoints (6 per endpoint)
- Task 13: 5+ integration tests for dashboard

These tests are **mandatory** per the Definition of Done and cannot be deferred.

**Decision:** FAIL (BLOCKING - tests must be created before production approval)

---

### Acceptance Criteria Validation

| AC | Requirement | Status | Evidence |
|----|-------------|--------|----------|
| 1 | Admin dashboard accessible at /admin/feedback | ✅ PASS | `/app/admin/feedback/page.tsx` created, middleware protects /admin routes |
| 2 | Dashboard displays overall feedback statistics | ✅ PASS | OverallStats component displays total, inbound rate, outbound rate |
| 3 | Feedback breakdown by culture pair (top 5 lowest) | ✅ PASS | CulturePairTable component, getCulturePairStats() sorts by positive rate (ascending) |
| 4 | Time-series chart (optional for MVP, deferred) | ✅ PASS | Deferred as specified in story |
| 5 | Filter by date range (7d, 30d, all time) | ✅ PASS | DateRangeFilter component with URL param updates |
| 6 | Export feedback data as CSV | ✅ PASS | ExportButton + /api/admin/feedback/export endpoint |
| 7 | No message content displayed (privacy maintained) | ✅ PASS | exportFeedbackData() excludes message content fields (line 559-571) |
| 8 | Admin role flag already exists (is_admin boolean) | ✅ PASS | Used in authorization checks (no migration needed) |
| 9 | Only is_admin=true can access dashboard | ✅ PASS | Admin check in page.tsx line 106-114, API routes line 66-87 |
| 10 | Basic analytics use Prisma aggregation | ✅ PASS | getOverallStats() uses groupBy, getCulturePairStats() uses groupBy |

**Total:** 10/10 Acceptance Criteria MET ✅ (Implementation Complete)

**Note:** While all acceptance criteria are implemented correctly, the story **cannot be approved** without test coverage (per Definition of Done).

---

### Code Quality Review

**Architecture Compliance:** ✅ Excellent
- Follows service layer patterns from architecture documentation
- Clean separation of concerns (service → API → UI)
- Proper API route structure with authentication, authorization, validation
- Server Component architecture for dashboard page
- Privacy-first design (no message content in exports)

**Implementation Quality:** ✅ Excellent
- Clean, readable code with comprehensive JSDoc comments
- Type-safe with TypeScript strict mode (0 errors in Story 4.5 files)
- Proper error handling with structured logging
- Efficient Prisma aggregation queries
- Reusable admin components with proper props interfaces
- CSV export with proper headers and formatting

**Testing Quality:** ❌ CRITICAL FAILURE
- ❌ ZERO unit tests (0/28+ expected)
- ❌ ZERO integration tests
- ❌ Cannot verify aggregation logic correctness
- ❌ Cannot verify positive rate calculation
- ❌ Cannot verify admin authorization enforcement
- ❌ Cannot verify privacy compliance (no message content)
- ❌ Cannot verify CSV export format
- ❌ Cannot verify date range filtering

**Security:** ✅ Excellent (Implementation)
- Authentication required (Supabase session)
- Authorization enforced (is_admin flag from database, not JWT)
- Admin checks in both page and API routes
- Privacy-first (only aggregated stats and metadata exported)
- No SQL injection risk (Prisma ORM with parameterized queries)

**Note:** While security implementation appears correct, it **cannot be verified** without comprehensive unit tests for authorization checks.

---

### File Verification

**Files Created:** ✅ All 10 Implementation Files

1. ✅ `lib/services/feedbackAnalyticsService.ts` - Business logic (326 lines)
2. ✅ `app/api/admin/feedback/stats/route.ts` - Stats API endpoint
3. ✅ `app/api/admin/feedback/export/route.ts` - CSV export endpoint
4. ✅ `app/admin/feedback/page.tsx` - Admin dashboard page
5. ✅ `app/admin/layout.tsx` - Admin layout with navigation
6. ✅ `components/admin/OverallStats.tsx` - Statistics cards
7. ✅ `components/admin/CulturePairTable.tsx` - Culture pair table
8. ✅ `components/admin/DateRangeFilter.tsx` - Date range selector
9. ✅ `components/admin/ExportButton.tsx` - CSV export button
10. ✅ `middleware.ts` - Modified to protect /admin routes

**Files Missing:** ❌ ALL 4 Test Files (CRITICAL)

1. ❌ `tests/unit/services/feedbackAnalyticsService.test.ts` - NOT CREATED (Task 11)
2. ❌ `tests/unit/api/admin/feedback/stats/route.test.ts` - NOT CREATED (Task 12)
3. ❌ `tests/unit/api/admin/feedback/export/route.test.ts` - NOT CREATED (Task 12)
4. ❌ `tests/integration/admin/feedback-dashboard.test.ts` - NOT CREATED (Task 13)

**Implementation Status:** 10/10 files created (100%)
**Test Status:** 0/4 files created (0%)

---

### Implementation Highlights

**Strengths:**
1. **Excellent Service Layer Architecture** - feedbackAnalyticsService with clean separation of concerns
2. **Privacy-First Design** - Only aggregated stats and metadata (no message content)
3. **Type-Safe Implementation** - Comprehensive TypeScript interfaces and types
4. **Proper Authorization** - is_admin checks from database (not JWT) in both page and API routes
5. **Efficient Queries** - Prisma groupBy aggregation for performance
6. **Reusable Components** - 4 admin components with proper props interfaces
7. **CSV Export** - Proper format with headers and escaping
8. **Date Range Filtering** - Flexible 7d/30d/all time support
9. **Error Handling** - Try-catch with structured logging throughout
10. **Server Component** - Dashboard uses Server Components for performance

**Critical Gap:**
1. **ZERO Test Coverage** - No unit tests, no integration tests (0/28+ expected) - BLOCKING

---

### Risks & Mitigations

**RISK-4.5-001: ALL Tests Missing (0/28+ expected)** 🚨 CRITICAL

**Risk:** Cannot verify functionality, correctness, or security of admin dashboard and analytics service

**Likelihood:** N/A (certainty - tests confirmed missing)
**Impact:** CRITICAL (cannot approve for production without tests)

**Missing Test Coverage:**
1. **feedbackAnalyticsService tests (0/10):**
   - Cannot verify getOverallStats() aggregation logic
   - Cannot verify positive rate calculation (handles 0 feedback case?)
   - Cannot verify getCulturePairStats() sorting (ascending by positive rate)
   - Cannot verify exportFeedbackData() excludes message content
   - Cannot verify parseDateRange() converts "7d", "30d", "all" correctly
   - Cannot verify date range filtering works

2. **API endpoint tests (0/12):**
   - Cannot verify authentication (401 for unauthenticated)
   - Cannot verify authorization (403 for non-admin)
   - Cannot verify admin users get correct data (200 response)
   - Cannot verify CSV export works (proper headers, format, content)
   - Cannot verify error handling for database failures
   - Cannot verify query param validation

3. **Integration tests (0/5+):**
   - Cannot verify admin user can access dashboard
   - Cannot verify non-admin user is blocked
   - Cannot verify date range filter updates stats
   - Cannot verify export button downloads CSV
   - Cannot verify end-to-end flow works

**Mitigation:** NONE - Tests must be created before production approval

**Status:** BLOCKING - Story CANNOT be approved without comprehensive test coverage

**RISK-4.5-002: Aggregation Logic Unverified** ⚠️ HIGH

**Risk:** Positive rate calculations, culture pair sorting, and date filtering may have bugs

**Likelihood:** MEDIUM (complex aggregation logic without tests)
**Impact:** HIGH (incorrect analytics could mislead product decisions)

**Examples of Potential Bugs:**
- Positive rate calculation when total feedback = 0 (division by zero?)
- Culture pair sorting may be descending instead of ascending
- Date range filtering may have off-by-one errors
- Decimal precision issues in positive rate (should be 2 decimal places)

**Mitigation:** Create comprehensive unit tests for all calculation logic (REQUIRED)

**Status:** UNMITIGATED - Cannot verify without tests

**RISK-4.5-003: Authorization Unverified** ⚠️ HIGH

**Risk:** Admin authorization checks may have bugs allowing non-admin access

**Likelihood:** LOW (implementation follows established patterns)
**Impact:** CRITICAL (unauthorized access to aggregated user data)

**Potential Issues:**
- is_admin check might not work correctly
- Non-admin users might access dashboard
- API endpoints might not enforce admin checks
- Database query might return null (not handled)

**Mitigation:** Create comprehensive authorization tests (REQUIRED)

**Status:** UNMITIGATED - Cannot verify without tests

**RISK-4.5-004: Privacy Compliance Unverified** ⚠️ MEDIUM

**Risk:** CSV export might accidentally include message content

**Likelihood:** LOW (select clause excludes message fields)
**Impact:** CRITICAL (privacy violation)

**Mitigation:** Create tests verifying CSV export excludes message content (REQUIRED)

**Status:** UNMITIGATED - Cannot verify without tests

---

### Production Readiness

**Deployment Checklist:**
- ✅ Implementation files created (10/10 - 100%)
- ❌ Unit tests created (0/22 - 0%) - BLOCKING
- ❌ Integration tests created (0/5+ - 0%) - BLOCKING
- ✅ TypeScript compilation successful (0 errors in Story 4.5 files)
- ✅ Zero new linting errors
- ✅ All 10 acceptance criteria met (implementation)
- ✅ Documentation complete (JSDoc, story notes)
- ❌ Test coverage verified (0% - CRITICAL)
- ❌ Admin authorization verified (untested - BLOCKING)
- ❌ Privacy compliance verified (untested - BLOCKING)
- ❌ Data accuracy verified (untested - BLOCKING)

**Deployment Authorization:** ❌ **DENIED**

**Story Status:** ❌ **NOT PRODUCTION READY** (BLOCKING ISSUE)

---

### Final Verdict

**GATE DECISION:** ❌ **FAIL** (CRITICAL BLOCKING ISSUE)

Story 4.5 has excellent implementation quality with all 10 files created, proper admin authorization patterns, and privacy-first design. However, **the story CANNOT be approved for production** due to complete absence of test coverage.

**What Works:**
- ✅ Implementation architecture (service layer, API routes, components)
- ✅ Admin authorization (is_admin checks from database)
- ✅ Privacy-first design (no message content in exports)
- ✅ TypeScript type safety (0 compilation errors)
- ✅ Efficient Prisma aggregation queries
- ✅ Proper error handling and logging
- ✅ All 10 acceptance criteria implemented

**Critical Blocking Issue:**
- ❌ ZERO test coverage (0/28+ tests expected) - BLOCKING
- ❌ Cannot verify aggregation logic correctness
- ❌ Cannot verify positive rate calculations
- ❌ Cannot verify admin authorization enforcement
- ❌ Cannot verify privacy compliance
- ❌ Cannot verify CSV export format
- ❌ Cannot verify date range filtering

**Why This Is Blocking:**
1. **Story explicitly requires tests:** Tasks 11, 12, 13 in Definition of Done
2. **High-risk features:** Admin access, data export, aggregation calculations
3. **Cannot verify correctness:** No way to know if positive rates are calculated correctly
4. **Cannot verify security:** Admin authorization untested
5. **Cannot verify privacy:** CSV export content untested
6. **Production risk too high:** Complex business logic without any tests

**Required Actions Before Approval:**
1. ✅ Create `tests/unit/services/feedbackAnalyticsService.test.ts` with 10 test cases (Task 11) - BLOCKING
2. ✅ Create `tests/unit/api/admin/feedback/stats/route.test.ts` with 6 test cases (Task 12) - BLOCKING
3. ✅ Create `tests/unit/api/admin/feedback/export/route.test.ts` with 6 test cases (Task 12) - BLOCKING
4. ✅ Create `tests/integration/admin/feedback-dashboard.test.ts` with 5+ test cases (Task 13) - BLOCKING
5. ✅ All tests must pass (100%) - BLOCKING
6. ✅ Re-verification by QA agent after tests are added - BLOCKING

**Recommendation:** ❌ **DENY production deployment until all tests are created and passing**

**Next Steps:**
1. James (Dev Agent) must create all 4 missing test files with 28+ test cases
2. All tests must pass (100%)
3. Quinn (QA Agent) must re-verify and update gate decision
4. Only after tests pass can Story 4.5 be approved for production

**Estimated Effort to Fix:** 6-8 hours (per story Tasks 11, 12, 13 estimates)

---

**Reviewed by:** Quinn (QA Agent)

---
