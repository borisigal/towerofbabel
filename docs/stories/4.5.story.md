# Story 4.5: Create Feedback Analytics Dashboard (Admin View)

<!-- Powered by BMADâ„¢ Core -->

## Status

**Approved**

**PO Validation Date:** 2025-10-30
**Validation Score:** 10/10 (Excellent - Enhanced with complete code examples)

---

## Story

**As a** product manager,
**I want** to view feedback analytics across all interpretations,
**so that** I can identify prompt improvements needed and track quality over time.

---

## Acceptance Criteria

1. Admin dashboard accessible at /app/admin/feedback (protected route, admin users only)
2. Dashboard displays overall feedback statistics:
   - Total interpretations: count
   - Inbound positive feedback rate: X% (thumbs up / total with feedback)
   - Outbound positive feedback rate: X% (thumbs up / total with feedback)
3. Feedback breakdown by culture pair: Top 5 pairs with lowest positive feedback rate
4. Time-series chart showing daily feedback trends (optional for MVP, can defer)
5. Filter by date range (last 7 days, 30 days, all time)
6. Export feedback data as CSV for deeper analysis
7. No message content displayed (privacy maintained)
8. Admin role flag already exists in User model (is_admin boolean)
9. Only users with is_admin=true can access dashboard
10. Basic analytics queries use Prisma aggregation (no external analytics tool needed for MVP)

---

## Context

Epic 4 introduces quality feedback mechanism (Story 4.4) for both inbound and outbound interpretations. This story creates an admin analytics dashboard to visualize feedback trends, identify problem areas, and guide LLM prompt improvements.

**Business Value:**
1. **Quality measurement**: Track overall interpretation quality via user feedback
2. **Problem identification**: Find culture pairs or scenarios with low satisfaction rates
3. **Data-driven optimization**: Prioritize prompt refinements based on real user feedback
4. **ROI tracking**: Demonstrate product improvement over time to stakeholders

**Privacy-first approach:** Dashboard displays ONLY aggregated statistics and metadata. No message content is stored or displayed, maintaining privacy-first architecture.

**MVP scope:** This story focuses on essential analytics for prompt optimization. Advanced features (time-series charts, A/B testing) can be added in future iterations based on PM needs.

---

## Technical Approach

### 1. Authentication & Authorization

**Middleware update** (`middleware.ts`):
- Add `/admin/*` to protected routes (requires authentication)
- Follows same pattern as `/dashboard` routes

**Admin authorization** (API routes and page):
- Check `user.is_admin === true` from database (not JWT)
- Return 403 Forbidden for non-admin users
- Pattern already established in `/app/api/admin/cost-metrics/route.ts`

**Note:** `is_admin` field already exists in User model (no schema migration needed).

[Source: architecture/16-coding-standards.md#api-route-structure, architecture/13-security-model.md#authorization]

### 2. Database Queries

All queries use Prisma aggregation for performance (no need for external analytics tools in MVP).

**Overall Statistics:**
```typescript
// Total interpretations
const totalInterpretations = await prisma.interpretation.count({
  where: { timestamp: { gte: startDate, lte: endDate } }
});

// Inbound feedback stats
const inboundStats = await prisma.interpretation.groupBy({
  by: ['feedback'],
  where: {
    interpretation_type: 'inbound',
    feedback: { not: null },
    timestamp: { gte: startDate, lte: endDate }
  },
  _count: true
});

// Outbound feedback stats (same query, different interpretation_type)
```

**Culture Pair Analysis:**
```typescript
// Group by culture pair, calculate positive rate
const culturePairStats = await prisma.interpretation.groupBy({
  by: ['culture_sender', 'culture_receiver'],
  where: {
    feedback: { not: null },
    timestamp: { gte: startDate, lte: endDate }
  },
  _count: true,
  _sum: {
    // Use CASE statement or post-processing
  }
});

// Sort by positive rate (ascending) to find problematic pairs
// Take top 5 lowest
```

[Source: architecture/5-data-model.md#prisma-aggregation, Epic 4 Story 4.5 AC #2, #3]

**Export Query:**
```typescript
// Fetch all interpretations with feedback (metadata only)
const feedbackData = await prisma.interpretation.findMany({
  where: {
    feedback: { not: null },
    timestamp: { gte: startDate, lte: endDate }
  },
  select: {
    id: true,
    timestamp: true,
    interpretation_type: true,
    culture_sender: true,
    culture_receiver: true,
    feedback: true,
    feedback_timestamp: true,
    character_count: true,
    llm_provider: true,
    response_time_ms: true,
    cost_usd: true,
    // EXCLUDE: No message content fields
  },
  orderBy: { timestamp: 'desc' }
});
```

### 3. UI Component Structure

**Page:** `/app/admin/feedback/page.tsx` (Server Component)
- Fetch aggregated statistics server-side
- Pass data to client components via props
- Handle authentication check (redirect if not admin)

**Components:**

1. **OverallStats.tsx** (Client Component)
   - Display cards: Total interpretations, Inbound rate, Outbound rate
   - Visual: Large metric cards with percentage badges

2. **CulturePairTable.tsx** (Client Component)
   - Table showing Top 5 problematic culture pairs
   - Columns: Sender, Receiver, Total, Thumbs Up, Thumbs Down, Positive Rate
   - Sort by positive rate (ascending)

3. **DateRangeFilter.tsx** (Client Component)
   - Dropdown: Last 7 days | Last 30 days | All time
   - Updates URL params (searchParams)
   - Triggers page re-render (Server Component refetch)

4. **ExportButton.tsx** (Client Component)
   - Calls GET /api/admin/feedback/export
   - Downloads CSV file with feedback metadata

**Optional (defer to v2):**
5. **TimeSeriesChart.tsx** (Client Component)
   - Line chart showing daily feedback trends
   - Uses Chart.js or Recharts library
   - Shows thumbs up/down over time

[Source: architecture/10-frontend-architecture.md#component-structure, architecture/3-tech-stack.md#ui-components]

### 4. CSV Export Format

```csv
interpretation_id,timestamp,type,sender_culture,receiver_culture,feedback,feedback_timestamp,character_count,llm_provider,response_time_ms,cost_usd
abc-123,2025-10-30T14:32:00Z,inbound,en-US,ja-JP,up,2025-10-30T14:35:12Z,450,anthropic,1250,0.0023
def-456,2025-10-30T15:10:00Z,outbound,en-US,de-DE,down,2025-10-30T15:12:45Z,320,anthropic,980,0.0019
...
```

**Privacy note:** CSV contains ONLY metadata, no message content.

[Source: architecture/5-data-model.md#privacy-design, Epic 4 Story 4.4]

### 5. API Endpoints

**GET /api/admin/feedback/stats**
- Returns aggregated statistics for dashboard
- Query params: `?range=7d|30d|all`
- Response:
```json
{
  "success": true,
  "data": {
    "total_interpretations": 1250,
    "inbound": {
      "total_with_feedback": 450,
      "thumbs_up": 380,
      "thumbs_down": 70,
      "positive_rate": 84.44
    },
    "outbound": {
      "total_with_feedback": 320,
      "thumbs_up": 285,
      "thumbs_down": 35,
      "positive_rate": 89.06
    },
    "culture_pairs": [
      {
        "sender": "en-US",
        "receiver": "zh-CN",
        "total": 45,
        "thumbs_up": 30,
        "thumbs_down": 15,
        "positive_rate": 66.67
      },
      // ... top 5 lowest
    ]
  }
}
```

**GET /api/admin/feedback/export**
- Returns CSV file with feedback metadata
- Query params: `?range=7d|30d|all`
- Response: CSV file download

[Source: architecture/16-coding-standards.md#api-route-structure]

---

## Dev Notes

### Story Context

**This story creates the admin analytics dashboard to visualize feedback trends from Story 4.4.**

**Epic 4 Integration Flow:**
- Story 4.1: Mode toggle UI (DONE)
- Story 4.2: Outbound LLM prompt and API logic (DONE)
- Story 4.3: Side-by-side comparison UI (DONE)
- Story 4.4: Thumbs up/down feedback (DONE)
- **Story 4.5 (THIS STORY):** Feedback analytics dashboard (admin view)

**What Story 4.5 Adds:**
- âœ¨ **NEW:** Admin feedback dashboard at /admin/feedback
- âœ¨ **NEW:** feedbackAnalyticsService (business logic layer)
- âœ¨ **NEW:** GET /api/admin/feedback/stats (aggregated statistics)
- âœ¨ **NEW:** GET /api/admin/feedback/export (CSV export)
- âœ¨ **NEW:** 4 admin components (OverallStats, CulturePairTable, DateRangeFilter, ExportButton)
- ðŸ”§ **MODIFIED:** middleware.ts (protect /admin routes)
- ðŸ”§ **MODIFIED:** Admin layout (navigation)

**Key Design Decisions:**
- Admin-only access (is_admin flag check)
- Server Component for dashboard page (SEO, performance)
- Prisma aggregation for analytics (no external tools needed)
- Privacy-first (only aggregated stats, no message content)
- CSV export for deeper analysis
- Date range filtering (7d, 30d, all time)

[Source: Epic 4 Story 4.5 context]

---

### Technical Implementation Details

#### feedbackAnalyticsService (Complete Implementation)

**File: `lib/services/feedbackAnalyticsService.ts`**

```typescript
import { db } from '@/lib/db/client';
import { log } from '@/lib/utils/logger';

/**
 * Date range type for filtering analytics
 */
export type DateRangeType = '7d' | '30d' | 'all';

/**
 * Overall statistics interface
 */
export interface OverallStats {
  total_interpretations: number;
  inbound: {
    total_with_feedback: number;
    thumbs_up: number;
    thumbs_down: number;
    positive_rate: number;
  };
  outbound: {
    total_with_feedback: number;
    thumbs_up: number;
    thumbs_down: number;
    positive_rate: number;
  };
}

/**
 * Culture pair statistics interface
 */
export interface CulturePairStats {
  sender: string;
  receiver: string;
  total: number;
  thumbs_up: number;
  thumbs_down: number;
  positive_rate: number;
}

/**
 * Feedback export data interface
 */
export interface FeedbackExportData {
  interpretation_id: string;
  timestamp: Date;
  type: string;
  sender_culture: string;
  receiver_culture: string;
  feedback: string;
  feedback_timestamp: Date;
  character_count: number;
  llm_provider: string;
  response_time_ms: number;
  cost_usd: number;
}

/**
 * Parses date range string to start date
 * @param range - Date range type ('7d', '30d', 'all')
 * @returns Start date for filtering
 */
export function parseDateRange(range: DateRangeType): Date {
  const now = new Date();

  switch (range) {
    case '7d':
      return new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    case '30d':
      return new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    case 'all':
      return new Date(0); // Unix epoch (1970-01-01)
    default:
      return new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); // Default to 30 days
  }
}

/**
 * Calculates positive feedback rate
 * @param thumbsUp - Number of thumbs up
 * @param thumbsDown - Number of thumbs down
 * @returns Positive rate percentage (0-100)
 */
function calculatePositiveRate(thumbsUp: number, thumbsDown: number): number {
  const total = thumbsUp + thumbsDown;
  if (total === 0) return 0;
  return Math.round((thumbsUp / total) * 10000) / 100; // 2 decimal places
}

/**
 * Gets overall feedback statistics
 *
 * Aggregates feedback data across all interpretations, grouped by
 * interpretation type (inbound/outbound).
 *
 * @param dateRange - Date range filter ('7d', '30d', 'all')
 * @returns Overall statistics object
 */
export async function getOverallStats(dateRange: DateRangeType): Promise<OverallStats> {
  const startDate = parseDateRange(dateRange);

  try {
    log.info('Fetching overall feedback stats', { dateRange, startDate });

    // Total interpretations in date range
    const totalInterpretations = await db.interpretation.count({
      where: {
        timestamp: { gte: startDate },
      },
    });

    // Inbound feedback aggregation
    const inboundFeedback = await db.interpretation.groupBy({
      by: ['feedback'],
      where: {
        interpretation_type: 'inbound',
        feedback: { not: null },
        timestamp: { gte: startDate },
      },
      _count: {
        feedback: true,
      },
    });

    // Calculate inbound stats
    const inboundThumbsUp = inboundFeedback.find((f) => f.feedback === 'up')?._count.feedback || 0;
    const inboundThumbsDown = inboundFeedback.find((f) => f.feedback === 'down')?._count.feedback || 0;
    const inboundTotal = inboundThumbsUp + inboundThumbsDown;
    const inboundPositiveRate = calculatePositiveRate(inboundThumbsUp, inboundThumbsDown);

    // Outbound feedback aggregation
    const outboundFeedback = await db.interpretation.groupBy({
      by: ['feedback'],
      where: {
        interpretation_type: 'outbound',
        feedback: { not: null },
        timestamp: { gte: startDate },
      },
      _count: {
        feedback: true,
      },
    });

    // Calculate outbound stats
    const outboundThumbsUp = outboundFeedback.find((f) => f.feedback === 'up')?._count.feedback || 0;
    const outboundThumbsDown = outboundFeedback.find((f) => f.feedback === 'down')?._count.feedback || 0;
    const outboundTotal = outboundThumbsUp + outboundThumbsDown;
    const outboundPositiveRate = calculatePositiveRate(outboundThumbsUp, outboundThumbsDown);

    log.info('Overall stats fetched successfully', {
      totalInterpretations,
      inboundTotal,
      outboundTotal,
    });

    return {
      total_interpretations: totalInterpretations,
      inbound: {
        total_with_feedback: inboundTotal,
        thumbs_up: inboundThumbsUp,
        thumbs_down: inboundThumbsDown,
        positive_rate: inboundPositiveRate,
      },
      outbound: {
        total_with_feedback: outboundTotal,
        thumbs_up: outboundThumbsUp,
        thumbs_down: outboundThumbsDown,
        positive_rate: outboundPositiveRate,
      },
    };
  } catch (error) {
    log.error('Failed to fetch overall stats', {
      dateRange,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    throw new Error('Failed to fetch overall statistics');
  }
}

/**
 * Gets culture pair statistics (top 5 pairs with lowest positive rates)
 *
 * Identifies problematic culture pairs that need prompt improvements.
 *
 * @param dateRange - Date range filter ('7d', '30d', 'all')
 * @returns Array of culture pair statistics (top 5 lowest positive rates)
 */
export async function getCulturePairStats(dateRange: DateRangeType): Promise<CulturePairStats[]> {
  const startDate = parseDateRange(dateRange);

  try {
    log.info('Fetching culture pair stats', { dateRange, startDate });

    // Get all interpretations with feedback, grouped by culture pair
    const culturePairs = await db.interpretation.groupBy({
      by: ['culture_sender', 'culture_receiver', 'feedback'],
      where: {
        feedback: { not: null },
        timestamp: { gte: startDate },
      },
      _count: {
        feedback: true,
      },
    });

    // Aggregate by culture pair (sender + receiver combination)
    const pairMap = new Map<string, { sender: string; receiver: string; up: number; down: number }>();

    culturePairs.forEach((pair) => {
      const key = `${pair.culture_sender}|${pair.culture_receiver}`;

      if (!pairMap.has(key)) {
        pairMap.set(key, {
          sender: pair.culture_sender,
          receiver: pair.culture_receiver,
          up: 0,
          down: 0,
        });
      }

      const stats = pairMap.get(key)!;
      if (pair.feedback === 'up') {
        stats.up += pair._count.feedback;
      } else if (pair.feedback === 'down') {
        stats.down += pair._count.feedback;
      }
    });

    // Convert to array and calculate positive rates
    const pairStats: CulturePairStats[] = Array.from(pairMap.values()).map((stats) => ({
      sender: stats.sender,
      receiver: stats.receiver,
      total: stats.up + stats.down,
      thumbs_up: stats.up,
      thumbs_down: stats.down,
      positive_rate: calculatePositiveRate(stats.up, stats.down),
    }));

    // Sort by positive rate (ascending) - lowest rates first (problematic pairs)
    pairStats.sort((a, b) => a.positive_rate - b.positive_rate);

    // Return top 5 lowest
    const top5Lowest = pairStats.slice(0, 5);

    log.info('Culture pair stats fetched successfully', {
      totalPairs: pairStats.length,
      top5Count: top5Lowest.length,
    });

    return top5Lowest;
  } catch (error) {
    log.error('Failed to fetch culture pair stats', {
      dateRange,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    throw new Error('Failed to fetch culture pair statistics');
  }
}

/**
 * Exports feedback data as structured array for CSV conversion
 *
 * Returns metadata only (no message content) for privacy.
 *
 * @param dateRange - Date range filter ('7d', '30d', 'all')
 * @returns Array of feedback data (metadata only)
 */
export async function exportFeedbackData(dateRange: DateRangeType): Promise<FeedbackExportData[]> {
  const startDate = parseDateRange(dateRange);

  try {
    log.info('Exporting feedback data', { dateRange, startDate });

    const feedbackData = await db.interpretation.findMany({
      where: {
        feedback: { not: null },
        timestamp: { gte: startDate },
      },
      select: {
        id: true,
        timestamp: true,
        interpretation_type: true,
        culture_sender: true,
        culture_receiver: true,
        feedback: true,
        feedback_timestamp: true,
        character_count: true,
        llm_provider: true,
        response_time_ms: true,
        cost_usd: true,
        // EXCLUDE: No message content fields
      },
      orderBy: {
        timestamp: 'desc',
      },
    });

    const exportData: FeedbackExportData[] = feedbackData.map((item) => ({
      interpretation_id: item.id,
      timestamp: item.timestamp,
      type: item.interpretation_type,
      sender_culture: item.culture_sender,
      receiver_culture: item.culture_receiver,
      feedback: item.feedback!,
      feedback_timestamp: item.feedback_timestamp!,
      character_count: item.character_count,
      llm_provider: item.llm_provider,
      response_time_ms: item.response_time_ms,
      cost_usd: parseFloat(item.cost_usd.toString()),
    }));

    log.info('Feedback data exported successfully', {
      recordCount: exportData.length,
    });

    return exportData;
  } catch (error) {
    log.error('Failed to export feedback data', {
      dateRange,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    throw new Error('Failed to export feedback data');
  }
}
```

**Service Design Notes:**
- **Type-safe**: All functions return strongly-typed interfaces
- **Privacy-first**: exportFeedbackData excludes message content
- **Error handling**: Try-catch with structured logging
- **Aggregation**: Uses Prisma groupBy for performance
- **Date filtering**: Flexible date range support
- **Rate calculation**: Helper function ensures consistent calculation
- **Top N filtering**: Returns top 5 problematic culture pairs

[Source: architecture/16-coding-standards.md#service-layer-patterns, architecture/5-data-model.md#prisma-aggregation]

---

#### GET /api/admin/feedback/stats Endpoint (Complete Implementation)

**File: `app/api/admin/feedback/stats/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { db } from '@/lib/db/client';
import { log } from '@/lib/utils/logger';
import {
  getOverallStats,
  getCulturePairStats,
  type DateRangeType,
} from '@/lib/services/feedbackAnalyticsService';

/**
 * GET /api/admin/feedback/stats
 *
 * Returns aggregated feedback statistics for admin dashboard.
 *
 * Authentication: Required (Supabase session)
 * Authorization: Admin only (is_admin = true)
 * Query params: ?range=7d|30d|all (default: 30d)
 *
 * @param req - Next.js request with query params
 * @returns JSON response with overall stats and culture pair stats
 */
export async function GET(req: NextRequest) {
  const startTime = Date.now();

  try {
    // 1. AUTHENTICATION - Check user session
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      log.warn('Feedback stats request - Unauthorized', {
        error: authError?.message,
      });

      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'UNAUTHORIZED',
            message: 'Authentication required',
          },
        },
        { status: 401 }
      );
    }

    // 2. AUTHORIZATION - Check admin flag from database
    const dbUser = await db.user.findUnique({
      where: { id: user.id },
      select: { is_admin: true },
    });

    if (!dbUser || !dbUser.is_admin) {
      log.warn('Feedback stats request - Forbidden (non-admin)', {
        user_id: user.id,
        is_admin: dbUser?.is_admin,
      });

      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'FORBIDDEN',
            message: 'Admin access required',
          },
        },
        { status: 403 }
      );
    }

    // 3. PARSE QUERY PARAMS
    const { searchParams } = new URL(req.url);
    const rangeParam = searchParams.get('range') || '30d';

    // Validate range parameter
    const validRanges: DateRangeType[] = ['7d', '30d', 'all'];
    const dateRange: DateRangeType = validRanges.includes(rangeParam as DateRangeType)
      ? (rangeParam as DateRangeType)
      : '30d';

    log.info('Fetching feedback stats', {
      user_id: user.id,
      dateRange,
    });

    // 4. FETCH STATISTICS
    const [overallStats, culturePairStats] = await Promise.all([
      getOverallStats(dateRange),
      getCulturePairStats(dateRange),
    ]);

    const responseTimeMs = Date.now() - startTime;

    log.info('Feedback stats fetched successfully', {
      user_id: user.id,
      dateRange,
      response_time_ms: responseTimeMs,
      total_interpretations: overallStats.total_interpretations,
      culture_pairs_count: culturePairStats.length,
    });

    // 5. RESPONSE
    return NextResponse.json(
      {
        success: true,
        data: {
          total_interpretations: overallStats.total_interpretations,
          inbound: overallStats.inbound,
          outbound: overallStats.outbound,
          culture_pairs: culturePairStats,
        },
      },
      { status: 200 }
    );
  } catch (error) {
    const responseTimeMs = Date.now() - startTime;

    log.error('Feedback stats request - Server error', {
      error: error instanceof Error ? error.message : 'Unknown error',
      response_time_ms: responseTimeMs,
    });

    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'SERVER_ERROR',
          message: 'An unexpected error occurred. Please try again.',
        },
      },
      { status: 500 }
    );
  }
}
```

**API Design Notes:**
- **Authentication**: Supabase session required
- **Authorization**: is_admin flag checked from database (not JWT)
- **Query param validation**: Defaults to 30d if invalid
- **Parallel fetching**: Uses Promise.all for performance
- **Structured logging**: Request/response tracking
- **Error handling**: Try-catch with appropriate status codes

[Source: architecture/16-coding-standards.md#api-route-structure, Epic 4 Story 4.5 AC #2, #3, #9]

---

#### GET /api/admin/feedback/export Endpoint (Complete Implementation)

**File: `app/api/admin/feedback/export/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { db } from '@/lib/db/client';
import { log } from '@/lib/utils/logger';
import {
  exportFeedbackData,
  type DateRangeType,
} from '@/lib/services/feedbackAnalyticsService';

/**
 * Converts feedback data array to CSV format
 * @param data - Feedback export data
 * @returns CSV string
 */
function convertToCSV(data: any[]): string {
  if (data.length === 0) {
    return 'interpretation_id,timestamp,type,sender_culture,receiver_culture,feedback,feedback_timestamp,character_count,llm_provider,response_time_ms,cost_usd\n';
  }

  // CSV header
  const headers = Object.keys(data[0]).join(',');

  // CSV rows
  const rows = data.map((row) => {
    return Object.values(row)
      .map((value) => {
        // Handle dates
        if (value instanceof Date) {
          return value.toISOString();
        }
        // Handle strings with commas (escape with quotes)
        if (typeof value === 'string' && value.includes(',')) {
          return `"${value}"`;
        }
        return value;
      })
      .join(',');
  });

  return [headers, ...rows].join('\n');
}

/**
 * GET /api/admin/feedback/export
 *
 * Exports feedback data as CSV file (metadata only, no message content).
 *
 * Authentication: Required (Supabase session)
 * Authorization: Admin only (is_admin = true)
 * Query params: ?range=7d|30d|all (default: 30d)
 *
 * @param req - Next.js request with query params
 * @returns CSV file download
 */
export async function GET(req: NextRequest) {
  const startTime = Date.now();

  try {
    // 1. AUTHENTICATION - Check user session
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      log.warn('Feedback export request - Unauthorized', {
        error: authError?.message,
      });

      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'UNAUTHORIZED',
            message: 'Authentication required',
          },
        },
        { status: 401 }
      );
    }

    // 2. AUTHORIZATION - Check admin flag from database
    const dbUser = await db.user.findUnique({
      where: { id: user.id },
      select: { is_admin: true },
    });

    if (!dbUser || !dbUser.is_admin) {
      log.warn('Feedback export request - Forbidden (non-admin)', {
        user_id: user.id,
        is_admin: dbUser?.is_admin,
      });

      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'FORBIDDEN',
            message: 'Admin access required',
          },
        },
        { status: 403 }
      );
    }

    // 3. PARSE QUERY PARAMS
    const { searchParams } = new URL(req.url);
    const rangeParam = searchParams.get('range') || '30d';

    // Validate range parameter
    const validRanges: DateRangeType[] = ['7d', '30d', 'all'];
    const dateRange: DateRangeType = validRanges.includes(rangeParam as DateRangeType)
      ? (rangeParam as DateRangeType)
      : '30d';

    log.info('Exporting feedback data', {
      user_id: user.id,
      dateRange,
    });

    // 4. FETCH EXPORT DATA
    const feedbackData = await exportFeedbackData(dateRange);

    // 5. CONVERT TO CSV
    const csvContent = convertToCSV(feedbackData);

    const responseTimeMs = Date.now() - startTime;

    log.info('Feedback data exported successfully', {
      user_id: user.id,
      dateRange,
      response_time_ms: responseTimeMs,
      record_count: feedbackData.length,
    });

    // 6. RETURN CSV FILE
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    const filename = `feedback-export-${dateRange}-${today}.csv`;

    return new NextResponse(csvContent, {
      status: 200,
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="${filename}"`,
      },
    });
  } catch (error) {
    const responseTimeMs = Date.now() - startTime;

    log.error('Feedback export request - Server error', {
      error: error instanceof Error ? error.message : 'Unknown error',
      response_time_ms: responseTimeMs,
    });

    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'SERVER_ERROR',
          message: 'An unexpected error occurred. Please try again.',
        },
      },
      { status: 500 }
    );
  }
}
```

**CSV Export Design Notes:**
- **Authentication**: Supabase session required
- **Authorization**: Admin-only access
- **CSV format**: Standard RFC 4180 format
- **Filename**: Includes date range and current date
- **Content-Type**: text/csv header
- **Content-Disposition**: Forces browser download
- **Privacy**: Only metadata exported (no message content)
- **Helper function**: convertToCSV handles escaping and formatting

[Source: architecture/16-coding-standards.md#api-route-structure, Epic 4 Story 4.5 AC #6, #7]

---

#### Admin Dashboard Page & Components (Complete Implementations)

Due to length, the complete implementations for the admin dashboard page and all 4 admin components (OverallStats, CulturePairTable, DateRangeFilter, ExportButton) are provided as high-level code structures with key patterns. Dev agent should follow these patterns:

**Admin Dashboard Page Pattern** (`app/admin/feedback/page.tsx`):
- Server Component for data fetching
- Check authentication + authorization (redirect if not admin)
- Parse searchParams for date range
- Fetch stats server-side via feedbackAnalyticsService
- Pass data to client components as props
- Handle loading and error states

**OverallStats Component Pattern** (`components/admin/OverallStats.tsx`):
- Client Component ('use client')
- Displays 3 shadcn/ui Card components in responsive grid
- Color indicators: Green (â‰¥80%), Yellow (60-79%), Red (<60%)
- Shows percentage with breakdown (X up / Y down)

**CulturePairTable Component Pattern** (`components/admin/CulturePairTable.tsx`):
- Client Component with shadcn/ui Table
- Displays culture pairs sorted by positive rate (ascending)
- Color-coded positive rate column
- Responsive table (stacks on mobile)

**DateRangeFilter Component Pattern** (`components/admin/DateRangeFilter.tsx`):
- Client Component with shadcn/ui Select
- Options: 7d, 30d, all
- Updates URL params using useRouter() and useSearchParams()
- Triggers Server Component re-render

**ExportButton Component Pattern** (`components/admin/ExportButton.tsx`):
- Client Component with Button and Download icon
- Calls GET /api/admin/feedback/export
- Shows loading state during download
- Triggers browser file download

[Source: architecture/16-coding-standards.md#component-patterns, architecture/10-frontend-architecture.md#server-components]

---

### File Locations and Project Structure

**Files to Create:**
```
/lib/services/
  â””â”€â”€ feedbackAnalyticsService.ts       # CREATE: Business logic layer

/app/api/admin/feedback/
  â”œâ”€â”€ stats/
  â”‚   â””â”€â”€ route.ts                      # CREATE: GET statistics endpoint
  â””â”€â”€ export/
      â””â”€â”€ route.ts                      # CREATE: GET CSV export endpoint

/app/admin/feedback/
  â””â”€â”€ page.tsx                          # CREATE: Admin dashboard page (Server Component)

/components/admin/
  â”œâ”€â”€ OverallStats.tsx                  # CREATE: Statistics cards
  â”œâ”€â”€ CulturePairTable.tsx              # CREATE: Culture pair table
  â”œâ”€â”€ DateRangeFilter.tsx               # CREATE: Date range selector
  â””â”€â”€ ExportButton.tsx                  # CREATE: CSV export button

/tests/unit/services/
  â””â”€â”€ feedbackAnalyticsService.test.ts  # CREATE: Service unit tests

/tests/unit/api/admin/feedback/
  â”œâ”€â”€ stats/route.test.ts               # CREATE: Stats API tests
  â””â”€â”€ export/route.test.ts              # CREATE: Export API tests

/tests/integration/admin/
  â””â”€â”€ feedback-dashboard.test.ts        # CREATE: Integration tests
```

**Files to Modify:**
```
/middleware.ts                          # MODIFY: Add /admin route protection

/app/admin/
  â””â”€â”€ layout.tsx                        # MODIFY: Add feedback link to admin nav
```

[Source: architecture/12-unified-project-structure.md]

---

### Relevant Source Tree

```
towerofbabel/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”œâ”€â”€ layout.tsx                     # MODIFY: Add nav link
â”‚   â”‚   â””â”€â”€ feedback/
â”‚   â”‚       â””â”€â”€ page.tsx                   # CREATE: Admin dashboard
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ feedback/
â”‚               â”œâ”€â”€ stats/
â”‚               â”‚   â””â”€â”€ route.ts           # CREATE: GET stats
â”‚               â””â”€â”€ export/
â”‚                   â””â”€â”€ route.ts           # CREATE: GET CSV
â”œâ”€â”€ components/
â”‚   â””â”€â”€ admin/
â”‚       â”œâ”€â”€ OverallStats.tsx               # CREATE
â”‚       â”œâ”€â”€ CulturePairTable.tsx           # CREATE
â”‚       â”œâ”€â”€ DateRangeFilter.tsx            # CREATE
â”‚       â””â”€â”€ ExportButton.tsx               # CREATE
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ feedbackAnalyticsService.ts    # CREATE
â”œâ”€â”€ middleware.ts                          # MODIFY: Add /admin protection
â””â”€â”€ tests/
    â”œâ”€â”€ unit/
    â”‚   â”œâ”€â”€ services/
    â”‚   â”‚   â””â”€â”€ feedbackAnalyticsService.test.ts  # CREATE
    â”‚   â””â”€â”€ api/
    â”‚       â””â”€â”€ admin/
    â”‚           â””â”€â”€ feedback/
    â”‚               â”œâ”€â”€ stats/route.test.ts       # CREATE
    â”‚               â””â”€â”€ export/route.test.ts      # CREATE
    â””â”€â”€ integration/
        â””â”€â”€ admin/
            â””â”€â”€ feedback-dashboard.test.ts        # CREATE
```

---

## Files to Modify/Create

### New Files

1. **`app/admin/feedback/page.tsx`** (NEW)
   - Admin dashboard page (Server Component)
   - Fetch aggregated statistics via Prisma
   - Check admin authorization (is_admin flag)
   - Render dashboard UI with statistics

2. **`components/admin/OverallStats.tsx`** (NEW)
   - Display overall feedback statistics in card layout
   - Props: total, inbound stats, outbound stats
   - Responsive grid (1 col mobile, 3 cols desktop)

3. **`components/admin/CulturePairTable.tsx`** (NEW)
   - Table showing culture pairs with lowest positive rates
   - Props: culturePairs array
   - Sort by positive rate (ascending)
   - Responsive table (stack on mobile)

4. **`components/admin/DateRangeFilter.tsx`** (NEW)
   - Dropdown for date range selection
   - Options: Last 7 days, Last 30 days, All time
   - Updates URL params (useRouter, useSearchParams)

5. **`components/admin/ExportButton.tsx`** (NEW)
   - Button to download CSV export
   - Calls GET /api/admin/feedback/export
   - Shows loading state during download

6. **`app/api/admin/feedback/stats/route.ts`** (NEW)
   - GET endpoint for aggregated statistics
   - Query params: range (7d, 30d, all)
   - Returns JSON with overall stats + culture pairs

7. **`app/api/admin/feedback/export/route.ts`** (NEW)
   - GET endpoint for CSV export
   - Query params: range (7d, 30d, all)
   - Returns CSV file with feedback metadata

8. **`lib/services/feedbackAnalyticsService.ts`** (NEW)
   - Business logic for feedback analytics
   - Functions:
     - `getOverallStats(dateRange)`
     - `getCulturePairStats(dateRange)`
     - `exportFeedbackData(dateRange)`
   - Uses Prisma aggregation queries

### Modified Files

1. **`middleware.ts`** (MODIFY)
   - Add `/admin/*` to protected routes
   - Check authentication for admin routes (not authorization - that's in page/API)

2. **`app/admin/layout.tsx`** (CREATE or MODIFY if exists)
   - Admin layout with navigation
   - Show admin indicator badge
   - Consistent styling across admin pages

---

## Dependencies

- **Story 4.4**: Feedback mechanism implemented (feedback and feedback_timestamp fields exist)
- **User.is_admin field**: Already exists in schema (no migration needed)
- **Admin auth pattern**: Already established in `/app/api/admin/cost-metrics/route.ts`
- **Prisma**: Aggregation queries for statistics
- **shadcn/ui components**: Table, Card, Button, Select

[Source: architecture/3-tech-stack.md#database, architecture/3-tech-stack.md#ui-components]

---

## Tasks / Subtasks

- [ ] **Task 1: Update Middleware to Protect /admin Routes** (AC: 1, 9)
  - [ ] Open `/middleware.ts`
  - [ ] Add `/admin` route protection (same pattern as `/dashboard`)
  - [ ] Update matcher config if needed
  - [ ] Test: Unauthenticated user redirected to /sign-in
  - [ ] Test: Authenticated non-admin user can access /admin route (authorization check in page)

- [ ] **Task 2: Create Feedback Analytics Service** (AC: 2, 3, 10)
  - [ ] Create `/lib/services/feedbackAnalyticsService.ts`
  - [ ] Implement `getOverallStats(dateRange)` function:
    - Total interpretations count
    - Inbound stats (total with feedback, thumbs up, thumbs down, positive rate)
    - Outbound stats (same as inbound)
  - [ ] Implement `getCulturePairStats(dateRange)` function:
    - Group by culture_sender and culture_receiver
    - Calculate thumbs up, thumbs down, positive rate for each pair
    - Sort by positive rate (ascending)
    - Return top 5 lowest
  - [ ] Implement `exportFeedbackData(dateRange)` function:
    - Fetch all interpretations with feedback (metadata only)
    - Return array for CSV conversion
  - [ ] Add helper function `parseDateRange(range)` to convert "7d" â†’ Date objects
  - [ ] Add JSDoc documentation for all functions
  - [ ] Use Prisma aggregation (no raw SQL)

- [ ] **Task 3: Create GET /api/admin/feedback/stats Endpoint** (AC: 2, 3, 5, 9, 10)
  - [ ] Create `/app/api/admin/feedback/stats/route.ts`
  - [ ] Implement GET handler
  - [ ] Check authentication (Supabase session)
  - [ ] Check authorization (is_admin flag from database)
  - [ ] Return 403 if not admin
  - [ ] Parse query param: range (7d, 30d, all)
  - [ ] Call `getOverallStats()` and `getCulturePairStats()`
  - [ ] Return JSON response with aggregated data
  - [ ] Add error handling and logging

- [ ] **Task 4: Create GET /api/admin/feedback/export Endpoint** (AC: 6, 7, 9)
  - [ ] Create `/app/api/admin/feedback/export/route.ts`
  - [ ] Implement GET handler
  - [ ] Check authentication and authorization (is_admin)
  - [ ] Return 403 if not admin
  - [ ] Parse query param: range (7d, 30d, all)
  - [ ] Call `exportFeedbackData()`
  - [ ] Convert data to CSV format (use library or manual)
  - [ ] Return CSV file with proper headers:
    - Content-Type: text/csv
    - Content-Disposition: attachment; filename="feedback-export-YYYY-MM-DD.csv"
  - [ ] Add error handling and logging

- [ ] **Task 5: Create Admin Dashboard Page** (AC: 1, 2, 3, 5, 7, 9)
  - [ ] Create `/app/admin/feedback/page.tsx` (Server Component)
  - [ ] Check authentication (redirect to /sign-in if not authenticated)
  - [ ] Check authorization (is_admin flag from database)
  - [ ] Redirect to /dashboard with error message if not admin
  - [ ] Parse searchParams for date range filter
  - [ ] Fetch statistics server-side via feedbackAnalyticsService
  - [ ] Render dashboard layout:
    - Page title: "Feedback Analytics"
    - Date range filter component
    - Overall stats cards
    - Culture pair table
    - Export button
  - [ ] Handle loading state
  - [ ] Handle error state (failed to fetch stats)

- [ ] **Task 6: Create OverallStats Component** (AC: 2)
  - [ ] Create `/components/admin/OverallStats.tsx` (Client Component)
  - [ ] Props: totalInterpretations, inboundStats, outboundStats
  - [ ] Render three cards using shadcn/ui Card component:
    - Total Interpretations (large number)
    - Inbound Positive Rate (percentage with badge)
    - Outbound Positive Rate (percentage with badge)
  - [ ] Use color indicators:
    - Green: â‰¥80% positive rate
    - Yellow: 60-79% positive rate
    - Red: <60% positive rate
  - [ ] Responsive layout: 1 column (mobile), 3 columns (desktop)
  - [ ] Show breakdown: "380 up / 70 down" below percentage

- [ ] **Task 7: Create CulturePairTable Component** (AC: 3)
  - [ ] Create `/components/admin/CulturePairTable.tsx` (Client Component)
  - [ ] Props: culturePairs array
  - [ ] Use shadcn/ui Table component
  - [ ] Columns: Sender, Receiver, Total, Thumbs Up, Thumbs Down, Positive Rate
  - [ ] Display culture codes with flags (optional emoji flags)
  - [ ] Color-code positive rate (same as OverallStats)
  - [ ] Responsive: Stack columns on mobile (use shadcn responsive table)
  - [ ] Show "No data" message if culturePairs empty

- [ ] **Task 8: Create DateRangeFilter Component** (AC: 5)
  - [ ] Create `/components/admin/DateRangeFilter.tsx` (Client Component)
  - [ ] Use shadcn/ui Select component
  - [ ] Options: Last 7 days, Last 30 days, All time
  - [ ] Default: Last 30 days
  - [ ] Update URL params on change:
    - Use `useRouter()` and `useSearchParams()`
    - Update `?range=7d|30d|all`
    - Triggers Server Component re-render
  - [ ] Show current selection

- [ ] **Task 9: Create ExportButton Component** (AC: 6)
  - [ ] Create `/components/admin/ExportButton.tsx` (Client Component)
  - [ ] Use shadcn/ui Button component
  - [ ] Icon: Download (lucide-react)
  - [ ] Label: "Export CSV"
  - [ ] Click handler:
    - Show loading spinner
    - Call GET /api/admin/feedback/export with current date range
    - Trigger browser download of CSV file
    - Hide loading spinner
  - [ ] Error handling: Show toast/alert on failure
  - [ ] Disable button during loading

- [ ] **Task 10: Create Admin Layout** (AC: 1, 9)
  - [ ] Create `/app/admin/layout.tsx` if not exists
  - [ ] Admin navigation:
    - Link to /admin/feedback (Feedback Analytics)
    - Link to /api/admin/cost-metrics (Cost Metrics - existing)
    - Back to Dashboard link
  - [ ] Show admin badge: "Admin View" indicator
  - [ ] Consistent styling with main app
  - [ ] Responsive layout

- [ ] **Task 11: Unit Tests for feedbackAnalyticsService** (AC: 2, 3, 10)
  - [ ] Test: `getOverallStats()` returns correct aggregated data
  - [ ] Test: Inbound stats calculated correctly
  - [ ] Test: Outbound stats calculated correctly
  - [ ] Test: Positive rate calculation correct
  - [ ] Test: Date range filtering works (7d, 30d, all)
  - [ ] Test: `getCulturePairStats()` returns top 5 lowest pairs
  - [ ] Test: Culture pair stats sorted correctly (ascending positive rate)
  - [ ] Test: `exportFeedbackData()` returns correct metadata
  - [ ] Test: No message content included in export
  - [ ] Test: `parseDateRange()` converts ranges correctly

- [ ] **Task 12: Unit Tests for API Endpoints** (AC: 9)
  - [ ] Test: GET /api/admin/feedback/stats returns 401 for unauthenticated
  - [ ] Test: GET /api/admin/feedback/stats returns 403 for non-admin
  - [ ] Test: GET /api/admin/feedback/stats returns correct data for admin
  - [ ] Test: Date range query param works correctly
  - [ ] Test: GET /api/admin/feedback/export returns 403 for non-admin
  - [ ] Test: GET /api/admin/feedback/export returns CSV file
  - [ ] Test: CSV has correct headers
  - [ ] Test: CSV contains correct data (no message content)
  - [ ] Test: Error handling for invalid date range

- [ ] **Task 13: Integration Tests** (AC: all)
  - [ ] Test: Admin user can access /admin/feedback page
  - [ ] Test: Non-admin user redirected or blocked
  - [ ] Test: Overall stats displayed correctly
  - [ ] Test: Culture pair table displayed correctly
  - [ ] Test: Date range filter updates page
  - [ ] Test: Export button downloads CSV file
  - [ ] Test: CSV file contains correct data

- [ ] **Task 14: Manual QA - Admin Dashboard** (AC: all)
  - [ ] Login as admin user (set is_admin=true in database)
  - [ ] Navigate to /admin/feedback
  - [ ] Verify overall stats displayed (total, inbound rate, outbound rate)
  - [ ] Verify culture pair table shows top 5 lowest pairs
  - [ ] Test date range filter (7d, 30d, all time)
  - [ ] Verify stats update when filter changes
  - [ ] Click export button â†’ verify CSV downloads
  - [ ] Open CSV â†’ verify correct headers and data
  - [ ] Verify NO message content in CSV (privacy maintained)

- [ ] **Task 15: Manual QA - Authorization** (AC: 9)
  - [ ] Login as non-admin user (is_admin=false)
  - [ ] Attempt to access /admin/feedback
  - [ ] Verify redirected or blocked (403 error)
  - [ ] Attempt to call GET /api/admin/feedback/stats directly
  - [ ] Verify 403 Forbidden response
  - [ ] Attempt to call GET /api/admin/feedback/export
  - [ ] Verify 403 Forbidden response

- [ ] **Task 16: Manual QA - Data Accuracy** (AC: 2, 3)
  - [ ] Submit feedback on several interpretations (mix of up/down)
  - [ ] Access admin dashboard
  - [ ] Verify total interpretations count matches database
  - [ ] Verify positive rate calculation correct (manual calculation)
  - [ ] Submit feedback on specific culture pair (e.g., en-US â†’ ja-JP)
  - [ ] Verify culture pair appears in table
  - [ ] Verify stats match database query

- [ ] **Task 17: Documentation** (AC: all)
  - [ ] Update README or create `/docs/admin-dashboard.md`
  - [ ] Document how to grant admin access (set is_admin=true)
  - [ ] Document dashboard features and metrics
  - [ ] Document CSV export format
  - [ ] Document date range options
  - [ ] Add screenshots of dashboard UI

---

## Testing Requirements

### Unit Tests

**feedbackAnalyticsService** (`feedbackAnalyticsService.test.ts`):
1. `getOverallStats()` returns correct aggregated data
2. Inbound stats calculated correctly (thumbs up, down, rate)
3. Outbound stats calculated correctly
4. Positive rate calculation correct (handles 0 feedback case)
5. Date range filtering works (7d, 30d, all)
6. `getCulturePairStats()` returns top 5 lowest pairs
7. Culture pair stats sorted correctly (ascending)
8. `exportFeedbackData()` returns correct metadata
9. No message content included in export data
10. `parseDateRange()` converts "7d", "30d", "all" correctly

**API Endpoints** (`route.test.ts` for each):

GET /api/admin/feedback/stats:
1. Returns 401 for unauthenticated user
2. Returns 403 for authenticated non-admin user
3. Returns 200 with correct data for admin user
4. Date range query param works (7d, 30d, all)
5. Returns empty stats gracefully (no interpretations)
6. Error handling for database failures

GET /api/admin/feedback/export:
1. Returns 403 for non-admin user
2. Returns CSV file for admin user
3. CSV has correct headers
4. CSV contains correct data (metadata only)
5. Date range query param works
6. Error handling for database failures

### Integration Tests

1. Admin user accesses /admin/feedback â†’ page loads with stats
2. Non-admin user attempts access â†’ redirected or blocked
3. Date range filter updates â†’ stats refresh correctly
4. Export button clicked â†’ CSV file downloads
5. CSV file opened â†’ data matches dashboard stats

### Manual Tests

**Admin Dashboard Access:**
1. Login as admin â†’ access /admin/feedback â†’ verify page loads
2. Login as non-admin â†’ access /admin/feedback â†’ verify blocked
3. Direct API call to /api/admin/feedback/stats as non-admin â†’ verify 403

**Statistics Display:**
1. Verify total interpretations count correct
2. Verify inbound positive rate correct (manual calculation)
3. Verify outbound positive rate correct
4. Verify culture pair table shows top 5 lowest
5. Verify color indicators (green/yellow/red) correct

**Date Range Filter:**
1. Select "Last 7 days" â†’ verify stats update
2. Select "Last 30 days" â†’ verify stats update
3. Select "All time" â†’ verify stats update
4. Verify URL params update (?range=7d|30d|all)

**CSV Export:**
1. Click export button â†’ verify CSV downloads
2. Open CSV file â†’ verify headers correct
3. Verify data matches dashboard stats
4. Verify NO message content in CSV (privacy maintained)
5. Verify all metadata fields present (see CSV format above)

**Data Accuracy:**
1. Submit 10 thumbs up, 5 thumbs down â†’ verify rate = 66.67%
2. Submit feedback on culture pair â†’ verify appears in table
3. Test with no feedback â†’ verify empty state displayed

---

## Definition of Done

- [ ] Middleware updated to protect /admin routes
- [ ] feedbackAnalyticsService created with aggregation queries
- [ ] GET /api/admin/feedback/stats endpoint implemented
- [ ] GET /api/admin/feedback/export endpoint implemented
- [ ] Admin dashboard page created at /admin/feedback
- [ ] OverallStats component created and integrated
- [ ] CulturePairTable component created and integrated
- [ ] DateRangeFilter component created and integrated
- [ ] ExportButton component created and integrated
- [ ] Admin layout created with navigation
- [ ] Unit tests written and passing (16+ test cases)
  - feedbackAnalyticsService: 10 test cases
  - API endpoints: 12 test cases (6 per endpoint)
- [ ] Integration tests written and passing
- [ ] Manual QA completed for all scenarios
- [ ] Authorization verified (admin-only access)
- [ ] Data accuracy verified (stats match database)
- [ ] CSV export verified (correct format, privacy maintained)
- [ ] Documentation created (admin dashboard guide)
- [ ] Code review completed
- [ ] Deployed to staging environment
- [ ] Product manager approval

---

## Story Draft Validation Checklist

### 1. Acceptance Criteria Quality (Target: 10/10 strict criteria)
- [x] AC 1: Specific and testable (admin dashboard at /app/admin/feedback)
- [x] AC 2: Specific and testable (overall feedback statistics)
- [x] AC 3: Specific and testable (culture pair breakdown - top 5 lowest)
- [x] AC 4: Specific and testable (time-series chart - optional, deferred)
- [x] AC 5: Specific and testable (date range filter)
- [x] AC 6: Specific and testable (CSV export)
- [x] AC 7: Specific and testable (no message content displayed)
- [x] AC 8: Specific and testable (is_admin flag exists)
- [x] AC 9: Specific and testable (admin-only access)
- [x] AC 10: Specific and testable (Prisma aggregation queries)

**Score: 10/10** âœ… (All criteria specific, measurable, testable)

### 2. Task Breakdown Quality (Target: Actionable 1-4 hour tasks)
- [x] Task 1: Middleware update (30 min) âœ…
- [x] Task 2: Analytics service (3-4 hours) âœ…
- [x] Task 3: Stats API endpoint (2-3 hours) âœ…
- [x] Task 4: Export API endpoint (2-3 hours) âœ…
- [x] Task 5: Admin dashboard page (3-4 hours) âœ…
- [x] Task 6: OverallStats component (1-2 hours) âœ…
- [x] Task 7: CulturePairTable component (2-3 hours) âœ…
- [x] Task 8: DateRangeFilter component (1-2 hours) âœ…
- [x] Task 9: ExportButton component (1-2 hours) âœ…
- [x] Task 10: Admin layout (1-2 hours) âœ…
- [x] Task 11: Service unit tests (3-4 hours) âœ…
- [x] Task 12: API unit tests (3-4 hours) âœ…
- [x] Task 13: Integration tests (2-3 hours) âœ…
- [x] Task 14: Manual QA - Dashboard (1-2 hours) âœ…
- [x] Task 15: Manual QA - Authorization (1 hour) âœ…
- [x] Task 16: Manual QA - Data accuracy (1-2 hours) âœ…
- [x] Task 17: Documentation (1-2 hours) âœ…

**Score: 17/17** âœ… (All tasks actionable, appropriately sized, clear deliverables)

### 3. Technical Approach Completeness
- [x] Authentication/authorization pattern specified âœ…
- [x] Database queries defined with Prisma aggregation âœ…
- [x] UI component structure defined âœ…
- [x] API endpoints specified with request/response formats âœ…
- [x] CSV export format specified âœ…
- [x] Privacy-first approach maintained (no message content) âœ…
- [x] Error handling strategy defined âœ…

**Score: 7/7** âœ… (Technical approach comprehensive and clear)

### 4. Dependencies and Risks
- [x] Dependencies clearly listed (Story 4.4, is_admin field, admin auth pattern) âœ…
- [x] External libraries identified (shadcn/ui, Prisma) âœ…
- [x] No blocking risks identified âœ…
- [x] Deferred feature clearly marked (time-series chart - optional) âœ…

**Score: 4/4** âœ…

### 5. Testing Requirements
- [x] Unit tests specified (28+ test cases total) âœ…
- [x] Integration tests specified âœ…
- [x] Manual QA scenarios detailed (dashboard, authorization, data accuracy) âœ…
- [x] CSV export verification included âœ…
- [x] Privacy verification included (no message content) âœ…

**Score: 5/5** âœ…

### 6. Context and User Value
- [x] Epic 4 goal clearly stated âœ…
- [x] Business value articulated (quality measurement, problem identification, ROI tracking) âœ…
- [x] Privacy-first design maintained (aggregated stats only) âœ…
- [x] MVP scope clearly defined (defer time-series chart) âœ…

**Score: 4/4** âœ…

---

## Final Validation Score

**Total: 47/47 = 10/10** âœ… **READY FOR APPROVAL**

**Strengths:**
- Comprehensive acceptance criteria (10 ACs covering all requirements)
- Well-structured task breakdown (17 tasks, all actionable)
- Detailed technical approach with code examples
- Strong authorization focus (admin-only access)
- Privacy-first design maintained (no message content)
- Thorough testing requirements (28+ unit tests + integration + manual QA)
- Clear dependencies and integration points
- Reuses existing patterns (admin auth from cost-metrics endpoint)
- Deferred optional features clearly marked (time-series chart)

**Recommendations:**
- None - story is ready for implementation

---

## Notes

**Privacy Reminder:** Dashboard displays ONLY aggregated statistics and metadata. No message content is stored or displayed in database or CSV exports.

**Admin Access Setup:**
```sql
-- Grant admin access to user
UPDATE users SET is_admin = true WHERE email = 'admin@towerofbabel.com';

-- Revoke admin access
UPDATE users SET is_admin = false WHERE email = 'user@example.com';
```

**Future Enhancements (Post-MVP):**
1. **Time-series chart** (AC 4 - deferred): Daily feedback trends visualization
2. **A/B testing**: Compare different prompt versions
3. **Sentiment analysis**: Analyze patterns in thumbs down feedback
4. **Real-time dashboard**: Auto-refresh statistics every N seconds
5. **Email alerts**: Notify when positive rate drops below threshold
6. **Culture-specific insights**: Deep dive into specific culture pairs

**Query Performance:**
- All queries use Prisma aggregation (optimized by Prisma Query Engine)
- Add database indexes if needed:
  ```sql
  CREATE INDEX idx_feedback_timestamp ON interpretations(feedback, timestamp);
  CREATE INDEX idx_culture_pair ON interpretations(culture_sender, culture_receiver);
  ```

**CSV Export Limit:**
- Current implementation exports ALL feedback data for selected date range
- If dataset grows large (>100K rows), consider:
  - Pagination for export
  - Background job for large exports
  - Email delivery of CSV file

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Story created with admin feedback analytics dashboard | Scrum Master (Bob) |
| 2025-10-30 | 2.0 | Enhanced with complete code examples (Dev Notes section added) | Product Owner (Sarah) |

---

## Dev Agent Record

### Agent Model Used

**Model:** [To be filled by dev agent]
**Dev Agent:** [To be filled by dev agent]
**Date:** [To be filled by dev agent]

### Debug Log References

[To be filled by dev agent]

### Completion Notes

[To be filled by dev agent]

### File List

**Created Files:**
[To be filled by dev agent]

**Modified Files:**
[To be filled by dev agent]

---

## QA Results

[To be filled by QA agent]

---
