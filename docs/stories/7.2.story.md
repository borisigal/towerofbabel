# Story 7.2: Feedback Component, API Enhancement, Testing & Documentation

<!-- Powered by BMADâ„¢ Core -->

## Status

**Approved**

---

## Story

**As a** user,
**I want** to provide written feedback after selecting thumbs up/down,
**So that** I can explain why I found the interpretation helpful or unhelpful.

---

## Acceptance Criteria

**UI Component:**
1. Textarea appears below thumbs up/down buttons after user selects one
2. Textarea placeholder: "Tell us more (optional)" or similar user-friendly text
3. Character counter displays below textarea (e.g., "0/500 characters")
4. Character counter turns red when approaching limit (e.g., >450 characters)
5. Submit button remains enabled even if textarea is empty (text is optional)
6. Textarea auto-focuses after thumbs selection for smooth UX
7. Textarea has accessible label (aria-label or visible label)
8. Keyboard navigation works (tab to textarea, enter to submit)
9. Mobile-friendly: textarea is appropriately sized for touch input
10. Text input is trimmed before submission (no leading/trailing whitespace)

**API Validation:**
11. `/api/feedback` route accepts optional `feedback_text` parameter
12. Zod schema validates `feedback_text` as optional string
13. Text feedback limited to 500 characters (validation error if exceeded)
14. Empty string or null treated identically (no text feedback)
15. Text feedback sanitized to prevent XSS attacks
16. Existing requests without `feedback_text` continue to work (backward compatibility)
17. Idempotency rules maintained (can't change feedback after submission)
18. Appropriate error messages for validation failures

**Database Persistence:**
19. Text feedback stored in `Interpretation.feedback_text` field
20. Repository layer correctly handles NULL vs. empty string
21. Text feedback saved atomically with binary feedback and timestamp

**Testing:**
22. Unit tests for textarea character counting logic
23. Unit tests for API validation (with/without text, character limit, sanitization)
24. Integration test: submit feedback with text and verify DB storage
25. Integration test: submit feedback without text and verify NULL in DB
26. Regression test: existing thumbs up/down flow works without text
27. `npm run lint` passes with zero errors
28. `npm run build` succeeds with zero errors
29. `npm test` passes all tests

**Documentation:**
30. Update relevant documentation (if any README or API docs exist)
31. Add code comments explaining text feedback flow in `FeedbackButtons.tsx`
32. Document character limit reasoning (500 chars chosen for brevity)

---

## Tasks / Subtasks

- [ ] Task 1: Extend FeedbackButtons component UI (AC: 1-10)
  - [ ] Subtask 1.1: Add state for `showTextarea` (boolean) and `feedbackText` (string)
  - [ ] Subtask 1.2: Show textarea below buttons when thumbs up/down clicked
  - [ ] Subtask 1.3: Import `Textarea` component from `@/components/ui/textarea`
  - [ ] Subtask 1.4: Add placeholder text: "Tell us more (optional)"
  - [ ] Subtask 1.5: Implement character counter (display "X/500 characters")
  - [ ] Subtask 1.6: Add red styling when character count > 450
  - [ ] Subtask 1.7: Add `autoFocus` prop to textarea for smooth UX
  - [ ] Subtask 1.8: Add `aria-label="Optional text feedback"` for accessibility
  - [ ] Subtask 1.9: Ensure textarea is touch-friendly on mobile (min-height: 100px)
  - [ ] Subtask 1.10: Trim text before submission (`feedbackText.trim()`)
  - [ ] Subtask 1.11: Add Submit button below textarea (always enabled)
  - [ ] Subtask 1.12: Update button click handler to submit both feedback type and text

- [ ] Task 2: Update API route validation and logic (AC: 11-18, 21)
  - [ ] Subtask 2.1: Open `app/api/feedback/route.ts`
  - [ ] Subtask 2.2: Update `FeedbackRequestSchema` to include `feedback_text: z.string().max(500).optional()`
  - [ ] Subtask 2.3: Add text sanitization function using DOMPurify or similar (strip HTML tags)
  - [ ] Subtask 2.4: Update Prisma update call to include `feedback_text` field
  - [ ] Subtask 2.5: Ensure empty string and null treated identically (convert empty string to null)
  - [ ] Subtask 2.6: Add validation error response for character limit exceeded
  - [ ] Subtask 2.7: Test backward compatibility (requests without `feedback_text` work)
  - [ ] Subtask 2.8: Verify idempotency rules unchanged (feedback immutable after submission)

- [ ] Task 3: Update TypeScript types (AC: 11)
  - [ ] Subtask 3.1: Open `lib/types/models.ts`
  - [ ] Subtask 3.2: Add `FeedbackRequest` interface if not exists with `interpretationId`, `feedback`, `feedback_text?`
  - [ ] Subtask 3.3: Add `FeedbackResponse` interface if not exists
  - [ ] Subtask 3.4: Add JSDoc comment explaining 500-character limit
  - [ ] Subtask 3.5: Export interfaces for use in components and API routes

- [ ] Task 4: Repository layer verification (AC: 19, 20)
  - [ ] Subtask 4.1: Open `lib/db/repositories/interpretationRepository.ts`
  - [ ] Subtask 4.2: Verify existing functions work with new nullable `feedback_text` field (no changes needed)
  - [ ] Subtask 4.3: Confirm Prisma client auto-generated types include `feedback_text?`
  - [ ] Subtask 4.4: Test NULL vs empty string handling in queries

- [ ] Task 5: Unit tests for component (AC: 22)
  - [ ] Subtask 5.1: Open `tests/unit/components/features/interpretation/FeedbackButtons.test.tsx`
  - [ ] Subtask 5.2: Add test: "should show textarea after thumbs up clicked"
  - [ ] Subtask 5.3: Add test: "should show character counter with correct count"
  - [ ] Subtask 5.4: Add test: "should turn counter red when >450 characters"
  - [ ] Subtask 5.5: Add test: "should trim whitespace before submission"
  - [ ] Subtask 5.6: Add test: "should submit feedback with text successfully"
  - [ ] Subtask 5.7: Add test: "should submit feedback without text successfully"
  - [ ] Subtask 5.8: Add test: "should auto-focus textarea after thumbs selection"
  - [ ] Subtask 5.9: Add test: "should handle keyboard navigation (Tab, Enter)"

- [ ] Task 6: Unit tests for API validation (AC: 23)
  - [ ] Subtask 6.1: Create or open `tests/integration/api/feedback.test.ts`
  - [ ] Subtask 6.2: Add test: "should accept feedback with text under 500 chars"
  - [ ] Subtask 6.3: Add test: "should reject feedback with text over 500 chars"
  - [ ] Subtask 6.4: Add test: "should sanitize HTML in feedback text"
  - [ ] Subtask 6.5: Add test: "should treat empty string as NULL"
  - [ ] Subtask 6.6: Add test: "should accept feedback without text (backward compatibility)"

- [ ] Task 7: Integration tests (AC: 24-25)
  - [ ] Subtask 7.1: Add test: "should store feedback text in database"
  - [ ] Subtask 7.2: Add test: "should store NULL when no text provided"
  - [ ] Subtask 7.3: Add test: "should save text atomically with binary feedback"
  - [ ] Subtask 7.4: Verify existing thumbs up/down tests still pass

- [ ] Task 8: Regression testing (AC: 26)
  - [ ] Subtask 8.1: Run all existing FeedbackButtons tests
  - [ ] Subtask 8.2: Manually test existing feedback flow without text
  - [ ] Subtask 8.3: Verify no breaking changes to existing functionality

- [ ] Task 9: Build verification (AC: 27-29)
  - [ ] Subtask 9.1: Run `npm run lint` and fix any issues
  - [ ] Subtask 9.2: Run `npm run build` and verify success
  - [ ] Subtask 9.3: Run `npm test` and ensure all tests pass
  - [ ] Subtask 9.4: Verify TypeScript compilation has no errors

- [ ] Task 10: Documentation (AC: 30-32)
  - [ ] Subtask 10.1: Add JSDoc comments to new functions in `FeedbackButtons.tsx`
  - [ ] Subtask 10.2: Add inline comments explaining text feedback flow
  - [ ] Subtask 10.3: Document 500-character limit reasoning in code comments
  - [ ] Subtask 10.4: Update component JSDoc with new props/behavior

---

## Dev Notes

### Previous Story Context

**From Story 7.1 (Database Schema):**
- `feedback_text String?` field added to `Interpretation` model [Source: docs/stories/7.1.story.md:38]
- Field is nullable for backward compatibility
- Character limit enforced at API layer, not database
- Migration tested and approved
- TypeScript types updated to include `feedback_text?: string`

### Existing FeedbackButtons Component

**Current Implementation** [Source: components/features/interpretation/FeedbackButtons.tsx:1-216]

The `FeedbackButtons` component currently:
- Renders thumbs up/down buttons with tooltips
- Handles loading state during API call
- Shows visual confirmation on success (checkmark)
- Disables buttons after submission (idempotency)
- Provides error handling with retry option
- WCAG 2.1 AA accessible (keyboard navigation, ARIA labels)
- Uses shadcn/ui `Button` and `Tooltip` components
- Client component (`'use client'` directive)

**Current State Management:**
```typescript
const [isLoading, setIsLoading] = useState(false);
const [submittedFeedback, setSubmittedFeedback] = useState<'up' | 'down' | null>(null);
const [error, setError] = useState<string | null>(null);
```

**Required Additions:**
```typescript
const [showTextarea, setShowTextarea] = useState(false);
const [feedbackText, setFeedbackText] = useState('');
const [selectedFeedback, setSelectedFeedback] = useState<'up' | 'down' | null>(null);
```

**Current API Call:**
```typescript
const response = await fetch('/api/feedback', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    interpretationId,
    feedback, // 'up' or 'down'
  }),
});
```

**Updated API Call:**
```typescript
const response = await fetch('/api/feedback', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    interpretationId,
    feedback: selectedFeedback,
    feedback_text: feedbackText.trim() || null, // Optional, null if empty
  }),
});
```

### UI Flow Changes

**Old Flow:**
1. User clicks thumbs up/down
2. API call immediately submitted
3. Success state shown with checkmark

**New Flow:**
1. User clicks thumbs up/down
2. Textarea appears below buttons with character counter
3. User optionally types feedback (max 500 chars)
4. User clicks "Submit" button
5. API call submitted with both feedback type and text
6. Success state shown with checkmark

**Visual Layout:**
```
Was this helpful?
[ðŸ‘ Thumbs Up]  [ðŸ‘Ž Thumbs Down]

(After thumbs clicked)

[Textarea: "Tell us more (optional)"]
0/500 characters  (red when >450)

[Submit Feedback Button]
```

### Textarea Component

**Available Component** [Source: components/ui/textarea.tsx:1-23]

shadcn/ui `Textarea` component already exists:
```typescript
import { Textarea } from "@/components/ui/textarea";

<Textarea
  placeholder="Tell us more (optional)"
  value={feedbackText}
  onChange={(e) => setFeedbackText(e.target.value)}
  maxLength={500}
  autoFocus
  aria-label="Optional text feedback"
  className="min-h-[100px] w-full"
/>
```

**Styling:**
- Uses Tailwind CSS for consistency
- `min-h-[100px]` for mobile touch targets
- `w-full` for responsive width
- Border, focus ring, placeholder styling from shadcn/ui

### API Route Enhancement

**Current API Route** [Source: app/api/feedback/route.ts:1-210]

Current `/api/feedback` route follows standard patterns:
1. Authentication (Supabase Auth)
2. Request validation (Zod schema)
3. Authorization (user owns interpretation)
4. Idempotency check (feedback already submitted?)
5. Database update
6. Structured logging
7. Standardized response format

**Required Changes:**

**1. Zod Schema Update:**
```typescript
const FeedbackRequestSchema = z.object({
  interpretationId: z.string().uuid('Invalid interpretation ID format'),
  feedback: z.enum(['up', 'down']),
  feedback_text: z.string().max(500, 'Feedback text must be 500 characters or less').optional(),
});
```

**2. Text Sanitization:**
```typescript
// Sanitize feedback text to prevent XSS
function sanitizeFeedbackText(text: string | undefined): string | null {
  if (!text || text.trim() === '') return null;

  // Strip HTML tags and encode special characters
  const sanitized = text
    .replace(/<[^>]*>/g, '') // Remove HTML tags
    .trim();

  return sanitized.length > 0 ? sanitized : null;
}
```

**3. Database Update:**
```typescript
await prisma.interpretation.update({
  where: { id: interpretationId },
  data: {
    feedback,
    feedback_text: sanitizeFeedbackText(validationResult.data.feedback_text),
    feedback_timestamp: feedbackTimestamp,
  },
});
```

[Source: docs/architecture/16-coding-standards.md:250-366]

### Character Limit Logic

**Why 500 Characters?**
- Encourages concise, actionable feedback
- Prevents abuse (long spam submissions)
- Reasonable for qualitative insights without overwhelming PMs
- Fits in database TEXT field efficiently

**Implementation:**
```typescript
// Character counter component
const charCount = feedbackText.length;
const isNearLimit = charCount > 450;

<p className={`text-xs ${isNearLimit ? 'text-red-600' : 'text-muted-foreground'}`}>
  {charCount}/500 characters
</p>
```

### Accessibility Requirements

**Keyboard Navigation** [Source: components/features/interpretation/FeedbackButtons.tsx:7-11]
- Tab to thumbs up/down buttons (existing)
- Tab to textarea (new)
- Tab to Submit button (new)
- Enter/Space to activate buttons (existing)
- Enter in textarea should NOT submit (only Submit button submits)

**ARIA Labels:**
```typescript
<Textarea
  aria-label="Optional text feedback"
  aria-describedby="char-counter"
  maxLength={500}
  autoFocus
/>

<p id="char-counter" className="text-xs">
  {charCount}/500 characters
</p>
```

**Screen Reader Support:**
- Textarea labeled clearly
- Character counter associated with textarea
- Submit button has clear label: "Submit Feedback"
- Success state announces "Feedback submitted successfully"

### Testing Strategy

**Unit Tests** [Source: docs/architecture/16-coding-standards.md:486-536]

Test file: `tests/unit/components/features/interpretation/FeedbackButtons.test.tsx`

**Existing Tests:**
- Initial state rendering âœ…
- Thumbs up/down API call âœ…
- Loading/success/error states âœ…
- Keyboard accessibility âœ…

**New Tests Required:**
1. Textarea appears after thumbs selection
2. Character counter displays correctly
3. Character counter turns red at 450+ chars
4. Text trimmed before submission
5. Submit with text sends correct payload
6. Submit without text sends NULL
7. Auto-focus behavior
8. Keyboard navigation to textarea and Submit button

**Integration Tests:**

Test file: `tests/integration/api/feedback.test.ts`

**New Tests Required:**
1. API accepts `feedback_text` under 500 chars
2. API rejects `feedback_text` over 500 chars
3. HTML sanitization works (strip tags)
4. Empty string converted to NULL
5. Backward compatibility (no `feedback_text` field)
6. Database stores text correctly
7. Database stores NULL when no text

**Testing Tools:**
- Vitest (test runner)
- React Testing Library (component tests)
- @testing-library/user-event (user interaction simulation)
- Mock fetch for API calls

[Source: docs/architecture/3-tech-stack.md:19-20]

### XSS Prevention

**Critical Security Requirement:**

User-provided text MUST be sanitized to prevent XSS attacks.

**Sanitization Strategy:**
1. Strip ALL HTML tags: `text.replace(/<[^>]*>/g, '')`
2. Encode special characters (< > & " ')
3. Never render user text as raw HTML (React escapes by default)
4. Server-side validation BEFORE database storage

**Why This is Safe:**
- Feedback text is NEVER rendered as HTML (only displayed as text)
- React automatically escapes text in JSX
- Database stores sanitized text only
- Admin dashboard (if exists) should also escape text

[Source: docs/prd/epic-7-user-feedback-text-collection.md:219]

### Mobile Considerations

**Touch Target Sizes:**
- Thumbs up/down buttons: `min-h-[44px] min-w-[44px]` (existing) âœ…
- Textarea: `min-h-[100px]` for comfortable typing
- Submit button: `min-h-[44px]` for touch accessibility

**Responsive Layout:**
- Textarea `w-full` fills container width
- Character counter below textarea (not inline on mobile)
- Submit button full width on mobile for easy tapping

**Keyboard Behavior:**
- iOS/Android keyboard appears when textarea focused
- Submit button remains visible above keyboard
- Auto-focus ensures smooth transition from thumbs to typing

### File Locations

**Files to Modify:**
1. `components/features/interpretation/FeedbackButtons.tsx` - Add textarea UI and logic
2. `app/api/feedback/route.ts` - Update validation and database call
3. `lib/types/models.ts` - Add/update FeedbackRequest and FeedbackResponse interfaces

**Files to Create/Update for Testing:**
1. `tests/unit/components/features/interpretation/FeedbackButtons.test.tsx` - Add new component tests
2. `tests/integration/api/feedback.test.ts` - Add API validation and integration tests

**Files Auto-Updated:**
- Prisma client types (already updated in Story 7.1)

### Backward Compatibility

**Critical Requirement:** Existing feedback flow MUST continue working.

**Verification Steps:**
1. Existing API requests without `feedback_text` field still work
2. Existing FeedbackButtons behavior unchanged (thumbs up/down only)
3. Existing tests pass without modification
4. Database queries handle NULL `feedback_text` gracefully
5. Idempotency rules unchanged (feedback immutable after first submission)

**Why This is Safe:**
- `feedback_text` is optional in Zod schema
- Database field is nullable (NULL = no text feedback)
- API treats missing field same as NULL
- UI shows textarea AFTER thumbs click (new step, doesn't replace existing flow)

### Component Interaction Flow

**State Machine:**

```
Initial State
  â””â”€> Thumbs Clicked
       â””â”€> Textarea Shown (showTextarea=true, selectedFeedback='up'/'down')
            â””â”€> User Types (optional, feedbackText updates)
                 â””â”€> Submit Clicked
                      â””â”€> API Call (isLoading=true)
                           â””â”€> Success â†’ Show Checkmark (submittedFeedback='up'/'down')
                           â””â”€> Error â†’ Show Error + Retry
```

**Edge Cases:**
1. User clicks thumbs, then clicks different thumbs â†’ Should change selectedFeedback, keep textarea
2. User types >500 chars â†’ maxLength prevents (HTML constraint)
3. User submits empty textarea â†’ feedbackText.trim() returns '', converted to NULL
4. API fails â†’ Show error, allow retry, preserve feedbackText value
5. User tries to submit feedback twice â†’ Idempotency check prevents (existing behavior)

---

## Testing

### Test File Locations

[Source: docs/architecture/16-coding-standards.md:486-498]

**Unit Tests:**
- `tests/unit/components/features/interpretation/FeedbackButtons.test.tsx` (existing, extend)

**Integration Tests:**
- `tests/integration/api/feedback.test.ts` (create or extend)

### Testing Standards

**Component Testing Pattern:**
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { FeedbackButtons } from '@/components/features/interpretation/FeedbackButtons';

it('should show textarea after thumbs up clicked', async () => {
  const user = userEvent.setup();
  render(<FeedbackButtons interpretationId="test-uuid" />);

  const thumbsUp = screen.getByLabelText(/Thumbs up/i);
  await user.click(thumbsUp);

  expect(screen.getByPlaceholderText(/Tell us more/i)).toBeInTheDocument();
  expect(screen.getByText(/0\/500 characters/i)).toBeInTheDocument();
});
```

**API Testing Pattern:**
```typescript
import { POST } from '@/app/api/feedback/route';
import { NextRequest } from 'next/server';

it('should accept feedback with text under 500 chars', async () => {
  const request = new NextRequest('http://localhost/api/feedback', {
    method: 'POST',
    body: JSON.stringify({
      interpretationId: 'test-uuid',
      feedback: 'up',
      feedback_text: 'This was very helpful, thank you!'
    }),
  });

  const response = await POST(request);
  const data = await response.json();

  expect(response.status).toBe(200);
  expect(data.success).toBe(true);
});
```

### Test Coverage Requirements

[Source: docs/architecture/16-coding-standards.md:537-551]

**This Story:**
- **Components:** 50%+ coverage (FeedbackButtons critical user interaction)
- **API Routes:** 60%+ coverage (feedback API enhanced)
- **Services Layer:** N/A (no new service logic)
- **Utilities:** 90%+ coverage (sanitization function)

**Test Categories:**
1. **Component Tests** (9 new tests)
   - Textarea appearance
   - Character counter logic
   - Keyboard navigation
   - Text trimming
   - Submit behavior

2. **API Validation Tests** (6 new tests)
   - Character limit enforcement
   - XSS sanitization
   - Empty string handling
   - Backward compatibility

3. **Integration Tests** (3 new tests)
   - Database storage verification
   - NULL handling
   - Atomic transaction

4. **Regression Tests** (1 verification)
   - Existing tests still pass

**Total: ~19 new tests + existing tests must pass**

### Manual Testing Checklist

Before marking story as "Done":
1. Click thumbs up â†’ verify textarea appears with auto-focus
2. Type 451 characters â†’ verify counter turns red
3. Submit with text â†’ verify success state
4. Submit without text â†’ verify NULL stored in DB
5. Test on mobile device (iOS/Android) â†’ verify keyboard and touch targets
6. Test keyboard navigation (Tab, Enter) â†’ verify accessibility
7. Test error state â†’ verify retry works
8. Verify existing feedback flow works without changes

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 1.0 | Initial story creation for Epic 7 - Feedback text collection UI and API | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by Dev Agent*

### Debug Log References

*To be filled by Dev Agent*

### Completion Notes

*To be filled by Dev Agent*

### File List

*To be filled by Dev Agent*

---

## QA Results

*This section will be populated by QA Agent after story completion.*
