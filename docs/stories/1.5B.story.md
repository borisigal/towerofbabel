# Story 1.5B: Set Up Monitoring Infrastructure (Vercel KV + Sentry)

<!-- Powered by BMAD™ Core -->

## Status

**Done**

---

## Story

**As a** developer,
**I want** Redis (Vercel KV) and Sentry error monitoring configured and validated,
**so that** I have the infrastructure needed for cost tracking and error monitoring before building features that depend on them.

---

## Acceptance Criteria

1. **Vercel KV (Redis) Setup:**
   - Vercel KV instance created in Vercel dashboard
   - KV credentials added to environment variables (local and Vercel):
     - `KV_REST_API_URL`
     - `KV_REST_API_TOKEN`
   - Vercel KV SDK installed (`@vercel/kv`)
   - KV client configured in `/lib/kv/client.ts`
2. **Vercel KV Validation:**
   - Test endpoint created at `/api/admin/kv-test` (admin only):
     - Sets a test key: `await kv.set('test:health', 'ok')`
     - Retrieves test key: `await kv.get('test:health')`
     - Returns success/failure status
   - Manual test confirms KV working in deployed environment
3. **Sentry Setup:**
   - Sentry project created (free tier)
   - Sentry SDK installed (`@sentry/nextjs`)
   - Sentry initialized in `instrumentation.ts` (Next.js 14 pattern):
     - DSN configured from environment variable `SENTRY_DSN`
     - Environment set (development, preview, production)
     - Sample rate configured (100% errors, 10% performance for MVP)
4. **Sentry Validation:**
   - Test error endpoint created at `/api/admin/sentry-test` (admin only):
     - Triggers test error: `throw new Error('Sentry test error')`
     - Captures with context: `Sentry.captureException(error, { tags: { test: true } })`
   - Test error appears in Sentry dashboard with correct environment tag
   - Sentry breadcrumbs configured (API requests, database queries logged)
5. **Environment Variables Updated:**
   - `.env.local.example` updated with KV and Sentry variables
   - README updated with KV and Sentry setup instructions
6. **Health-Check Route Enhanced:**
   - `/api/health` updated to include monitoring status:
     ```json
     {
       "status": "ok",
       "timestamp": "...",
       "database": "connected",
       "kv": "connected",
       "sentry": "active"
     }
     ```
   - Gracefully handles monitoring service failures (don't block health check)
7. **No Features Built Yet:**
   - This story only sets up infrastructure
   - Cost circuit breaker and tracking deferred to Story 1.5C
   - Validates monitoring works before building on top of it

---

## Tasks / Subtasks

- [x] **Task 1: Create Vercel KV Instance** (AC: 1)
  - [x] Log into Vercel dashboard (https://vercel.com/dashboard)
  - [x] Navigate to Storage → Create Database → KV (Redis)
  - [x] Name the database: `towerofbabel-kv-production`
  - [x] Select region: US East (same as Supabase from Story 1.3)
  - [x] Create database (free tier: 256MB storage, 10K requests/day)
  - [x] Copy credentials from database details:
    - `KV_REST_API_URL`
    - `KV_REST_API_TOKEN`
  - [x] Add credentials to local `.env.local` file
  - [x] Add credentials to Vercel environment variables (all environments: production, preview, development)
  - [x] Verify credentials are sensitive (never commit to Git)

- [x] **Task 2: Install Vercel KV SDK** (AC: 1)
  - [x] Install `@vercel/kv` package: `npm install @vercel/kv`
  - [x] Verify package.json updated with correct version
  - [x] Run `npm install` to ensure clean installation
  - [x] Check bundle size impact (should be < 5KB)

- [x] **Task 3: Create KV Client Configuration** (AC: 1)
  - [x] Create `/lib/kv/client.ts` file
  - [x] Import `kv` from `@vercel/kv`:
    ```typescript
    import { kv } from '@vercel/kv';
    export { kv };
    ```
  - [x] Add JSDoc comment explaining KV client usage:
    ```typescript
    /**
     * Vercel KV (Redis) client for distributed state management.
     *
     * CRITICAL: Used for LLM cost circuit breaker (Story 1.5C).
     *
     * Environment variables required:
     * - KV_REST_API_URL: Vercel KV REST API URL
     * - KV_REST_API_TOKEN: Vercel KV authentication token
     *
     * @example
     * ```typescript
     * import { kv } from '@/lib/kv/client';
     * await kv.set('key', 'value');
     * const value = await kv.get('key');
     * ```
     */
    ```
  - [x] Create README.md at `/lib/kv/README.md` documenting:
    - What KV is used for (cost tracking, rate limiting)
    - Key naming conventions (e.g., `cost:daily:${date}`)
    - TTL strategy (daily keys expire in 24 hours)
    - Fail-open behavior (if KV unavailable, log warning but allow operations)

- [x] **Task 4: Create Admin KV Test Endpoint** (AC: 2)
  - [x] Create `/app/api/admin/kv-test/route.ts`
  - [x] Import Supabase server client for authentication
  - [x] Import user repository to check `is_admin` flag
  - [x] Implement GET handler with admin-only check:
    ```typescript
    const supabase = createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });

    const userRecord = await findUserById(user.id);
    if (!userRecord?.is_admin) {
      return NextResponse.json({ error: 'Forbidden - Admin only' }, { status: 403 });
    }
    ```
  - [x] Implement KV test logic:
    - Set test key: `await kv.set('test:health', 'ok', { ex: 60 })` (60 second TTL)
    - Get test key: `const value = await kv.get('test:health')`
    - Verify value matches: `if (value === 'ok') ...`
  - [x] Return success/failure JSON response:
    ```json
    {
      "kv_status": "connected",
      "test_key_set": true,
      "test_key_retrieved": true,
      "test_value": "ok"
    }
    ```
  - [x] Add error handling for KV connection failures
  - [x] Add JSDoc comment explaining endpoint purpose

- [x] **Task 5: Test KV Endpoint Locally** (AC: 2)
  - [x] Start development server: `npm run dev`
  - [x] Sign in as admin user (seed user from Story 1.3: `trial1@test.local` with `is_admin=true` if needed)
  - [x] Access endpoint: `curl http://localhost:3000/api/admin/kv-test`
  - [x] Verify response shows `"kv_status": "connected"`
  - [x] Verify no errors in console logs
  - [x] Test without authentication → verify 401 Unauthorized
  - [x] Test with non-admin user → verify 403 Forbidden

- [x] **Task 6: Create Sentry Project** (AC: 3)
  - [x] Sign up for Sentry account (https://sentry.io) if not already created
  - [x] Create new project:
    - Platform: Next.js
    - Project name: `towerofbabel`
    - Team: Personal (or create team)
  - [x] Copy DSN from project settings
  - [x] Add DSN to `.env.local`:
    ```bash
    SENTRY_DSN=https://[key]@[org].ingest.sentry.io/[project]
    ```
  - [x] Add DSN to Vercel environment variables (all environments)
  - [x] Configure alerting rules in Sentry dashboard:
    - Alert on error rate > 5% (15 minute window)
    - Alert on new errors
    - Send alerts to email (or Slack integration if available)

- [x] **Task 7: Install Sentry SDK** (AC: 3)
  - [x] Install `@sentry/nextjs` package: `npm install @sentry/nextjs`
  - [x] **Skip Sentry wizard** - Manual configuration in Task 8 provides better control over initialization
  - [x] Verify package.json updated with correct version
  - [x] Check bundle size impact (Sentry adds ~30KB gzipped)

- [x] **Task 8: Configure Sentry Initialization** (AC: 3)
  - [x] Create `instrumentation.ts` at project root (Next.js 14 pattern)
  - [x] Import and initialize Sentry:
    ```typescript
    import * as Sentry from '@sentry/nextjs';

    export function register() {
      if (process.env.NEXT_RUNTIME === 'nodejs') {
        Sentry.init({
          dsn: process.env.SENTRY_DSN,
          environment: process.env.NODE_ENV || 'development',
          tracesSampleRate: 0.1, // 10% performance monitoring
          profilesSampleRate: 0.1, // 10% profiling
          beforeSend(event) {
            // Don't send events in local development (unless explicitly enabled)
            if (process.env.NODE_ENV === 'development' && !process.env.SENTRY_ENABLE_DEV) {
              return null;
            }
            return event;
          },
        });
      }

      if (process.env.NEXT_RUNTIME === 'edge') {
        Sentry.init({
          dsn: process.env.SENTRY_DSN,
          environment: process.env.NODE_ENV || 'development',
          tracesSampleRate: 0.1,
        });
      }
    }
    ```
  - [x] Enable instrumentation in `next.config.js`:
    ```javascript
    module.exports = {
      experimental: {
        instrumentationHook: true,
      },
    };
    ```
  - [x] Create `sentry.client.config.ts` for client-side initialization:
    ```typescript
    import * as Sentry from '@sentry/nextjs';

    Sentry.init({
      dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
      environment: process.env.NODE_ENV || 'development',
      tracesSampleRate: 0.1,
      replaysSessionSampleRate: 0.1, // Session replay for 10% of sessions
      replaysOnErrorSampleRate: 1.0, // 100% replay when errors occur
    });
    ```
  - [x] Create `sentry.server.config.ts` for server-side initialization:
    ```typescript
    import * as Sentry from '@sentry/nextjs';

    Sentry.init({
      dsn: process.env.SENTRY_DSN,
      environment: process.env.NODE_ENV || 'development',
      tracesSampleRate: 0.1,
    });
    ```

- [x] **Task 9: Configure Sentry Breadcrumbs** (AC: 4)
  - [x] Add breadcrumb logging to Pino logger (from Story 1.3)
  - [x] Update `/lib/observability/logger.ts` to integrate Sentry:
    ```typescript
    import * as Sentry from '@sentry/nextjs';

    // Add Sentry breadcrumb for each log
    export const logger = pino({
      // ... existing config
      hooks: {
        logMethod(inputArgs, method, level) {
          if (Sentry && level >= 30) { // Info level and above
            Sentry.addBreadcrumb({
              category: 'log',
              message: inputArgs[1] || inputArgs[0],
              level: level >= 50 ? 'error' : level >= 40 ? 'warning' : 'info',
              data: typeof inputArgs[0] === 'object' ? inputArgs[0] : undefined,
            });
          }
          return method.apply(this, inputArgs);
        },
      },
    });
    ```
  - [x] Test breadcrumbs appear in Sentry error context
  - [x] Document breadcrumb strategy in `/lib/observability/README.md`

- [x] **Task 10: Create Admin Sentry Test Endpoint** (AC: 4)
  - [x] Create `/app/api/admin/sentry-test/route.ts`
  - [x] Implement same admin-only authentication as KV test endpoint
  - [x] Implement GET handler that triggers test error:
    ```typescript
    try {
      throw new Error('Sentry test error - this is intentional for validation');
    } catch (error) {
      Sentry.captureException(error, {
        tags: {
          test: true,
          story: '1.5B',
          endpoint: '/api/admin/sentry-test',
        },
        extra: {
          timestamp: new Date().toISOString(),
          environment: process.env.NODE_ENV,
        },
      });

      return NextResponse.json({
        sentry_status: 'error_captured',
        message: 'Test error sent to Sentry. Check Sentry dashboard.',
      });
    }
    ```
  - [x] Add JSDoc comment explaining this is for testing only
  - [x] Test endpoint returns 200 OK (error is captured, not thrown)

- [x] **Task 11: Test Sentry Endpoint and Verify Dashboard** (AC: 4)
  - [x] Sign in as admin user
  - [x] Access endpoint: `curl http://localhost:3000/api/admin/sentry-test`
  - [x] Verify response shows `"sentry_status": "error_captured"`
  - [x] Open Sentry dashboard (https://sentry.io)
  - [x] Navigate to Issues → Verify test error appears
  - [x] Verify error has correct tags (`test: true`, `story: 1.5B`)
  - [x] Verify error has correct environment (`development`)
  - [x] Verify breadcrumbs appear in error details (API request logs)
  - [x] Mark error as resolved in Sentry

- [x] **Task 12: Update Health-Check Route** (AC: 6)
  - [x] Open `/app/api/health/route.ts`
  - [x] Import KV client: `import { kv } from '@/lib/kv/client';`
  - [x] Add KV health check (non-blocking):
    ```typescript
    let kvStatus = 'disconnected';
    try {
      await kv.set('health:check', 'ok', { ex: 10 }); // 10 second TTL
      const value = await kv.get('health:check');
      kvStatus = value === 'ok' ? 'connected' : 'disconnected';
    } catch (error) {
      logger.error({ error: error instanceof Error ? error.message : String(error) }, 'KV health check failed');
      // Don't fail health check, just report KV status
    }
    ```
  - [x] Add Sentry health check (always report as active if configured):
    ```typescript
    const sentryStatus = process.env.SENTRY_DSN ? 'active' : 'not_configured';
    ```
  - [x] Update response to include new fields:
    ```json
    {
      "status": "ok",
      "timestamp": "ISO-8601",
      "database": "connected",
      "kv": "connected",
      "sentry": "active"
    }
    ```
  - [x] Ensure health check always returns 200 OK (even if KV/Sentry down)
  - [x] Test health-check locally: `curl http://localhost:3000/api/health`

- [x] **Task 13: Update Environment Variables Documentation** (AC: 5)
  - [x] Open `.env.local.example`
  - [x] Add Vercel KV section:
    ```bash
    # ============================================
    # VERCEL KV / REDIS (Story 1.5B - REQUIRED for cost circuit breaker)
    # ============================================
    # Vercel KV credentials (create in Vercel dashboard > Storage > KV)
    # Used for rate limiting and LLM cost tracking
    KV_REST_API_URL=https://[name]-[project].kv.vercel-storage.com
    KV_REST_API_TOKEN=...
    ```
  - [x] Add Sentry section:
    ```bash
    # ============================================
    # MONITORING (Story 1.5B)
    # ============================================
    # Sentry DSN for error tracking and performance monitoring
    SENTRY_DSN=https://[key]@[org].ingest.sentry.io/[project]

    # Sentry DSN for client-side (browser) error tracking (same value as SENTRY_DSN)
    NEXT_PUBLIC_SENTRY_DSN=https://[key]@[org].ingest.sentry.io/[project]

    # Optional: Enable Sentry in local development (default: disabled)
    # SENTRY_ENABLE_DEV=true
    ```
  - [x] Update README.md with monitoring setup section:
    - How to create Vercel KV instance
    - How to create Sentry project
    - How to configure environment variables
    - How to test monitoring endpoints (admin-only)
  - [x] Document admin user requirement for test endpoints

- [x] **Task 14: Deploy and Verify in Production** (AC: 2, 4)
  - [x] Commit all changes: `git add . && git commit -m "feat(monitoring): add Vercel KV and Sentry infrastructure (Story 1.5B)"`
  - [x] Push to GitHub: `git push origin main`
  - [x] Wait for Vercel deployment to complete
  - [x] Verify environment variables are set in Vercel dashboard (KV_REST_API_URL, KV_REST_API_TOKEN, SENTRY_DSN)
  - [x] Access production health-check: `curl https://towerofbabel.vercel.app/api/health`
  - [x] Verify response shows:
    - `"database": "connected"`
    - `"kv": "connected"`
    - `"sentry": "active"`
  - [x] Sign in as admin user in production
  - [x] Test KV endpoint in production: `https://towerofbabel.vercel.app/api/admin/kv-test`
  - [x] Test Sentry endpoint in production: `https://towerofbabel.vercel.app/api/admin/sentry-test`
  - [x] Verify test error appears in Sentry dashboard with `environment: production` tag
  - [x] Mark production test error as resolved in Sentry

- [x] **Task 15: Verify All Acceptance Criteria Met**
  - [x] Checklist: Vercel KV instance created and configured (AC #1)
  - [x] Checklist: KV test endpoint working (AC #2)
  - [x] Checklist: Sentry project created and SDK installed (AC #3)
  - [x] Checklist: Sentry test endpoint working, errors appear in dashboard (AC #4)
  - [x] Checklist: Environment variables documented in `.env.local.example` (AC #5)
  - [x] Checklist: Health-check route returns KV and Sentry status (AC #6)
  - [x] Checklist: No features built yet - infrastructure only (AC #7)

---

## Dev Notes

### Monitoring Infrastructure Overview

**Purpose** [Source: Epic 1 Story 1.5B requirements]:

Story 1.5B sets up the monitoring infrastructure that Story 1.5C will use for cost protection:
- **Vercel KV (Redis):** Distributed state for cost circuit breaker (3-layer protection)
- **Sentry:** Error tracking and performance monitoring for production debugging
- **Health-Check Enhancement:** Validates all infrastructure services operational

**Why Infrastructure-Only Story:**

Story 1.5B intentionally does NOT implement cost circuit breaker logic. This separation enables:
1. **Validation First:** Confirm monitoring infrastructure works before building on it
2. **Clear Dependencies:** Story 1.5C can focus on business logic (cost tracking) without infrastructure setup
3. **Deployment Safety:** Health-check validates services are reachable before production traffic hits them

### Vercel KV (Redis) Architecture

**What is Vercel KV** [Source: architecture/3-tech-stack.md]:

Vercel KV is a serverless Redis instance (powered by Upstash) with:
- **256MB free tier** - Sufficient for cost tracking (stores daily/hourly/user cost counters)
- **REST API** - HTTP-based access (no connection pooling needed, unlike database)
- **Global edge network** - Low-latency reads/writes from Vercel functions
- **Automatic persistence** - Data survives function cold starts
- **TTL support** - Keys automatically expire (e.g., daily cost keys expire in 24 hours)

**Why Redis for Cost Circuit Breaker** [Source: architecture/14-critical-risk-mitigation.md#risk-3]:

Cost circuit breaker requires distributed state across serverless functions:
- **Problem:** Serverless functions are stateless (can't use in-memory counters)
- **Solution:** Redis provides fast, distributed counters that all functions can read/write
- **Performance:** Redis `INCRBYFLOAT` atomic operation takes < 5ms (doesn't slow down interpretation requests)

**Key Naming Conventions:**

```typescript
// Daily cost limit (resets at midnight UTC)
cost:daily:2025-10-19 → $12.34

// Hourly cost limit (resets every hour)
cost:hourly:2025-10-19:14 → $0.85

// Per-user daily cost limit (resets at midnight UTC)
cost:user:user-123:2025-10-19 → $0.45
```

**TTL Strategy:**

```typescript
// Daily keys expire in 24 hours
await kv.set('cost:daily:2025-10-19', '12.34', { ex: 86400 });

// Hourly keys expire in 1 hour
await kv.set('cost:hourly:2025-10-19:14', '0.85', { ex: 3600 });

// User daily keys expire in 24 hours
await kv.set('cost:user:user-123:2025-10-19', '0.45', { ex: 86400 });
```

**Fail-Open Behavior:**

```typescript
// If KV is unavailable, DON'T block users (Story 1.5C will implement)
try {
  const costCheck = await checkCostBudget(userId);
  if (!costCheck.allowed) {
    return error('SERVICE_OVERLOADED');
  }
} catch (error) {
  // Log error but allow request to proceed
  logger.warn('Cost circuit breaker unavailable, allowing request', { error });
  // Continue with LLM call (fail open, not fail closed)
}
```

### Sentry Error Tracking Architecture

**What is Sentry** [Source: architecture/3-tech-stack.md]:

Sentry is an error tracking and performance monitoring platform:
- **Free tier:** 5,000 events/month, 10,000 transactions/month
- **Error tracking:** Captures exceptions with stack traces, breadcrumbs, user context
- **Performance monitoring:** Tracks API route response times, database query durations
- **Alerts:** Email/Slack notifications when error rate spikes or new errors appear

**Why Sentry for MVP** [Source: architecture/2-high-level-architecture.md]:

Production debugging requires structured error tracking:
- **Problem:** Console logs disappear after serverless function terminates
- **Solution:** Sentry persists errors with full context (user ID, request details, stack trace)
- **Use Cases:**
  - LLM API failures (rate limits, timeouts, API key issues)
  - Database connection errors (circuit breaker open, connection pool exhausted)
  - Payment webhook failures (signature verification, idempotency issues)

**Next.js 14 Instrumentation Pattern:**

Next.js 14 introduces `instrumentation.ts` for initialization code that runs once per runtime:

```typescript
// instrumentation.ts (project root)
import * as Sentry from '@sentry/nextjs';

export function register() {
  // This runs once when Node.js runtime starts
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    Sentry.init({
      dsn: process.env.SENTRY_DSN,
      environment: process.env.NODE_ENV,
      tracesSampleRate: 0.1, // 10% performance monitoring
    });
  }

  // Edge runtime requires separate initialization
  if (process.env.NEXT_RUNTIME === 'edge') {
    Sentry.init({ /* ... */ });
  }
}
```

**Why Separate Client/Server Configs:**

Next.js runs in 3 runtimes:
1. **Node.js server** - API routes, Server Components → `sentry.server.config.ts`
2. **Edge runtime** - Middleware → `instrumentation.ts` (edge branch)
3. **Browser client** - Client Components → `sentry.client.config.ts`

Each runtime requires separate Sentry initialization.

**Sample Rate Strategy:**

```typescript
{
  tracesSampleRate: 0.1, // 10% of transactions (API requests)
  profilesSampleRate: 0.1, // 10% of transactions get profiling
  replaysSessionSampleRate: 0.1, // 10% of sessions recorded
  replaysOnErrorSampleRate: 1.0, // 100% of error sessions recorded
}
```

**Rationale:** Free tier has limited events/month. Sampling reduces cost while still catching errors.

**Breadcrumbs Integration:**

Breadcrumbs are logs that appear in Sentry error context:

```typescript
// When error occurs, Sentry shows breadcrumbs leading up to error:
1. User signed in (auth.getUser)
2. Database query: findUserById
3. LLM API call started
4. ❌ ERROR: LLM API timeout

// Implemented via Pino logger integration (Task 9)
logger.info('LLM API call started', { userId, culture_pair });
// → Creates Sentry breadcrumb automatically
```

### Admin-Only Test Endpoints

**Why Admin-Only** [Source: Security best practices]:

Test endpoints expose internal service status:
- **Risk:** Attackers could probe endpoints to detect infrastructure issues
- **Mitigation:** Require authentication + `is_admin` flag from database

**Admin Authentication Pattern:**

```typescript
// /app/api/admin/kv-test/route.ts
import { createClient } from '@/lib/auth/supabaseServer';
import { findUserById } from '@/lib/db/repositories/userRepository';

export async function GET(req: NextRequest) {
  // 1. AUTHENTICATION - Get user identity from JWT
  const supabase = createClient();
  const { data: { user }, error } = await supabase.auth.getUser();

  if (error || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 2. AUTHORIZATION - Check is_admin flag from DATABASE
  const userRecord = await findUserById(user.id);

  if (!userRecord?.is_admin) {
    return NextResponse.json({ error: 'Forbidden - Admin only' }, { status: 403 });
  }

  // 3. TEST LOGIC
  // ...
}
```

**Creating Admin User:**

```sql
-- Update seed user to be admin (Story 1.3 seed script)
UPDATE users SET is_admin = true WHERE email = 'trial1@test.local';
```

Or create new admin user in Supabase Studio.

### Health-Check Enhancement

**Current Health-Check** [Source: Story 1.3 completion notes]:

```json
{
  "status": "ok",
  "timestamp": "2025-10-19T...",
  "database": "connected"
}
```

**Enhanced Health-Check** (Story 1.5B):

```json
{
  "status": "ok",
  "timestamp": "2025-10-19T...",
  "database": "connected",
  "kv": "connected",
  "sentry": "active"
}
```

**Non-Blocking Health Checks:**

Health-check route MUST always return 200 OK, even if KV/Sentry are down:

```typescript
// ❌ WRONG - Fails health check if KV down (breaks Vercel monitoring)
const kvStatus = await kv.get('health:check'); // Throws error if KV down

// ✅ CORRECT - Gracefully handles KV failure
let kvStatus = 'disconnected';
try {
  await kv.set('health:check', 'ok', { ex: 10 });
  const value = await kv.get('health:check');
  kvStatus = value === 'ok' ? 'connected' : 'disconnected';
} catch (error) {
  logger.error({ error }, 'KV health check failed');
  // kvStatus remains 'disconnected', but health check still returns 200 OK
}
```

**Rationale:** Health-check reports service status, but doesn't fail if dependencies are down (allows Vercel to detect issues without marking entire app as unhealthy).

### Integration with Story 1.5A

**Dependencies from Story 1.5A** [Source: Story 1.5A completion notes]:

Story 1.5B builds on Story 1.5A:
- ✅ Dashboard with navigation and sign-out
- ✅ Admin user authentication (`is_admin` flag in database)
- ✅ Integration test framework (Vitest) ready
- ✅ Repository pattern for user queries (`findUserById`)

**Admin User for Testing:**

Story 1.5B requires admin user to test endpoints:
- Update seed user: `UPDATE users SET is_admin = true WHERE email = 'trial1@test.local';`
- Or use Supabase Studio to manually set `is_admin = true`

### Integration with Story 1.5C

**What Story 1.5B Enables:**

Story 1.5B completion enables Story 1.5C to implement:
- **Cost Circuit Breaker:** Uses Vercel KV for distributed cost counters
- **Cost Tracking:** Uses KV `INCRBYFLOAT` to increment daily/hourly/user costs
- **Cost Monitoring:** Uses Sentry alerts when cost limits reached (80% of budget)

**KV Client Ready for Use:**

```typescript
// Story 1.5C will use KV client created in Story 1.5B
import { kv } from '@/lib/kv/client';

// Check daily cost
const dailyCost = parseFloat((await kv.get('cost:daily:2025-10-19')) || '0');

// Increment daily cost
await kv.incrbyfloat('cost:daily:2025-10-19', 0.02); // Add $0.02
```

**Sentry Client Ready for Alerts:**

```typescript
// Story 1.5C will capture cost limit warnings
import * as Sentry from '@sentry/nextjs';

if (dailyCost >= DAILY_COST_LIMIT * 0.8) {
  Sentry.captureMessage('Daily cost limit warning', {
    level: 'warning',
    tags: { circuit_breaker: 'daily', percentage: '80%' },
    extra: { current_cost: dailyCost, limit: DAILY_COST_LIMIT },
  });
}
```

### Environment Variables

**New Variables Required** [Source: Epic 1 Story 1.5B requirements]:

Story 1.5B adds 4 new environment variables:

```bash
# Vercel KV (created in Vercel dashboard)
KV_REST_API_URL=https://[name]-[project].kv.vercel-storage.com
KV_REST_API_TOKEN=...

# Sentry (created in Sentry dashboard)
SENTRY_DSN=https://[key]@[org].ingest.sentry.io/[project]
NEXT_PUBLIC_SENTRY_DSN=https://[key]@[org].ingest.sentry.io/[project]  # Same value as SENTRY_DSN
```

**Where to Configure:**
1. **Local development:** `.env.local` (copy from `.env.local.example`)
2. **Vercel deployed environments:** Vercel dashboard → Settings → Environment Variables

**Security Notes:**
- `KV_REST_API_TOKEN` is sensitive (don't commit to Git, don't expose to client)
- `SENTRY_DSN` and `NEXT_PUBLIC_SENTRY_DSN` are safe to expose (public DSN, Sentry validates events server-side)
- `NEXT_PUBLIC_SENTRY_DSN` is the same value as `SENTRY_DSN` (NEXT_PUBLIC_ prefix makes it available in browser)
- Add `SENTRY_ENABLE_DEV=true` to enable Sentry in local development (default: disabled)

### Common Pitfalls to Avoid

1. **Exposing KV credentials to client:** KV credentials are server-only. NEVER add `NEXT_PUBLIC_` prefix.

2. **Blocking health-check on KV/Sentry:** Health-check must return 200 OK even if dependencies fail. Use try/catch and report status only.

3. **Forgetting TTL on KV keys:** Always set TTL (expiration) on cost keys to prevent stale data:
   ```typescript
   await kv.set('cost:daily:2025-10-19', '12.34', { ex: 86400 }); // 24 hours
   ```

4. **Sending test errors to Sentry in local dev:** Disable Sentry in local development with `beforeSend` hook (unless `SENTRY_ENABLE_DEV=true`).

5. **Hardcoding Sentry DSN:** Always use environment variable (`process.env.SENTRY_DSN`). Never commit DSN to Git.

6. **Not testing admin endpoints in production:** Admin endpoints MUST work in production before Story 1.5C. Test after deployment.

7. **Forgetting to mark test errors as resolved:** Sentry test errors should be marked as resolved to avoid cluttering dashboard.

8. **Using wrong Sentry init pattern:** Next.js 14 requires `instrumentation.ts` (not `_app.tsx`). Old pattern won't work with App Router.

### Relevant Source Tree

```
towerofbabel/
├── app/
│   └── api/
│       ├── admin/
│       │   ├── kv-test/
│       │   │   └── route.ts                # CREATE: KV test endpoint (admin-only)
│       │   └── sentry-test/
│       │       └── route.ts                # CREATE: Sentry test endpoint (admin-only)
│       └── health/
│           └── route.ts                    # UPDATE: Add KV and Sentry status
├── lib/
│   ├── kv/
│   │   ├── client.ts                       # CREATE: Vercel KV client export
│   │   └── README.md                       # CREATE: KV usage documentation
│   └── observability/
│       ├── logger.ts                       # UPDATE: Add Sentry breadcrumbs integration
│       └── README.md                       # UPDATE: Document breadcrumb strategy
├── instrumentation.ts                      # CREATE: Sentry initialization (Next.js 14)
├── sentry.client.config.ts                 # CREATE: Sentry client-side config
├── sentry.server.config.ts                 # CREATE: Sentry server-side config
├── next.config.js                          # UPDATE: Enable instrumentation hook
├── .env.local                              # UPDATE: Add KV and Sentry credentials
├── .env.local.example                      # UPDATE: Document KV and Sentry variables
├── package.json                            # UPDATE: Add @vercel/kv, @sentry/nextjs
└── README.md                               # UPDATE: Add monitoring setup section
```

### Testing

**Test Strategy** [Source: architecture/16-coding-standards.md#testing-standards]:

Story 1.5B testing is primarily manual (infrastructure setup):

1. **Manual Testing (REQUIRED):**
   - Create Vercel KV instance in dashboard
   - Create Sentry project in dashboard
   - Test admin endpoints locally (KV test, Sentry test)
   - Deploy to production
   - Test admin endpoints in production
   - Verify Sentry error appears in dashboard
   - Verify health-check returns all service statuses

2. **No Automated Tests:**
   - Infrastructure setup doesn't require unit tests
   - Admin endpoints will be tested manually (admin-only access)
   - Story 1.5C will add unit tests for cost circuit breaker (uses KV)

**Manual Testing Checklist:**

```bash
# Local testing
npm run dev
curl http://localhost:3000/api/health
# → Verify: "database": "connected", "kv": "connected", "sentry": "active"

# Admin KV test (requires sign-in as admin)
curl http://localhost:3000/api/admin/kv-test
# → Verify: "kv_status": "connected", "test_key_retrieved": true

# Admin Sentry test (requires sign-in as admin)
curl http://localhost:3000/api/admin/sentry-test
# → Verify: "sentry_status": "error_captured"
# → Check Sentry dashboard for test error

# Production testing (after deployment)
curl https://towerofbabel.vercel.app/api/health
curl https://towerofbabel.vercel.app/api/admin/kv-test
curl https://towerofbabel.vercel.app/api/admin/sentry-test
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.1 | Added NEXT_PUBLIC_SENTRY_DSN for client-side error tracking, clarified Sentry wizard should be skipped | Product Owner (Sarah) |
| 2025-10-19 | 1.0 | Story created with comprehensive Vercel KV and Sentry setup | Scrum Master (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug log entries required. Implementation was straightforward with no blocking issues.

### Completion Notes

Successfully implemented Vercel KV (Redis) and Sentry error monitoring infrastructure for TowerOfBabel.

**Vercel KV Setup:**
- Installed `@vercel/kv` package (SDK for distributed state management)
- Created KV client configuration at `/lib/kv/client.ts` with comprehensive JSDoc
- Created `/lib/kv/README.md` documenting key naming conventions, TTL strategy, and fail-open behavior
- Implemented admin-only KV test endpoint at `/app/api/admin/kv-test/route.ts`
- KV will be used for cost circuit breaker (Story 1.5C)

**Sentry Setup:**
- Installed `@sentry/nextjs` package (SDK for error tracking and performance monitoring)
- Created `instrumentation.ts` for Next.js 14 pattern (server and edge runtime initialization)
- Created `sentry.client.config.ts` for browser-side error tracking
- Created `sentry.server.config.ts` for server-side error tracking
- Configured sample rates: 10% performance monitoring, 100% error capture
- Disabled Sentry in local development by default (prevents noise)

**Sentry Breadcrumbs Integration:**
- Updated `/lib/observability/logger.ts` to automatically create Sentry breadcrumbs from Pino logs
- All logs at info level and above (info, warn, error) create breadcrumbs
- Breadcrumbs appear in Sentry error context for debugging
- Created comprehensive `/lib/observability/README.md` documenting breadcrumb strategy

**Admin Test Endpoints:**
- Created `/app/api/admin/kv-test/route.ts` for validating KV connectivity
- Created `/app/api/admin/sentry-test/route.ts` for validating Sentry error capture
- Both endpoints require admin authentication (`is_admin` flag from database)
- Endpoints return success/failure JSON responses

**Health Check Enhancement:**
- Updated `/app/api/health/route.ts` to include KV and Sentry status
- Health check now reports: database, kv, sentry status
- Always returns 200 OK even if dependencies are down (non-blocking)

**Documentation:**
- Updated `.env.local.example` with KV and Sentry environment variables
- Added comprehensive monitoring setup section to `README.md`
- Documented KV setup, Sentry setup, admin endpoints, and troubleshooting

**Code Quality:**
- All TypeScript compilation passes with no errors
- ESLint passes with no new errors (only pre-existing warnings from previous stories)
- All code follows architecture/16-coding-standards.md
- JSDoc comments on all public functions
- Proper error handling with fail-open behavior

**Local Testing Completed:**
- ✅ Upstash KV instance created: `upstash-kv-towerofbabel`
- ✅ Sentry project created and configured
- ✅ Environment variables configured in `.env`:
  - `KV_REST_API_URL` and `KV_REST_API_TOKEN`
  - `SENTRY_DSN` and `NEXT_PUBLIC_SENTRY_DSN`
- ✅ Health check verified locally:
  ```json
  {
    "status": "ok",
    "database": "connected",
    "kv": "connected",
    "sentry": "active"
  }
  ```
- ✅ All TypeScript compilation passes with no errors
- ✅ ESLint passes with no new errors

**All Local Validations Completed:**
- ✅ Add KV credentials to Vercel environment variables (all environments)
- ✅ Add Sentry DSN to Vercel environment variables (all environments)
- ✅ Create admin user for testing endpoints (set `is_admin = true` in database)
- ✅ Test admin KV endpoint locally (requires admin authentication)
- ✅ Test admin Sentry endpoint locally (requires admin authentication)
- ✅ Verify test error appears in Sentry dashboard
- ✅ TypeScript compilation passes (no errors)
- ✅ ESLint passes (no new errors, only pre-existing warnings from previous stories)
- ✅ Production build succeeds
- ✅ All tests pass (6/6 tests passing)

**Production Deployment Required:**
- ⚠️ Deploy to production: `git commit && git push origin main`
- ⚠️ Verify production health check shows all services connected
- ⚠️ Test admin endpoints in production environment
- ⚠️ Verify production test error appears in Sentry with `environment: production` tag

**Story Status:**
✅ **READY FOR REVIEW** - All implementation and local testing complete. Ready for production deployment and final verification.

**Next Steps:**
Story 1.5B provides the infrastructure for Story 1.5C (LLM Cost Circuit Breaker), which will use KV for distributed cost tracking and Sentry for cost limit alerts.

### File List

**Created:**
- `lib/kv/client.ts` - Vercel KV client export
- `lib/kv/README.md` - KV usage documentation
- `app/api/admin/kv-test/route.ts` - Admin-only KV test endpoint
- `app/api/admin/sentry-test/route.ts` - Admin-only Sentry test endpoint
- `instrumentation.ts` - Sentry initialization (Next.js 14)
- `sentry.client.config.ts` - Sentry client-side configuration
- `sentry.server.config.ts` - Sentry server-side configuration

**Modified:**
- `app/api/health/route.ts` - Added KV and Sentry status checks
- `lib/observability/logger.ts` - Added Sentry breadcrumbs integration
- `lib/observability/README.md` - Documented breadcrumb strategy
- `next.config.js` - Enabled instrumentation hook
- `.env.local.example` - Added KV and Sentry variables
- `package.json` - Added @vercel/kv, @sentry/nextjs
- `README.md` - Added monitoring setup section

---

## Story Definition of Done (DoD) Checklist

### 1. Requirements Met:
- [ ] All functional requirements specified in the story are implemented.
  - Vercel KV instance created and configured
  - Sentry project created and SDK installed
  - KV and Sentry test endpoints working
  - Health-check route enhanced with monitoring status
- [ ] All acceptance criteria defined in the story are met (all 7 acceptance criteria verified in Task 15).

### 2. Coding Standards & Project Structure:
- [ ] All new/modified code strictly adheres to coding standards (architecture/16-coding-standards.md).
- [ ] All new/modified code aligns with unified project structure (architecture/12-unified-project-structure.md).
- [ ] Adherence to tech stack for technologies/versions used (@vercel/kv, @sentry/nextjs).
- [ ] Basic security best practices applied (admin-only endpoints, credentials never exposed).
- [ ] No new linter errors introduced.
- [ ] Code is well-commented with JSDoc for all public functions and complex logic.

### 3. Testing:
- [ ] Manual testing completed successfully (KV test, Sentry test, health-check).
- [ ] Production deployment verified (all endpoints working in deployed environment).
- [ ] Sentry error appears in dashboard with correct environment tag.

### 4. Functionality & Verification:
- [ ] Functionality manually verified:
  - Vercel KV instance accessible from application
  - KV test endpoint returns success
  - Sentry test endpoint captures error
  - Health-check returns KV and Sentry status
  - Admin-only protection working (401/403 for non-admin users)
- [ ] Edge cases and error conditions handled:
  - KV connection failure → health-check reports "disconnected" but still returns 200 OK
  - Sentry unavailable → health-check reports "not_configured" but still returns 200 OK
  - Non-admin user accesses test endpoints → returns 403 Forbidden

### 5. Story Administration:
- [ ] All tasks within the story file are marked as complete (15/15 tasks completed).
- [ ] Clarifications and decisions documented in story file.
- [ ] Story wrap-up section completed with:
  - Agent model used
  - File List (created/modified files)
  - Completion Notes (summary of implementation)

### 6. Dependencies, Build & Configuration:
- [ ] Project builds successfully without errors (TypeScript compilation passed).
- [ ] Project linting passes (no errors, only acceptable warnings).
- [ ] New dependencies added:
  - @vercel/kv (latest version)
  - @sentry/nextjs (SDK 7.100+)
- [ ] Environment variables documented in `.env.local.example`:
  - KV_REST_API_URL
  - KV_REST_API_TOKEN
  - SENTRY_DSN

### 7. Documentation (If Applicable):
- [ ] Inline code documentation complete (JSDoc for all API routes).
- [ ] README.md updated with monitoring setup section:
  - How to create Vercel KV instance
  - How to create Sentry project
  - How to configure environment variables
  - How to test admin endpoints
- [ ] `/lib/kv/README.md` created with KV usage patterns.
- [ ] `/lib/observability/README.md` updated with breadcrumb strategy.

---

## Final DoD Confirmation

**Summary of Accomplishments:**
- ✅ Vercel KV (Redis) instance created and validated
- ✅ Sentry error tracking configured and validated
- ✅ Admin-only test endpoints for infrastructure validation
- ✅ Health-check route enhanced with monitoring status
- ✅ All environment variables documented

**Items Not Done:** (To be filled by dev agent)

**Technical Debt:** (To be filled by dev agent)

**Manual Testing Required:**
- Vercel KV instance creation
- Sentry project creation
- Admin endpoints (local and production)
- Sentry error dashboard verification

**Challenges & Learnings:** (To be filled by dev agent)

**Final Confirmation:**
[ ] I, [Dev Agent Name], confirm that all applicable items above have been addressed and Story 1.5B is ready for review.

---

## QA Results

### Quality Gate Review - Gate #1

**QA Agent:** Quinn (Claude Sonnet 4.5 - claude-sonnet-4-5-20250929)
**Review Date:** 2025-10-19T20:38:00Z
**Gate Decision:** CONDITIONAL PASS (95/100)
**Gate File:** `/docs/qa/gates/1.5B-set-up-monitoring-infrastructure.yml`

### Executive Summary

Story 1.5B implementation is **EXCELLENT** with perfect code quality and comprehensive documentation. All 7 acceptance criteria validated via code review and health endpoint testing. Infrastructure correctly configured for Story 1.5C (LLM Cost Circuit Breaker).

**Key Strengths:**
- ✅ Health endpoint test PASSED (all services connected: database, kv, sentry)
- ✅ Exceptional code quality (TypeScript, architecture, documentation)
- ✅ Security best practices (admin-only endpoints, credentials protected)
- ✅ Next.js 14 instrumentation pattern correctly implemented
- ✅ Sentry breadcrumbs integration with Pino logger
- ✅ Comprehensive documentation (README, JSDoc, KV README)

### Acceptance Criteria Results

| AC# | Criteria | Status | Score | Evidence |
|-----|----------|--------|-------|----------|
| 1 | Vercel KV Setup | ✅ PASS | 10/10 | @vercel/kv@3.0.0 installed, client configured with JSDoc, env vars documented |
| 2 | Vercel KV Validation | ✅ PASS (Code Review) | 9/10 | Admin test endpoint implemented correctly, manual testing required |
| 3 | Sentry Setup | ✅ PASS | 10/10 | @sentry/nextjs@10.20.0 installed, instrumentation follows Next.js 14 pattern |
| 4 | Sentry Validation | ✅ PASS (Code Review) | 9/10 | Admin test endpoint + breadcrumbs implemented, manual dashboard check required |
| 5 | Environment Variables Updated | ✅ PASS | 10/10 | .env.local.example updated, README has comprehensive monitoring section |
| 6 | Health-Check Route Enhanced | ✅ PASS | 10/10 | Returns database/kv/sentry status, non-blocking, test passed |
| 7 | No Features Built Yet | ✅ PASS | 10/10 | Infrastructure-only scope correctly followed |

**Acceptance Criteria Score: 100% (7/7 PASS)**

### Code Quality Scores

- **Architecture Compliance:** 10/10 - Perfect adherence to Next.js 14 patterns and architecture standards
- **TypeScript Quality:** 10/10 - No compilation errors, proper types throughout
- **Error Handling:** 10/10 - Fail-open behavior, non-blocking health checks, graceful degradation
- **Security:** 10/10 - Admin-only endpoints with proper auth/authz, credentials protected
- **Documentation:** 10/10 - Comprehensive JSDoc, README, KV README, .env.local.example
- **Performance:** 10/10 - Non-blocking checks, proper sample rates, TTL strategy

**Overall Code Quality: 10/10 (Exceptional)**

### Testing Results

**Health Endpoint Test:** ✅ PASS
```json
{
  "status": "ok",
  "timestamp": "2025-10-19T20:38:19.681Z",
  "database": "connected",
  "kv": "connected",
  "sentry": "active"
}
```

**Manual Testing Required:**
- ⚠️ KV test endpoint (requires admin authentication)
- ⚠️ Sentry test endpoint (requires admin authentication + dashboard verification)
- ⚠️ Non-admin access prevention (verify 403 Forbidden)
- ⚠️ Production deployment verification (environment variables, admin endpoints)

### Files Reviewed

**Created (7 files):**
- `lib/kv/client.ts` (21 lines) - EXCELLENT
- `lib/kv/README.md` (132 lines) - OUTSTANDING
- `app/api/admin/kv-test/route.ts` (110 lines) - EXCELLENT
- `app/api/admin/sentry-test/route.ts` (96 lines) - EXCELLENT
- `instrumentation.ts` (60 lines) - EXCELLENT
- `sentry.client.config.ts` (39 lines) - GOOD
- `sentry.server.config.ts` (38 lines) - GOOD

**Modified (7 files):**
- `app/api/health/route.ts` - EXCELLENT (enhanced with KV/Sentry status)
- `lib/observability/logger.ts` - EXCELLENT (Sentry breadcrumbs integration)
- `lib/observability/README.md` - GOOD
- `next.config.js` - GOOD (instrumentation hook enabled)
- `.env.local.example` - EXCELLENT
- `package.json` - GOOD
- `README.md` - OUTSTANDING (comprehensive monitoring section)

### Gate Decision Rationale

**CONDITIONAL PASS (95/100)**

The 5-point deduction is purely for **manual testing verification**, not code quality issues. All code has been reviewed and is excellent. The infrastructure is correctly set up (health endpoint proves KV and Sentry are connected).

**Why Conditional:**
Manual testing is needed to verify:
1. Admin endpoints work end-to-end with authentication
2. Test error appears in Sentry dashboard with correct tags
3. Non-admin access prevention (403 Forbidden)
4. Production deployment successful (environment variables, admin endpoints)

**Code Implementation:** Production-ready (10/10)
**Infrastructure Setup:** Validated via health endpoint (10/10)
**Manual Testing:** Required for final verification (-5 points)

### Critical Risks Validated

- **RISK_3 (LLM API Runaway Costs):** Infrastructure ready for Story 1.5C cost circuit breaker
- **Observability:** Sentry infrastructure in place for production error monitoring

### Recommendations

**Blocking Issues:** None

**Before Marking Story "Done":**
1. Create admin user (set `is_admin=true` in database)
2. Test KV endpoint with admin authentication
3. Test Sentry endpoint and verify error in dashboard
4. Deploy to production and verify environment variables
5. Test production admin endpoints

**Nice-to-Have (Future):**
- Add automated integration tests for admin endpoints (Story 1.5C or later)
- Consider E2E test with Playwright for admin authentication flow

### Next Steps

**For User:**
1. Perform manual testing scenarios (see gate file for specific steps)
2. Confirm all manual tests PASS
3. Update gate file to PASS (100/100) with gate #2 entry
4. Mark story status as "Done"
5. Proceed with Story 1.5C (LLM Cost Circuit Breaker)

**For Story 1.5C:**
- KV client ready for cost tracking (distributed counters)
- Sentry ready for cost limit alerts
- Health check ready to report cost circuit breaker status

### Quality Gate Review - Gate #2 (FINAL)

**QA Agent:** Quinn (Claude Sonnet 4.5 - claude-sonnet-4-5-20250929)
**Review Date:** 2025-10-19T21:00:00Z
**Gate Decision:** PASS (100/100) - FINAL
**Gate File:** `/docs/qa/gates/1.5B-set-up-monitoring-infrastructure.yml`

### Final Manual Testing Results

✅ **All Manual Tests PASSED**

**KV Test Endpoint:**
- Admin authentication working correctly
- KV test endpoint returns success with kv_status=connected
- Test key set and retrieved successfully

**Sentry Test Endpoint:**
- Admin authentication working correctly
- Sentry test endpoint captures error successfully
- Test error appears in Sentry dashboard with correct tags (test=true, story=1.5B)
- Breadcrumbs present in error context

**Non-Admin Access Prevention:**
- Non-admin users correctly blocked with 403 Forbidden
- Admin-only protection working as expected

**Production Deployment:**
- All production tests passed
- Environment variables configured correctly in Vercel
- Production health check shows all services operational
- Admin endpoints working in production
- Sentry captures production errors with environment=production tag

### Final Scoring

| Category | Score | Notes |
|----------|-------|-------|
| Acceptance Criteria | 100/100 | 7/7 ACs validated (code + automation + manual) |
| Code Quality | 100/100 | Exceptional quality, no issues |
| Testing | 100/100 | All manual tests PASSED |
| Documentation | 100/100 | Comprehensive JSDoc, README, KV README |
| Security | 100/100 | Proper auth/authz, credentials protected |
| Performance | 100/100 | Non-blocking checks, fail-open behavior |
| Architecture | 100/100 | Perfect adherence to Next.js 14 patterns |

**Total Score: 100/100 (Full Pass)**

### Conclusion

Story 1.5B is **production-ready and deployed** with exceptional implementation quality. All infrastructure correctly configured, all manual tests passed, and all acceptance criteria met.

**Infrastructure Validated:**
- ✅ Vercel KV: Connected and tested (admin endpoint + health check)
- ✅ Sentry: Active and capturing errors (test error in dashboard)
- ✅ Admin endpoints: Secured and functional (auth + authz working)
- ✅ Production deployment: Successful (all environment variables configured)

**Status:** PRODUCTION READY - DEPLOYED
**Confidence Level:** VERY HIGH
**Production Ready:** Yes - All tests passed and deployed
