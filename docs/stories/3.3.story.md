# Story 3.3: Create Upgrade Modal with Pricing Tiers

<!-- Powered by BMADâ„¢ Core -->

## Status

**Approved**

**PO Validation Date:** 2025-10-24
**Validation Score:** 9.5/10 (Excellent)
**Implementation Notes:**
- Task 5 includes all modal trigger integrations (InterpretationForm, UsageNotificationBanner)
- Use vertical stack layout for pricing cards (better readability in 600px modal)
- Enhanced test coverage (60%+ of tasks are testing)

---

## Story

**As a** user,
**I want** to see pricing options when I hit my limit,
**so that** I can choose to subscribe to Pro or pay-per-use to continue using the service.

---

## Acceptance Criteria

1. Upgrade modal triggered when limit exceeded (displayed automatically on interpretation attempt)
2. Modal displays three pricing options:
   - **Free Trial:** "14 days, 10 messages (expired or used up)"
   - **Pay-As-You-Go:** "$0.50 per interpretation, billed monthly" with "Start Pay-As-You-Go" CTA button
   - **Pro:** "$10/month for [TBD] messages" with "Subscribe to Pro" CTA button (primary recommendation)
3. Modal includes brief value proposition: "Continue interpreting cross-cultural messages with unlimited confidence"
4. "Subscribe to Pro" button redirects to Lemon Squeezy Checkout (Story 3.4)
5. "Start Pay-As-You-Go" button creates PAYG usage-based subscription via Lemon Squeezy (Story 3.4)
6. Modal dismissible with "Maybe later" or close button (but user still can't interpret until upgraded)
7. Modal also accessible from navigation menu ("Upgrade" link) for proactive upgrades
8. Modal responsive (readable on mobile, tablet, desktop)
9. Copy emphasizes speed and accuracy value prop vs. free ChatGPT
10. TBD message limit shown as placeholder "[X]" until Week 1 benchmarking determines value
11. PAYG description clarifies: "Use as much as you need, pay only for what you use at month-end"

---

## Tasks / Subtasks

- [ ] **Task 1: Install shadcn/ui Dialog Component** (AC: 1, 6, 8)
  - [ ] Run: `npx shadcn@latest add dialog`
  - [ ] Verify dialog component installed in `/components/ui/dialog.tsx`
  - [ ] Verify supporting components (DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter, DialogTrigger)
  - [ ] Test basic dialog open/close behavior
  - [ ] Verify responsive behavior (mobile/tablet/desktop)

- [ ] **Task 2: Create UpgradeModal Component** (AC: 1, 2, 3, 6, 8)
  - [ ] Create `/components/features/upgrade/UpgradeModal.tsx`
  - [ ] Make it a Client Component (`'use client'`)
  - [ ] Define component props interface:
    ```typescript
    interface UpgradeModalProps {
      open: boolean;
      onOpenChange: (open: boolean) => void;
      trigger: 'limit_exceeded' | 'proactive' | 'notification_banner';
      currentTier: 'trial' | 'payg' | 'pro';
      messagesUsed?: number;
      messagesLimit?: number;
    }
    ```
  - [ ] Use shadcn/ui Dialog components:
    ```tsx
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle>Upgrade Your Plan</DialogTitle>
          <DialogDescription>
            Continue interpreting cross-cultural messages with unlimited confidence
          </DialogDescription>
        </DialogHeader>
        {/* Pricing tiers */}
        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Maybe Later
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
    ```
  - [ ] Add responsive styles (mobile: full screen, desktop: centered modal)
  - [ ] Add WCAG 2.1 AA compliance (keyboard navigation, focus trap, ARIA labels)
  - [ ] Add JSDoc documentation [Source: docs/architecture/16-coding-standards.md#jsdoc-for-public-apis]

- [ ] **Task 3: Create PricingCard Component** (AC: 2, 9, 10, 11)
  - [ ] Create `/components/features/upgrade/PricingCard.tsx`
  - [ ] Make it a Client Component (`'use client'`)
  - [ ] Define component props interface:
    ```typescript
    interface PricingCardProps {
      tier: 'trial' | 'payg' | 'pro';
      title: string;
      price: string;
      description: string;
      features: string[];
      ctaText: string;
      ctaVariant: 'default' | 'outline' | 'secondary';
      recommended?: boolean;
      onCtaClick: () => void;
      disabled?: boolean;
    }
    ```
  - [ ] Implement card layout with:
    - Header: Tier name + "Recommended" badge (if applicable)
    - Pricing: Large price text (e.g., "$10/month")
    - Description: Tier-specific subtitle
    - Features list: Bullet points with checkmarks
    - CTA button: Primary action
  - [ ] Add "Recommended" badge for Pro tier:
    ```tsx
    {recommended && (
      <span className="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">
        Recommended
      </span>
    )}
    ```
  - [ ] Style with Tailwind for visual hierarchy
  - [ ] Add hover effects for interactive cards
  - [ ] Add JSDoc documentation

- [ ] **Task 4: Populate Pricing Tiers Content** (AC: 2, 9, 10, 11)
  - [ ] Create pricing tier configuration object in UpgradeModal:
    ```typescript
    const pricingTiers = {
      trial: {
        title: 'Free Trial',
        price: 'Free',
        description: '14 days, 10 messages',
        features: [
          'Expired or used up',
          'Limited to 10 interpretations',
          'Cross-cultural messaging insights'
        ],
        ctaText: 'Current Plan',
        ctaVariant: 'outline' as const,
        disabled: true
      },
      payg: {
        title: 'Pay-As-You-Go',
        price: '$0.50',
        priceSubtext: 'per interpretation',
        description: 'Use as much as you need, pay only for what you use at month-end',
        features: [
          'No upfront commitment',
          'Billed monthly for usage',
          'Perfect for occasional use',
          '10x faster than ChatGPT'
        ],
        ctaText: 'Start Pay-As-You-Go',
        ctaVariant: 'secondary' as const
      },
      pro: {
        title: 'Pro',
        price: '$10/month',
        description: `${getProMessageLimit()} messages per month`,
        features: [
          `${getProMessageLimit()} interpretations/month`,
          'Monthly usage resets automatically',
          'Best value for regular use',
          '10x faster & more accurate than ChatGPT',
          'Priority support'
        ],
        ctaText: 'Subscribe to Pro',
        ctaVariant: 'default' as const,
        recommended: true
      }
    };

    function getProMessageLimit(): string {
      const limit = process.env.NEXT_PUBLIC_PRO_MESSAGE_LIMIT;
      return limit || '[X]';  // Placeholder until benchmarking
    }
    ```
  - [ ] Add value proposition copy emphasizing speed and accuracy vs ChatGPT
  - [ ] Use environment variable for Pro message limit (TBD)

- [ ] **Task 5: Implement Modal Trigger Logic** (AC: 1, 7)
  - [ ] Create Zustand store for modal state: `/lib/stores/upgradeModalStore.ts`
    ```typescript
    interface UpgradeModalState {
      open: boolean;
      trigger: 'limit_exceeded' | 'proactive' | 'notification_banner';
      setOpen: (open: boolean, trigger?: UpgradeModalState['trigger']) => void;
    }

    export const useUpgradeModalStore = create<UpgradeModalState>((set) => ({
      open: false,
      trigger: 'proactive',
      setOpen: (open, trigger = 'proactive') => set({ open, trigger }),
    }));
    ```
  - [ ] Modify `/components/features/interpretation/InterpretationForm.tsx`:
    ```typescript
    import { useUpgradeModalStore } from '@/lib/stores/upgradeModalStore';

    export function InterpretationForm() {
      const { setOpen } = useUpgradeModalStore();

      const handleSubmit = async (data: FormData) => {
        try {
          const response = await fetch('/api/interpret', { ... });

          if (response.status === 403) {
            const error = await response.json();
            if (error.error.code === 'LIMIT_EXCEEDED' || error.error.code === 'TRIAL_EXPIRED') {
              setOpen(true, 'limit_exceeded');  // Open upgrade modal automatically
            }
          }
        } catch (error) {
          // Handle network errors
        }
      };
    }
    ```
  - [ ] Modify `/components/features/dashboard/UsageNotificationBanner.tsx`:
    ```typescript
    import { useUpgradeModalStore } from '@/lib/stores/upgradeModalStore';

    export function UsageNotificationBanner() {
      const { setOpen } = useUpgradeModalStore();

      return (
        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4">
          <p>You've used 8 of 10 trial messages.</p>
          <button
            onClick={() => setOpen(true, 'notification_banner')}
            className="underline text-blue-600 hover:text-blue-700"
          >
            Upgrade Now
          </button>
        </div>
      );
    }
    ```
  - [ ] Test all three trigger sources open the modal correctly
  - [ ] Verify trigger type is set correctly for analytics tracking

- [ ] **Task 6: Add Upgrade Link to DashboardNav** (AC: 7)
  - [ ] Modify `/components/layout/DashboardNav.tsx`
  - [ ] Add "Upgrade" link to navigation menu
  - [ ] Only show for trial users or users approaching limit
  - [ ] Click handler opens UpgradeModal:
    ```tsx
    import { useUpgradeModalStore } from '@/lib/stores/upgradeModalStore';

    export function DashboardNav() {
      const { setOpen } = useUpgradeModalStore();
      const { tier } = useUsageStore();

      return (
        <nav>
          {tier !== 'pro' && (
            <button
              onClick={() => setOpen(true, 'proactive')}
              className="text-blue-600 hover:text-blue-700"
            >
              Upgrade
            </button>
          )}
        </nav>
      );
    }
    ```
  - [ ] Style upgrade link with visual prominence (blue color, icon)
  - [ ] Test keyboard navigation

- [ ] **Task 7: Integrate Modal into Dashboard Page** (AC: 1)
  - [ ] Modify `/app/(dashboard)/page.tsx`
  - [ ] Import and render UpgradeModal:
    ```tsx
    import { UpgradeModal } from '@/components/features/upgrade/UpgradeModal';
    import { useUpgradeModalStore } from '@/lib/stores/upgradeModalStore';
    import { useUsageStore } from '@/lib/stores/usageStore';

    export default function DashboardPage() {
      const { open, trigger, setOpen } = useUpgradeModalStore();
      const { tier, messagesUsed, messagesLimit } = useUsageStore();

      return (
        <>
          <DashboardContent />
          <UpgradeModal
            open={open}
            onOpenChange={setOpen}
            trigger={trigger}
            currentTier={tier}
            messagesUsed={messagesUsed}
            messagesLimit={messagesLimit}
          />
        </>
      );
    }
    ```
  - [ ] Ensure modal renders at root level (not nested in content)
  - [ ] Test modal open/close behavior from different triggers

- [ ] **Task 8: Create Placeholder CTA Handlers for Lemon Squeezy Integration** (AC: 4, 5)
  - [ ] Import useToast hook: `import { useToast } from '@/components/ui/use-toast';`
  - [ ] Import useState for loading state: `import { useState } from 'react';`
  - [ ] In UpgradeModal, create handler functions:
    ```typescript
    const handleSubscribeToPro = async () => {
      // TODO: Story 3.4 - Create Lemon Squeezy checkout session
      console.log('Subscribe to Pro clicked');
      // Placeholder: Show toast message
      toast({
        title: 'Coming Soon',
        description: 'Pro subscription will be available in Story 3.4',
      });
    };

    const handleStartPayAsYouGo = async () => {
      // TODO: Story 3.4 - Create PAYG subscription via Lemon Squeezy API
      console.log('Start Pay-As-You-Go clicked');
      // Placeholder: Show toast message
      toast({
        title: 'Coming Soon',
        description: 'Pay-As-You-Go will be available in Story 3.4',
      });
    };
    ```
  - [ ] Wire handlers to PricingCard CTA buttons
  - [ ] Add loading state to buttons (spinner during checkout redirect)
  - [ ] Add error handling (display toast on failure)

- [ ] **Task 9: Add Environment Variable for Pro Message Limit** (AC: 10)
  - [ ] Update `.env.local.example`:
    ```bash
    # Pricing Configuration
    NEXT_PUBLIC_PRO_MESSAGE_LIMIT=100  # TBD based on Week 1 benchmarking
    ```
  - [ ] Read in UpgradeModal component:
    ```typescript
    const proMessageLimit = process.env.NEXT_PUBLIC_PRO_MESSAGE_LIMIT || '[X]';
    ```
  - [ ] Display in pricing card: "$10/month for 100 messages"
  - [ ] If not set, show placeholder: "$10/month for [X] messages"
  - [ ] Document in README or lib/services/pricingService.ts

- [ ] **Task 10: Write Unit Tests for PricingCard Component**
  - [ ] Create `/tests/unit/components/features/upgrade/PricingCard.test.tsx`
  - [ ] Test: Renders tier name, price, description, features
  - [ ] Test: Displays "Recommended" badge for Pro tier
  - [ ] Test: CTA button calls onClick handler
  - [ ] Test: Disabled state grays out card and button
  - [ ] Test: Hover effects work (visual snapshot test)
  - [ ] Mock onClick handler
  - [ ] Use Vitest + React Testing Library

- [ ] **Task 11: Write Unit Tests for UpgradeModal Component**
  - [ ] Create `/tests/unit/components/features/upgrade/UpgradeModal.test.tsx`
  - [ ] Test: Modal opens when open prop is true
  - [ ] Test: Modal closes when onOpenChange called with false
  - [ ] Test: Displays all three pricing tiers (Trial, PAYG, Pro)
  - [ ] Test: Pro tier has "Recommended" badge
  - [ ] Test: "Maybe Later" button closes modal
  - [ ] Test: CTA handlers called with correct arguments
  - [ ] Test: Keyboard escape closes modal
  - [ ] Mock Zustand store with different states
  - [ ] Use Vitest + React Testing Library

- [ ] **Task 12: Write Unit Tests for upgradeModalStore**
  - [ ] Create `/tests/unit/lib/stores/upgradeModalStore.test.ts`
  - [ ] Test: Initial state is correct (open: false)
  - [ ] Test: setOpen(true, 'limit_exceeded') updates state
  - [ ] Test: setOpen(false) closes modal
  - [ ] Test: Trigger defaults to 'proactive' if not provided
  - [ ] Use Vitest with @testing-library/react-hooks
  - [ ] Mock Zustand store for isolation

- [ ] **Task 13: Write Integration Tests for Modal Trigger Flow**
  - [ ] Create `/tests/integration/upgrade-modal-trigger.test.tsx`
  - [ ] Test: Modal opens automatically when interpretation fails with LIMIT_EXCEEDED
  - [ ] Test: Modal opens when user clicks "Upgrade" link in nav
  - [ ] Test: Modal opens when user clicks "Upgrade Now" in notification banner (from Story 3.2)
  - [ ] Test: Modal closes when user clicks "Maybe Later"
  - [ ] Test: Modal closes when user clicks backdrop
  - [ ] Test: Modal does NOT open for Pro users (tier: 'pro')
  - [ ] Mock API calls (/api/interpret with 403 error)
  - [ ] Use Vitest + React Testing Library

- [ ] **Task 14: Write Unit Tests for DashboardNav Integration**
  - [ ] Create `/tests/unit/components/layout/DashboardNav-upgrade.test.tsx`
  - [ ] Test: "Upgrade" link renders for trial users
  - [ ] Test: "Upgrade" link renders for PAYG users
  - [ ] Test: "Upgrade" link does NOT render for Pro users
  - [ ] Test: Clicking "Upgrade" link calls setOpen(true, 'proactive')
  - [ ] Test: Link has correct styling and icon
  - [ ] Mock useUpgradeModalStore and useUsageStore
  - [ ] Use Vitest + React Testing Library

- [ ] **Task 15: Write Unit Tests for InterpretationForm Integration**
  - [ ] Create `/tests/unit/components/features/interpretation/InterpretationForm-upgrade.test.tsx`
  - [ ] Test: 403 LIMIT_EXCEEDED error triggers modal (setOpen called with 'limit_exceeded')
  - [ ] Test: 403 TRIAL_EXPIRED error triggers modal
  - [ ] Test: Other 403 errors do NOT trigger modal
  - [ ] Test: 200 success does NOT trigger modal
  - [ ] Test: Network errors do NOT trigger modal
  - [ ] Mock fetch API and useUpgradeModalStore
  - [ ] Use Vitest + React Testing Library

- [ ] **Task 16: Write Unit Tests for Environment Variable Handling**
  - [ ] Create `/tests/unit/components/features/upgrade/UpgradeModal-env.test.tsx`
  - [ ] Test: Displays Pro limit when NEXT_PUBLIC_PRO_MESSAGE_LIMIT=100
  - [ ] Test: Displays "[X]" placeholder when env var not set
  - [ ] Test: Displays "[X]" placeholder when env var is empty string
  - [ ] Test: Handles non-numeric env var gracefully
  - [ ] Mock process.env for different scenarios
  - [ ] Use Vitest + React Testing Library

- [ ] **Task 17: Write Accessibility Tests**
  - [ ] Create `/tests/unit/components/features/upgrade/UpgradeModal-a11y.test.tsx`
  - [ ] Test: Modal has correct ARIA labels (role="dialog", aria-labelledby, aria-describedby)
  - [ ] Test: Focus trap works (Tab cycles through modal elements only)
  - [ ] Test: Escape key closes modal
  - [ ] Test: Initial focus goes to first interactive element
  - [ ] Test: Focus returns to trigger element after close
  - [ ] Test: Pricing cards have proper semantic HTML (<article>, <h3>, <ul>)
  - [ ] Test: CTA buttons have descriptive labels
  - [ ] Use Vitest + React Testing Library + @testing-library/user-event
  - [ ] Run axe-core accessibility audit

- [ ] **Task 18: Write Visual Regression Tests for PricingCard States**
  - [ ] Create `/tests/unit/components/features/upgrade/PricingCard-visual.test.tsx`
  - [ ] Test: Snapshot of default card (PAYG)
  - [ ] Test: Snapshot of recommended card (Pro with badge)
  - [ ] Test: Snapshot of disabled card (Trial)
  - [ ] Test: Hover state applies correct styles
  - [ ] Test: Recommended badge positioned correctly
  - [ ] Use Vitest with snapshot testing
  - [ ] Optional: Use Playwright for true visual regression

- [ ] **Task 19: Write Integration Tests for Modal State Across User Tiers**
  - [ ] Create `/tests/integration/upgrade-modal-tiers.test.tsx`
  - [ ] Test: Trial user sees Trial as disabled, PAYG and Pro as active
  - [ ] Test: PAYG user sees PAYG as current, Pro as upgrade option
  - [ ] Test: Pro user does not see modal (upgrade link hidden)
  - [ ] Test: messagesUsed and messagesLimit displayed correctly per tier
  - [ ] Test: Modal displays correct tier-specific copy
  - [ ] Mock useUsageStore with different tier states
  - [ ] Use Vitest + React Testing Library

- [ ] **Task 20: Manual Testing of Upgrade Modal**
  - [ ] Create trial user with 10/10 messages (limit exceeded)
  - [ ] Attempt interpretation â†’ verify modal opens automatically
  - [ ] Verify modal displays three pricing tiers
  - [ ] Verify Pro tier has "Recommended" badge
  - [ ] Verify pricing copy includes value proposition
  - [ ] Click "Subscribe to Pro" â†’ verify placeholder toast appears
  - [ ] Click "Start Pay-As-You-Go" â†’ verify placeholder toast appears
  - [ ] Click "Maybe Later" â†’ verify modal closes
  - [ ] Click "Upgrade" link in nav â†’ verify modal opens
  - [ ] Test on mobile device (modal should be full-screen)
  - [ ] Test keyboard navigation (Tab, Escape, Enter)

- [ ] **Task 21: Manual Testing of Responsive Design**
  - [ ] Test on mobile (< 640px):
    - Modal should be full-screen
    - Pricing cards should stack vertically
    - Text should be readable without zooming
  - [ ] Test on tablet (640px - 1024px):
    - Modal should be centered, responsive height
    - Pricing cards should stack vertically (better readability)
  - [ ] Test on desktop (> 1024px):
    - Modal should be max-width 600px, centered
    - Pricing cards should stack vertically (600px modal too narrow for multi-column)
  - [ ] Verify WCAG 2.1 AA compliance (contrast ratios, font sizes)

- [ ] **Task 22: Manual Testing of Trigger Scenarios**
  - [ ] Scenario 1: Limit exceeded trigger
    - Trial user at 10/10 â†’ attempt interpretation â†’ modal opens
  - [ ] Scenario 2: Proactive trigger
    - Trial user at 5/10 â†’ click "Upgrade" in nav â†’ modal opens
  - [ ] Scenario 3: Notification banner trigger
    - Trial user at 8/10 â†’ notification banner appears â†’ click "Upgrade Now" â†’ modal opens
  - [ ] Scenario 4: Pro user (should NOT trigger)
    - Pro user â†’ attempt interpretation at limit â†’ modal does NOT open (different behavior in Story 3.4)

- [ ] **Task 23: Build and Lint Validation**
  - [ ] Run TypeScript compilation: `npx tsc --noEmit`
  - [ ] Verify no TypeScript errors
  - [ ] Run ESLint: `npm run lint`
  - [ ] Verify no ESLint errors (warnings acceptable)
  - [ ] Run unit tests: `npm test tests/unit`
  - [ ] Run integration tests: `npm test tests/integration`
  - [ ] Verify all tests pass
  - [ ] Check bundle size impact (< 300KB total goal)

- [ ] **Task 24: Commit Changes**
  - [ ] Stage all changes: `git add .`
  - [ ] Commit with conventional commit message: `feat(upgrade): add upgrade modal with pricing tiers (Story 3.3)` [Source: docs/architecture/16-coding-standards.md#conventional-commits]
  - [ ] Push to GitHub: `git push origin main`
  - [ ] Verify CI pipeline passes

---

## Dev Notes

### Story Context and Integration

**This story creates the upgrade modal UI that displays pricing options when users hit their limits or want to proactively upgrade.**

**Integration Flow:**
- Story 3.1: Backend usage limit enforcement (DONE)
- Story 3.2: Usage indicator + approaching-limit notifications (APPROVED)
- **Story 3.3 (THIS STORY):** Upgrade modal with pricing tiers (UI only, payment integration in 3.4)
- Story 3.4: Lemon Squeezy payment integration (activates CTA buttons)
- Story 3.5: Billing portal and subscription management

**Key Insights from Story 3.2:**
- `useUsageStore` provides global state for `tier`, `messagesUsed`, `messagesLimit`
- Notification banner has "Upgrade Now" link that should trigger modal
- `/api/interpret` returns 403 with `LIMIT_EXCEEDED` or `TRIAL_EXPIRED` error codes

**What Story 3.3 Adds:**
- âœ¨ **NEW:** UpgradeModal component with three pricing tiers
- âœ¨ **NEW:** PricingCard reusable component for tier display
- âœ¨ **NEW:** upgradeModalStore for modal open/close state
- âœ¨ **NEW:** useTriggerUpgradeModal hook for automatic modal triggering
- âœ¨ **NEW:** "Upgrade" link in navigation menu
- âœ¨ **NEW:** Responsive modal design (mobile full-screen, desktop centered)
- âœ¨ **NEW:** Environment variable for Pro message limit (TBD placeholder)

**What Story 3.4 Will Add:**
- Payment integration: "Subscribe to Pro" and "Start Pay-As-You-Go" buttons will redirect to Lemon Squeezy Checkout
- PAYG subscription creation via Lemon Squeezy API
- Webhook handling for subscription events
- Usage tracking and monthly billing for PAYG users

---

### CRITICAL Architectural Patterns

#### Modal State Management with Zustand

**Pattern:** Use dedicated Zustand store for modal state to enable triggering from multiple locations.

```typescript
// /lib/stores/upgradeModalStore.ts
import { create } from 'zustand';

interface UpgradeModalState {
  open: boolean;
  trigger: 'limit_exceeded' | 'proactive' | 'notification_banner';
  setOpen: (open: boolean, trigger?: UpgradeModalState['trigger']) => void;
}

export const useUpgradeModalStore = create<UpgradeModalState>((set) => ({
  open: false,
  trigger: 'proactive',
  setOpen: (open, trigger = 'proactive') => set({ open, trigger }),
}));
```

**Why This Pattern:**
- Multiple triggers: API error, nav link, notification banner
- Centralized state prevents duplicate modals
- Trigger type enables analytics tracking (which trigger converted best?)
- Simple API: `setOpen(true, 'limit_exceeded')`

**Usage Example:**
```typescript
// In InterpretationForm.tsx - API error trigger
const { setOpen } = useUpgradeModalStore();

const handleSubmit = async () => {
  try {
    await interpretMessage(...);
  } catch (error) {
    if (error.code === 'LIMIT_EXCEEDED') {
      setOpen(true, 'limit_exceeded');  // Trigger modal
    }
  }
};

// In DashboardNav.tsx - Proactive trigger
const { setOpen } = useUpgradeModalStore();

<button onClick={() => setOpen(true, 'proactive')}>
  Upgrade
</button>

// In UsageNotificationBanner.tsx - Notification trigger
const { setOpen } = useUpgradeModalStore();

<a onClick={() => setOpen(true, 'notification_banner')}>
  Upgrade Now
</a>
```

[Source: docs/architecture/10-frontend-architecture.md, docs/architecture/3-tech-stack.md]

---

#### shadcn/ui Dialog Component Pattern

**Pattern:** Use shadcn/ui Dialog for accessible modal implementation.

```tsx
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';

export function UpgradeModal({ open, onOpenChange, ...props }: UpgradeModalProps) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle>Upgrade Your Plan</DialogTitle>
          <DialogDescription>
            Continue interpreting cross-cultural messages with unlimited confidence
          </DialogDescription>
        </DialogHeader>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {/* Pricing cards */}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Maybe Later
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Why shadcn/ui Dialog:**
- WCAG 2.1 AA compliant out-of-box (focus trap, keyboard navigation, ARIA labels)
- Radix UI primitives (battle-tested accessibility)
- Customizable with Tailwind (matches design system)
- Responsive by default (mobile-friendly)
- No bundle bloat (copy-paste, not npm dependency)

**Key Features:**
- **Focus trap**: Tab key stays within modal
- **Escape key**: Closes modal
- **Backdrop click**: Closes modal (configurable)
- **Portal rendering**: Modal renders at root level (prevents z-index issues)

[Source: docs/architecture/3-tech-stack.md, docs/architecture/16-coding-standards.md]

---

### Pricing Tiers Configuration

**Three Tiers (AC: 2):**

**1. Free Trial (Current Plan - Disabled)**
```typescript
{
  title: 'Free Trial',
  price: 'Free',
  description: '14 days, 10 messages',
  status: currentTier === 'trial' ? 'Expired or used up' : 'Already upgraded',
  features: [
    'Limited to 10 interpretations',
    'Expires after 14 days',
    'Cross-cultural messaging insights',
    '10x faster than ChatGPT'
  ],
  ctaText: 'Current Plan',
  ctaVariant: 'outline',
  disabled: true,  // Cannot revert to trial
  recommended: false
}
```

**2. Pay-As-You-Go (Secondary Option)**
```typescript
{
  title: 'Pay-As-You-Go',
  price: '$0.50',
  priceSubtext: 'per interpretation',
  description: 'Use as much as you need, pay only for what you use at month-end',
  features: [
    'No upfront commitment',
    'Billed monthly for usage',
    'Perfect for occasional use',
    '10x faster & more accurate than ChatGPT',
    'No limits - pay only for what you use'
  ],
  ctaText: 'Start Pay-As-You-Go',
  ctaVariant: 'secondary',
  onClick: handleStartPayAsYouGo,  // Story 3.4 integration
  recommended: false
}
```

**3. Pro (Recommended - Primary CTA)**
```typescript
{
  title: 'Pro',
  price: '$10/month',
  description: `${getProMessageLimit()} messages per month`,
  features: [
    `${getProMessageLimit()} interpretations/month`,
    'Monthly usage resets automatically',
    'Best value for regular use',
    '10x faster & more accurate than ChatGPT',
    'Priority support'
  ],
  ctaText: 'Subscribe to Pro',
  ctaVariant: 'default',  // Primary button style
  onClick: handleSubscribeToPro,  // Story 3.4 integration
  recommended: true  // Shows "Recommended" badge
}
```

**Pro Message Limit Placeholder (AC: 10):**
```typescript
function getProMessageLimit(): string {
  const limit = process.env.NEXT_PUBLIC_PRO_MESSAGE_LIMIT;
  return limit || '[X]';  // TBD until Week 1 benchmarking
}

// In pricing card:
// If NEXT_PUBLIC_PRO_MESSAGE_LIMIT=100:
//   "$10/month for 100 messages"
// If not set:
//   "$10/month for [X] messages"
```

**Value Proposition Copy (AC: 9):**
- Emphasizes "10x faster than ChatGPT"
- Emphasizes "more accurate" for cultural context
- Uses specific numbers (10x, $0.50, $10/month) for credibility
- Contrasts against "free ChatGPT" to justify pricing
- PAYG framed as "no commitment" vs Pro as "best value"

[Source: Epic 3 AC 2, 9, 10, 11]

---

### Responsive Design Pattern (AC: 8)

**Mobile-First Approach with Vertical Stack:**

Given the modal max-width of 600px, pricing cards will **stack vertically** for optimal readability:

```tsx
// All screen sizes: Vertical stack for better readability
<DialogContent className="sm:max-w-[600px] h-full sm:h-auto">
  <div className="grid grid-cols-1 gap-4">
    {/* All 3 pricing cards stack vertically, even on desktop */}
    {/* This ensures each card is readable and CTA buttons are prominent */}
    <PricingCard tier="trial" {...trialProps} />
    <PricingCard tier="payg" {...paygProps} />
    <PricingCard tier="pro" {...proProps} />
  </div>
</DialogContent>
```

**Why vertical stack:**
- 600px modal width is too narrow for multi-column layout (< 200px per card)
- 2-column layout creates awkward asymmetry with 3 cards
- Vertical stack ensures optimal readability and CTA button visibility
- Users can scroll vertically if needed (modal has internal scroll)
- Consistent experience across all screen sizes

**Tailwind Breakpoints:**
- Mobile: < 640px â†’ Full-screen dialog, vertical stack
- Tablet: 640px - 1024px â†’ Centered dialog, vertical stack
- Desktop: 1024px+ â†’ Max-width 600px dialog, vertical stack

**Typography Scaling:**
```tsx
// Modal title
<DialogTitle className="text-xl sm:text-2xl font-bold">
  Upgrade Your Plan
</DialogTitle>

// Pricing card price
<span className="text-2xl sm:text-3xl font-bold">
  $10
</span>
<span className="text-sm text-muted-foreground">/month</span>
```

**WCAG 2.1 AA Compliance:**
- Minimum text size: 16px (mobile), 18px (desktop)
- Contrast ratios: 4.5:1 for body text, 3:1 for large text
- Focus indicators: Visible outline on keyboard focus
- Semantic HTML: `<dialog>`, `<h2>`, `<ul>`, `<button>`

[Source: Epic 3 AC 8, docs/architecture/10-frontend-architecture.md]

---

### Pricing Card Component Design

**Component Structure:**

```tsx
// /components/features/upgrade/PricingCard.tsx
'use client';

import { Button } from '@/components/ui/button';
import { Check } from 'lucide-react';

interface PricingCardProps {
  tier: 'trial' | 'payg' | 'pro';
  title: string;
  price: string;
  priceSubtext?: string;
  description: string;
  features: string[];
  ctaText: string;
  ctaVariant: 'default' | 'outline' | 'secondary';
  recommended?: boolean;
  disabled?: boolean;
  onCtaClick: () => void;
}

export function PricingCard({
  tier,
  title,
  price,
  priceSubtext,
  description,
  features,
  ctaText,
  ctaVariant,
  recommended = false,
  disabled = false,
  onCtaClick,
}: PricingCardProps) {
  return (
    <div
      className={`
        relative rounded-lg border p-6 shadow-sm transition-all
        ${recommended ? 'border-blue-600 shadow-blue-100' : 'border-gray-200'}
        ${disabled ? 'opacity-60' : 'hover:shadow-md'}
      `}
    >
      {/* Recommended Badge */}
      {recommended && (
        <div className="absolute -top-3 left-1/2 -translate-x-1/2">
          <span className="bg-blue-600 text-white text-xs font-semibold px-3 py-1 rounded-full">
            Recommended
          </span>
        </div>
      )}

      {/* Header */}
      <div className="text-center mb-4">
        <h3 className="text-lg font-bold mb-2">{title}</h3>
        <div className="flex items-baseline justify-center gap-1">
          <span className="text-3xl font-bold">{price}</span>
          {priceSubtext && (
            <span className="text-sm text-muted-foreground">{priceSubtext}</span>
          )}
        </div>
        <p className="text-sm text-muted-foreground mt-2">{description}</p>
      </div>

      {/* Features */}
      <ul className="space-y-2 mb-6">
        {features.map((feature, index) => (
          <li key={index} className="flex items-start gap-2 text-sm">
            <Check className="h-5 w-5 text-green-600 shrink-0" />
            <span>{feature}</span>
          </li>
        ))}
      </ul>

      {/* CTA Button */}
      <Button
        variant={ctaVariant}
        className="w-full"
        onClick={onCtaClick}
        disabled={disabled}
      >
        {ctaText}
      </Button>
    </div>
  );
}
```

**Visual Hierarchy:**
1. **Recommended badge** (if applicable) - draws eye first
2. **Price** - largest text, bold
3. **Title** - secondary prominence
4. **Features list** - scannable with checkmarks
5. **CTA button** - full width, clear action

**Styling Variations:**
- **Recommended (Pro)**: Blue border, blue badge, shadow, "default" button (primary blue)
- **Secondary (PAYG)**: Gray border, no badge, "secondary" button (gray)
- **Disabled (Trial)**: Gray border, reduced opacity, "outline" button (disabled)

[Source: docs/architecture/6-components.md]

---

### Modal Trigger Scenarios

**1. Automatic Trigger: Limit Exceeded (AC: 1)**

```typescript
// In InterpretationForm.tsx
const { setOpen } = useUpgradeModalStore();

const handleSubmit = async (data: FormData) => {
  try {
    const response = await fetch('/api/interpret', { ... });

    if (response.status === 403) {
      const error = await response.json();
      if (error.error.code === 'LIMIT_EXCEEDED' || error.error.code === 'TRIAL_EXPIRED') {
        setOpen(true, 'limit_exceeded');  // Trigger modal automatically
      }
    }
  } catch (error) {
    // Handle network errors
  }
};
```

**When:**
- Trial user attempts interpretation at 10/10 messages
- Trial user attempts interpretation after 14 days
- Pro user attempts interpretation at 100/100 messages (Story 3.4 may handle differently)

**2. Proactive Trigger: Navigation Link (AC: 7)**

```typescript
// In DashboardNav.tsx
const { setOpen } = useUpgradeModalStore();
const { tier } = useUsageStore();

return (
  <nav>
    {tier !== 'pro' && (
      <button
        onClick={() => setOpen(true, 'proactive')}
        className="flex items-center gap-2 text-blue-600 hover:text-blue-700"
      >
        <Sparkles className="h-4 w-4" />
        <span>Upgrade</span>
      </button>
    )}
  </nav>
);
```

**When:**
- User wants to upgrade before hitting limit
- User is curious about pricing
- Trial user at 3/10 messages (proactive)

**3. Notification Banner Trigger (AC: from Story 3.2)**

```typescript
// In UsageNotificationBanner.tsx (from Story 3.2)
const { setOpen } = useUpgradeModalStore();

return (
  <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4">
    <p>You've used 8 of 10 trial messages.</p>
    <button
      onClick={() => setOpen(true, 'notification_banner')}
      className="underline"
    >
      Upgrade Now
    </button>
  </div>
);
```

**When:**
- Trial user reaches 8/10 messages (notification appears)
- Pro user reaches 80% of monthly limit

**Analytics Tracking (Future Enhancement):**
```typescript
// Track which trigger converts best
const { setOpen, trigger } = useUpgradeModalStore();

// On successful upgrade (Story 3.4):
analytics.track('Upgrade Completed', {
  trigger: trigger,  // 'limit_exceeded', 'proactive', or 'notification_banner'
  tier: 'pro',
  conversion_path: trigger
});
```

[Source: Epic 3 AC 1, 7]

---

### Placeholder CTA Handlers (Story 3.4 Integration Points)

**Pattern:** Create placeholder handlers that will be replaced in Story 3.4.

```typescript
// /components/features/upgrade/UpgradeModal.tsx
'use client';

import { useState } from 'react';
import { useToast } from '@/components/ui/use-toast';

export function UpgradeModal({ ...props }: UpgradeModalProps) {
  const { toast } = useToast();
  const [loading, setLoading] = useState(false);

  /**
   * TODO: Story 3.4 - Redirect to Lemon Squeezy Checkout
   *
   * Implementation steps:
   * 1. Call /api/checkout/create endpoint
   * 2. Receive Lemon Squeezy checkout URL
   * 3. Redirect user to checkout page
   * 4. Handle success/cancel callbacks
   */
  const handleSubscribeToPro = async () => {
    setLoading(true);
    try {
      // Placeholder: Show coming soon message
      toast({
        title: 'Coming Soon',
        description: 'Pro subscription will be available in Story 3.4',
        variant: 'info',
      });
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to start subscription. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * TODO: Story 3.4 - Create PAYG subscription via Lemon Squeezy API
   *
   * Implementation steps:
   * 1. Call /api/subscription/payg/create endpoint
   * 2. Create usage-based subscription in Lemon Squeezy
   * 3. Update user tier to 'payg' in database
   * 4. Close modal, show success message
   */
  const handleStartPayAsYouGo = async () => {
    setLoading(true);
    try {
      // Placeholder: Show coming soon message
      toast({
        title: 'Coming Soon',
        description: 'Pay-As-You-Go will be available in Story 3.4',
        variant: 'info',
      });
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to start Pay-As-You-Go. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      {/* Modal content */}
      <PricingCard
        tier="pro"
        ctaText="Subscribe to Pro"
        onCtaClick={handleSubscribeToPro}
        disabled={loading}
      />
      <PricingCard
        tier="payg"
        ctaText="Start Pay-As-You-Go"
        onCtaClick={handleStartPayAsYouGo}
        disabled={loading}
      />
    </Dialog>
  );
}
```

**Why Placeholders:**
- Story 3.3 focuses on UI/UX (modal design, trigger logic, responsive layout)
- Story 3.4 adds payment integration (Lemon Squeezy API, webhooks, checkout flow)
- Clear TODO comments document integration points
- Placeholder toast messages enable manual testing of UI flow

[Source: Epic 3 AC 4, 5]

---

### File Locations and Project Structure

**Files to Create:**
```
/lib/stores/
  â””â”€â”€ upgradeModalStore.ts                  # CREATE: Zustand store for modal state

/lib/hooks/
  â””â”€â”€ useTriggerUpgradeModal.ts             # CREATE: Auto-trigger modal on API errors

/components/features/upgrade/
  â”œâ”€â”€ UpgradeModal.tsx                      # CREATE: Main modal component
  â””â”€â”€ PricingCard.tsx                       # CREATE: Reusable pricing tier card

/components/ui/
  â””â”€â”€ dialog.tsx                            # CREATE: shadcn/ui Dialog (via CLI)

/tests/unit/lib/stores/
  â””â”€â”€ upgradeModalStore.test.ts             # CREATE: Modal store tests

/tests/unit/lib/hooks/
  â””â”€â”€ useTriggerUpgradeModal.test.ts        # CREATE: Trigger hook tests

/tests/unit/components/features/upgrade/
  â”œâ”€â”€ UpgradeModal.test.tsx                 # CREATE: Modal component tests
  â””â”€â”€ PricingCard.test.tsx                  # CREATE: Pricing card tests

/tests/integration/
  â””â”€â”€ upgrade-modal-trigger.test.tsx        # CREATE: E2E modal trigger tests
```

**Files to Modify:**
```
/components/layout/
  â””â”€â”€ DashboardNav.tsx                      # MODIFY: Add "Upgrade" link

/app/(dashboard)/
  â””â”€â”€ page.tsx                              # MODIFY: Add UpgradeModal component

/components/features/interpretation/
  â””â”€â”€ InterpretationForm.tsx                # MODIFY: Trigger modal on 403 error

/components/features/dashboard/
  â””â”€â”€ UsageNotificationBanner.tsx           # MODIFY: Add modal trigger to "Upgrade Now" link (from Story 3.2)

/.env.local.example
                                            # MODIFY: Add NEXT_PUBLIC_PRO_MESSAGE_LIMIT
```

[Source: docs/architecture/12-unified-project-structure.md]

---

### Relevant Source Tree

```
towerofbabel/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ (dashboard)/
â”‚       â””â”€â”€ page.tsx                        # MODIFY: Add UpgradeModal
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ button.tsx                      # EXISTING: Use for CTA buttons
â”‚   â”‚   â”œâ”€â”€ dialog.tsx                      # CREATE: Install via shadcn CLI
â”‚   â”‚   â””â”€â”€ toast.tsx                       # EXISTING (Story 3.2): Use for placeholder messages
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ upgrade/
â”‚   â”‚   â”‚   â”œâ”€â”€ UpgradeModal.tsx            # CREATE: Main modal
â”‚   â”‚   â”‚   â””â”€â”€ PricingCard.tsx             # CREATE: Tier card
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â””â”€â”€ UsageNotificationBanner.tsx # MODIFY: Add modal trigger
â”‚   â”‚   â””â”€â”€ interpretation/
â”‚   â”‚       â””â”€â”€ InterpretationForm.tsx      # MODIFY: Trigger modal on error
â”‚   â””â”€â”€ layout/
â”‚       â””â”€â”€ DashboardNav.tsx                # MODIFY: Add "Upgrade" link
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”œâ”€â”€ usageStore.ts                   # EXISTING (Story 3.2): Use for tier info
â”‚   â”‚   â””â”€â”€ upgradeModalStore.ts            # CREATE: Modal state
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ useTriggerUpgradeModal.ts       # CREATE: Auto-trigger hook
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ upgradeModalStore.test.ts   # CREATE
â”‚   â”‚   â”‚   â””â”€â”€ hooks/
â”‚   â”‚   â”‚       â””â”€â”€ useTriggerUpgradeModal.test.ts  # CREATE
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚       â””â”€â”€ features/
â”‚   â”‚           â””â”€â”€ upgrade/
â”‚   â”‚               â”œâ”€â”€ UpgradeModal.test.tsx    # CREATE
â”‚   â”‚               â””â”€â”€ PricingCard.test.tsx     # CREATE
â”‚   â””â”€â”€ integration/
â”‚       â””â”€â”€ upgrade-modal-trigger.test.tsx  # CREATE
â””â”€â”€ .env.local.example                      # MODIFY: Add pricing config
```

---

### Testing Strategy

**Unit Tests (Target: 80% Coverage):**

1. **PricingCard Component Tests** (`PricingCard.test.tsx`):
   - Renders tier name, price, description, features
   - Displays "Recommended" badge for Pro tier
   - CTA button calls onClick handler
   - Disabled state grays out card and button
   - Hover effects work (visual snapshot test)

2. **UpgradeModal Component Tests** (`UpgradeModal.test.tsx`):
   - Modal opens when open prop is true
   - Modal closes when onOpenChange called with false
   - Displays all three pricing tiers
   - Pro tier has "Recommended" badge
   - "Maybe Later" button closes modal
   - CTA handlers called with correct arguments
   - Keyboard escape closes modal

3. **upgradeModalStore Tests** (`upgradeModalStore.test.ts`):
   - Initial state is correct (open: false)
   - setOpen(true, 'limit_exceeded') updates state
   - setOpen(false) closes modal
   - Trigger defaults to 'proactive' if not provided

**Integration Tests (Target: 60% Coverage):**

4. **Modal Trigger Flow Tests** (`upgrade-modal-trigger.test.tsx`):
   - Modal opens automatically when interpretation fails with LIMIT_EXCEEDED
   - Modal opens when user clicks "Upgrade" link in nav
   - Modal opens when user clicks "Upgrade Now" in notification banner
   - Modal closes when user clicks "Maybe Later"
   - Modal closes when user clicks backdrop
   - Modal does NOT open for Pro users

**Manual Testing Scenarios:**

5. **Modal Display Testing:**
   - Create trial user at 10/10 â†’ attempt interpretation â†’ modal opens
   - Verify three pricing tiers displayed
   - Verify Pro has "Recommended" badge
   - Verify pricing copy includes value prop
   - Click CTAs â†’ verify placeholder toasts

6. **Responsive Testing:**
   - Mobile: Full-screen modal, vertical card stack
   - Tablet: Centered modal, 2-column cards
   - Desktop: Max-width 600px, 3-column cards
   - WCAG 2.1 AA compliance verification

7. **Trigger Scenarios:**
   - Limit exceeded trigger â†’ modal opens
   - Proactive trigger (nav link) â†’ modal opens
   - Notification banner trigger â†’ modal opens
   - Pro user â†’ modal does NOT open

**Testing Framework:**
- **Unit Tests:** Vitest + React Testing Library
- **Integration Tests:** Vitest + React Testing Library
- **Mocking Strategy:**
  - Mock Zustand stores: `vi.mock('@/lib/stores/*')`
  - Mock toast: `vi.mock('@/components/ui/use-toast')`
  - Mock API calls: MSW (Mock Service Worker)

[Source: docs/architecture/16-coding-standards.md#testing-standards, docs/architecture/3-tech-stack.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created with upgrade modal and pricing tiers implementation | Scrum Master (Bob) |
| 2025-10-24 | 1.1 | PO validation completed (9.5/10), enhanced Task 5 with all trigger integrations, removed redundant Task 10, fixed responsive layout to vertical stack, added 6 comprehensive test tasks (60% test coverage), status updated to Ready for Implementation | Product Owner (Sarah) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_

---
