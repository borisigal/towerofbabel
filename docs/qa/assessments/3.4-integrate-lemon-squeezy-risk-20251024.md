# Risk Profile: Story 3.4 - Integrate Lemon Squeezy for Subscriptions

**Date:** 2025-10-24
**Reviewer:** Quinn (Test Architect) - Opus 4
**Story:** 3.4 - Integrate Lemon Squeezy for Subscriptions and Metered Billing

---

## Executive Summary

Story 3.4 integrates Lemon Squeezy payment processing to enable Pro subscriptions ($10/month recurring) and Pay-As-You-Go metered billing ($0.50 per interpretation). This is a **HIGH-RISK** implementation with **critical financial and security implications**.

**Risk Overview:**
- **Total Risks Identified:** 24
- **Critical Risks (Score 9):** 5
- **High Risks (Score 6):** 8
- **Medium Risks (Score 4):** 7
- **Low Risks (Score 2-3):** 4
- **Overall Story Risk Score:** 23/100 ⚠️ **VERY HIGH RISK**

**Key Risk Areas:**
- **Security:** Webhook signature verification, API key exposure, SQL injection, unauthorized access
- **Data Integrity:** Duplicate subscriptions, status desynchronization, data corruption
- **Financial:** Double charging, under-charging, revenue leakage, payment fraud
- **Operational:** Test mode in production, monitoring gaps, reconciliation processes
- **Technical:** Third-party API downtime, network failures, performance bottlenecks

---

## Critical Risks Requiring Immediate Attention

### 1. **SEC-001: Webhook Signature Verification Bypass**

**Score: 9 (Critical)**
**Probability:** High (3/3) - Webhook endpoints are public, signature verification code is complex and error-prone
**Impact:** High (3/3) - Complete bypass of payment system, unauthorized tier upgrades, financial fraud

**Detailed Analysis:**

Lemon Squeezy webhooks are sent to a public endpoint (`/api/webhooks/lemonsqueezy`). Without proper signature verification, a malicious actor could:

- Create fake `subscription_created` webhooks to upgrade users to Pro/PAYG without payment
- Send `subscription_cancelled` webhooks to downgrade legitimate paying users
- Manipulate subscription status to disrupt service
- Forge `usage_updated` events to alter billing records

**Attack Vector:**
```bash
# Attacker crafts fake webhook
curl -X POST https://towerofbabel.com/api/webhooks/lemonsqueezy \
  -H "Content-Type: application/json" \
  -H "x-signature: fake_signature" \
  -d '{"meta":{"event_name":"subscription_created"},"data":{"attributes":{"customer_id":"12345"}}}'
```

**Existing Mitigations:**
- ✅ Task 9 implements HMAC SHA-256 signature verification using `crypto.createHmac()`
- ✅ Task 29 includes security tests for signature verification
- ✅ Invalid signatures return 401 Unauthorized

**Required Additional Mitigations:**

1. **IP Whitelist:** Configure Vercel to only accept webhooks from Lemon Squeezy IP ranges
2. **Rate Limiting:** Limit webhook endpoint to 100 requests/minute to prevent DoS
3. **Manual Penetration Testing:** Hire security researcher to attempt signature bypass
4. **Webhook Secret Rotation:** Process to rotate `LEMONSQUEEZY_WEBHOOK_SECRET` quarterly
5. **Monitoring:** Alert on >5% webhook signature verification failures

**Testing Requirements:**
- Unit tests with valid/invalid signatures (✅ Task 29)
- Integration tests with tampered payloads (✅ Task 29)
- **REQUIRED:** Manual penetration testing with crafted HMAC attempts
- **REQUIRED:** Replay attack tests (old signature with new timestamp)

**Residual Risk:** Low (if all mitigations implemented and tested)

---

### 2. **DATA-001: Duplicate Subscription Creation (Race Condition)**

**Score: 9 (Critical)**
**Probability:** Medium (2/3) - Lemon Squeezy may send webhooks concurrently, idempotency check has race window
**Impact:** High (3/3) - Financial double-charging, database corruption, user trust loss

**Detailed Analysis:**

If two `subscription_created` webhooks for the same subscription arrive concurrently, both might pass the idempotency check before either inserts the `LemonSqueezyEvent` record, resulting in:

- Duplicate `Subscription` records in database
- User charged twice for same subscription
- Orphaned subscription data causing reconciliation issues
- Constraint violation errors if `lemonsqueezy_subscription_id` unique constraint triggers

**Race Condition Window:**
```typescript
// Thread A and B both execute concurrently
const existingEvent = await prisma.lemonSqueezyEvent.findUnique({
  where: { lemonsqueezy_event_id: eventId }
}); // Both return null

// Both threads proceed to create event
await prisma.lemonSqueezyEvent.create({ ... }); // Both succeed if race window exists
await handleSubscriptionCreated(payload); // Both create subscription!
```

**Existing Mitigations:**
- ✅ Task 9 implements idempotency check with `LemonSqueezyEvent` table
- ✅ Unique constraint on `lemonsqueezy_subscription_id` prevents duplicate subscriptions
- ✅ Task 28 tests database transactions for atomicity
- ✅ Task 34 tests concurrent webhook processing

**Required Additional Mitigations:**

1. **Transaction Isolation:** Verify Prisma uses `SERIALIZABLE` or `REPEATABLE READ` isolation level
2. **Distributed Lock:** Use Redis lock for critical section (if high concurrency expected)
   ```typescript
   const lock = await redis.lock(`webhook:${eventId}`, 5000);
   try {
     // Check + create event atomically
   } finally {
     await lock.unlock();
   }
   ```
3. **Constraint as Safety Net:** Rely on unique constraint to reject duplicates, handle `PrismaClientKnownRequestError` P2002
4. **Monitoring:** Alert on duplicate key violations to detect race conditions early

**Testing Requirements:**
- Concurrent webhook tests with same `event_id` (✅ Task 34)
- Database constraint violation tests (✅ Task 28)
- Transaction rollback tests (✅ Task 28)
- **REQUIRED:** Load test with 1000 concurrent identical webhooks

**Residual Risk:** Low (Prisma $transaction + unique constraint provides strong protection)

---

### 3. **BUS-001: Double Charging Users (Usage Reporting Idempotency Failure)**

**Score: 9 (Critical)**
**Probability:** Medium (2/3) - Usage reporting is asynchronous, network retries occur, idempotency key generation could fail
**Impact:** High (3/3) - Customer complaints, refunds, reputation damage, potential legal issues

**Detailed Analysis:**

PAYG users are charged $0.50 per interpretation via `reportUsage()` API call. If idempotency fails:

- Same interpretation reported multiple times → user charged 2x or more
- Network retry without idempotency key → duplicate billing
- Lemon Squeezy API doesn't recognize idempotency key → duplicate charge

**Failure Scenarios:**
1. Interpretation succeeds, usage reporting fails (network timeout), retry reports again
2. Idempotency key not unique (UUID collision, though extremely rare)
3. Lemon Squeezy API bug doesn't respect idempotency key
4. Interpretation record deleted before usage reported, regenerates with new ID

**Existing Mitigations:**
- ✅ Task 13 uses `interpretationId` as idempotency key (unique UUID from database)
- ✅ Task 21, 31, 37 test usage reporting idempotency extensively
- ✅ Non-blocking error handling (interpretation succeeds even if reporting fails)
- ✅ Lemon Squeezy API supports `idempotencyKey` parameter

**Required Additional Mitigations:**

1. **Idempotency Key Logging:** Log every `(subscriptionId, interpretationId)` pair sent to Lemon Squeezy
2. **Manual Reconciliation:** Daily cron job compares:
   - Database: `COUNT(*) FROM interpretations WHERE user.tier = 'payg'`
   - Lemon Squeezy: Total usage reported via API
   - Alert if mismatch >5%
3. **Retry Queue:** Failed usage reports go to retry queue (Redis or database table) with exponential backoff
4. **Alert System:** Alert when usage reporting failure rate >5%
5. **Customer Support Process:** Refund process for double-charge complaints

**Testing Requirements:**
- Duplicate `interpretationId` tests (✅ Task 31)
- Network retry simulation (✅ Task 31)
- Lemon Squeezy 409 Conflict handling (✅ Task 31)
- **REQUIRED:** E2E test with real Lemon Squeezy test mode API
- **REQUIRED:** Reconciliation script validation

**Residual Risk:** Medium (Depends on Lemon Squeezy API reliability)

---

### 4. **SEC-002: API Key Exposure in Logs or Error Messages**

**Score: 9 (Critical)**
**Probability:** Low (1/3) - Requires developer error or misconfigured logging
**Impact:** High (3/3) - Complete Lemon Squeezy account compromise, fraudulent charges, data breach

**Detailed Analysis:**

If Lemon Squeezy API keys are exposed:

- Attacker can create subscriptions for any user
- Attacker can cancel all subscriptions
- Attacker can query customer data
- Attacker can generate fake invoices
- Full account takeover possible

**Exposure Vectors:**
1. Logging full `config` object that includes `apiKey`
2. Error messages that echo environment variables
3. Sentry error reports including full request context
4. Console logs in production with API key
5. API responses that accidentally include credentials

**Existing Mitigations:**
- None explicitly specified in story tasks

**Required Mitigations:**

1. **Code Review:** Manual review of all Lemon Squeezy integration code to ensure API keys never logged
2. **Sentry Scrubbing:** Configure Sentry to scrub environment variables
   ```javascript
   Sentry.init({
     beforeSend(event) {
       if (event.request?.env) delete event.request.env;
       return event;
     }
   });
   ```
3. **Linter Rule:** Custom ESLint rule to detect `console.log(config)` or `logger.info({ apiKey })`
4. **Environment Variable Validation:** Startup check validates env vars without echoing values
5. **Error Sanitization:** All user-facing errors sanitized before display
6. **Secrets Scanning:** GitHub secrets scanning enabled, pre-commit hook with `gitleaks`

**Testing Requirements:**
- Unit tests verify error messages don't contain API keys
- Manual review of Sentry error samples in test mode
- Log file inspection in staging environment
- **REQUIRED:** Automated test that logs intentional error, verifies API key not in logs

**Residual Risk:** Low (with comprehensive code review)

---

### 5. **OPS-001: Production Deployment with Test Mode Enabled**

**Score: 9 (Critical)**
**Probability:** Low (1/3) - Requires environment variable misconfiguration
**Impact:** High (3/3) - Revenue loss, customer confusion, subscription data corruption

**Detailed Analysis:**

If `LEMONSQUEEZY_TEST_MODE=true` is accidentally set in production:

- Real customer payment attempts use test mode API
- Payments appear successful but no money collected
- Users upgraded to Pro/PAYG but never charged
- Subscription data corrupted (test vs real subscription IDs mixed)
- Reconciliation impossible (test transactions in production database)

**Impact Calculation:**
- 100 users sign up for Pro ($10/month) in test mode = $1,000 lost revenue/month
- Discovery after 1 month = $1,000 immediate loss
- Customer communication nightmare (downgrade or honor free tier?)
- Database cleanup extremely difficult

**Existing Mitigations:**
- ✅ Task 50 includes production readiness checklist with manual verification

**Required Mitigations:**

1. **CI/CD Validation:** Pre-deployment script checks:
   ```bash
   if [ "$VERCEL_ENV" = "production" ] && [ "$LEMONSQUEEZY_TEST_MODE" = "true" ]; then
     echo "ERROR: Test mode enabled in production!"
     exit 1
   fi
   ```
2. **Startup Health Check:** Application startup fails if:
   ```typescript
   if (process.env.VERCEL_ENV === 'production' && process.env.LEMONSQUEEZY_TEST_MODE === 'true') {
     throw new Error('FATAL: Test mode enabled in production');
   }
   ```
3. **Runtime Alert:** Background job checks every hour, sends PagerDuty alert if test mode detected
4. **Manual Checklist:** Deployment requires manual sign-off on environment variable verification
5. **Audit Log:** Log test mode status at application startup for forensics

**Testing Requirements:**
- Automated test to detect test mode in production environment
- Pre-deployment checklist with manual sign-off
- **REQUIRED:** Staging environment test with production-like env vars
- **REQUIRED:** Post-deployment smoke test verifies production mode active

**Residual Risk:** Low (with proper deployment procedures and automation)

---

## High Risks (Score 6) - Fix Before Launch

### **DATA-002: Webhook Delivery Failure (Lost Payment Events)**
- **Probability:** Medium, **Impact:** Medium, **Score:** 6
- **Mitigation:** Lemon Squeezy automatic retry + daily reconciliation cron job
- **Testing:** Task 40 (webhook retry logic)

### **SEC-003: SQL Injection via Webhook Payload**
- **Probability:** Low, **Impact:** High, **Score:** 6
- **Mitigation:** Prisma ORM parameterization + Zod schema validation (Task 48)

### **TECH-001: Lemon Squeezy API Downtime During Checkout**
- **Probability:** Medium, **Impact:** Medium, **Score:** 6
- **Mitigation:** Circuit breaker pattern, retry logic, user-friendly error messages

### **BUS-002: Under-Charging Users (Usage Reporting Failures)**
- **Probability:** Medium, **Impact:** Medium, **Score:** 6
- **Mitigation:** Daily reconciliation report, alert on failure rate >5%

### **DATA-003: Subscription Status Desynchronization**
- **Probability:** Medium, **Impact:** Medium, **Score:** 6
- **Mitigation:** Daily sync job with Lemon Squeezy API (Task 38)

### **PERF-001: Webhook Processing Timeout (>1000ms)**
- **Probability:** Medium, **Impact:** Medium, **Score:** 6
- **Mitigation:** Optimize queries, async processing, performance tests (Task 42)

### **SEC-004: Unauthorized Checkout Creation for Other Users**
- **Probability:** Low, **Impact:** High, **Score:** 6
- **Mitigation:** Authorization checks, security tests (Task 46)

### **OPS-002: Missing Monitoring for Payment Failures**
- **Probability:** High, **Impact:** Medium, **Score:** 6
- **Mitigation:** Sentry alerts, payment dashboard, daily reports

---

## Medium Risks (Score 4) - Mitigate Before Production

- **PERF-002:** Database lock contention from concurrent webhooks
- **TECH-002:** Lemon Squeezy SDK vulnerabilities
- **DATA-004:** Customer ID conflicts (unique constraint protection)
- **TECH-003:** Network timeouts to Lemon Squeezy
- **BUS-003:** Failed payment not handled gracefully
- **DATA-005:** Orphaned payment records
- **SEC-005:** XSS via webhook custom_data

---

## Low Risks (Score 2-3) - Acceptable with Monitoring

- **PERF-003:** Slow checkout session creation (>500ms)
- **OPS-003:** Documentation inadequacy
- **TECH-004:** Rate limiting on Lemon Squeezy API
- **BUS-004:** Test card data leaked to production

---

## Risk Distribution

### By Category
- **Security (SEC):** 5 risks (2 critical, 3 high)
- **Data (DATA):** 5 risks (1 critical, 3 high, 2 medium)
- **Business (BUS):** 4 risks (1 critical, 1 high, 2 medium)
- **Technical (TECH):** 4 risks (1 high, 3 medium)
- **Operational (OPS):** 3 risks (1 critical, 2 high)
- **Performance (PERF):** 3 risks (1 high, 2 medium)

### By Component
- **Webhook Endpoint:** 8 risks (3 critical, 5 high)
- **Database Transactions:** 5 risks (1 critical, 4 high)
- **Usage Reporting:** 3 risks (1 critical, 2 high)
- **Checkout Flow:** 4 risks (2 high, 2 medium)
- **Environment Config:** 2 risks (1 critical, 1 medium)

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Block Deployment if Failing)

**SEC-001 Tests:**
- Manual penetration testing with tampered HMAC signatures
- Replay attack tests with old signatures
- IP whitelist bypass attempts
- Rate limiting validation under load

**DATA-001 Tests:**
- 1000 concurrent identical webhooks (race condition)
- Database constraint violation handling
- Transaction isolation level verification
- Distributed lock correctness (if implemented)

**BUS-001 Tests:**
- Duplicate interpretationId usage reporting
- Network retry simulation with idempotency
- Lemon Squeezy 409 Conflict handling
- E2E test with real test mode API
- Reconciliation script accuracy

**SEC-002 Tests:**
- Error message scrubbing validation
- Sentry scrubbing configuration tests
- Log file inspection for API keys
- Automated secrets detection

**OPS-001 Tests:**
- CI/CD validation for production env vars
- Startup health check for test mode detection
- Post-deployment smoke test for production mode

### Priority 2: High Risk Tests (Must Pass Before Launch)

**DATA-002 Tests:** Webhook delivery failure + Lemon Squeezy retry (Task 40)
**TECH-001 Tests:** Circuit breaker, API timeout handling, status page monitoring
**BUS-002 Tests:** Daily reconciliation report validation, alert threshold tests
**DATA-003 Tests:** Database vs Lemon Squeezy sync accuracy (Task 38)
**PERF-001 Tests:** Webhook processing <1000ms p95 (Task 42)
**SEC-004 Tests:** Cross-user checkout prevention (Task 46)
**OPS-002 Tests:** Sentry alert integration, dashboard validation

### Priority 3: Medium/Low Risk Tests (Can Fix Post-Launch)

- Edge cases: Billing period edge cases (Task 43)
- Error handling: Payment failure scenarios (Task 32)
- Performance: Load testing for concurrent payments (Task 42)
- Lifecycle: Full subscription lifecycle tests (Task 35)

---

## Risk Acceptance Criteria

### Must Fix Before Production
- All 5 Critical Risks (Score 9) with mitigations fully implemented and tested
- All 8 High Risks (Score 6) with mitigations implemented
- Critical risk tests passing at 100%
- High risk tests passing at >90%

### Can Deploy with Mitigation
- Medium risks (Score 4) with compensating controls documented
- Monitoring in place for all high/medium risks
- Manual reconciliation process documented and tested
- Incident response runbook created

### Accepted Risks (with Sign-Off Required)
- Low risks (Score 2-3) acceptable with monitoring
- Third-party dependency risks (Lemon Squeezy availability)
- Residual risks documented in risk register

---

## Monitoring Requirements

### Post-Deployment Monitoring (Critical)

**Payment Metrics Dashboard:**
- Successful payments (count, revenue)
- Failed payments (count, failure reasons)
- Subscription status distribution (active/cancelled/expired)
- PAYG usage reporting (count, failures, lag)

**Alerts (PagerDuty/Sentry):**
- Payment failure rate >10% (5-minute window)
- Webhook signature verification failure rate >5%
- Usage reporting failure rate >5%
- Subscription status desync detected (daily check)
- Test mode detected in production
- API key exposure detected (secrets scanning)

**Daily Reports:**
- Reconciliation report (database vs Lemon Squeezy)
- Cancelled subscriptions list
- Failed payment details
- Usage reporting lag analysis

**Performance Monitoring:**
- Webhook processing time (p50, p95, p99)
- Checkout session creation time
- Database transaction time
- Lemon Squeezy API response time

---

## Risk Review Triggers

Re-assess risk profile when:

1. **Architecture Changes:**
   - New payment provider added (Stripe, Paddle)
   - Database migration or schema changes
   - Webhook processing moved to queue (async)

2. **Security Events:**
   - Lemon Squeezy security vulnerability disclosed
   - Payment fraud detected
   - API key compromise suspected

3. **Performance Issues:**
   - Webhook processing timeout rate >10%
   - Database lock contention observed
   - Lemon Squeezy API rate limiting hit

4. **Business Changes:**
   - New pricing tiers added
   - Billing cycle changes (monthly → annual)
   - New payment methods (crypto, bank transfer)

5. **Compliance Requirements:**
   - PCI DSS audit
   - GDPR data breach
   - SOC 2 audit findings

---

## Recommendations for Development Team

### Before Implementation Starts:
1. Conduct security threat modeling session with entire team
2. Review OWASP Top 10 for payment integrations
3. Set up staging environment with production-like data
4. Configure Sentry scrubbing for API keys
5. Create incident response runbook for payment failures

### During Implementation:
6. Implement all Critical Risk mitigations first
7. Use TDD for webhook signature verification
8. Manual code review focused on security (SEC risks)
9. Load testing from day 1 (not at the end)
10. Daily standups review risk mitigation progress

### Before Deployment:
11. Complete all Priority 1 tests (100% passing required)
12. Manual penetration testing by security expert
13. Full reconciliation dry run with test mode data
14. Deployment checklist sign-off from tech lead + product owner
15. PagerDuty on-call schedule confirmed

### Post-Deployment (First 7 Days):
16. Monitor payment dashboard hourly
17. Daily reconciliation reports reviewed
18. Incident response team on standby
19. Customer support briefed on payment issues
20. Rollback plan tested and ready

---

## Conclusion

Story 3.4 is a **HIGH-RISK** implementation (risk score 23/100) due to financial and security implications of payment processing. The story includes comprehensive testing (50 tasks, 33 test-focused), but **5 critical risks require additional mitigations beyond the current task list**.

**Key Success Factors:**
- ✅ Comprehensive test coverage (Tasks 17-50 focus on testing)
- ✅ Security-first approach (signature verification, validation)
- ✅ Idempotency designed into architecture
- ⚠️ **NEEDS:** Manual penetration testing (not in task list)
- ⚠️ **NEEDS:** Production monitoring setup (mentioned but not detailed)
- ⚠️ **NEEDS:** Reconciliation cron job implementation (not in task list)

**Recommendation:** Proceed with implementation ONLY after:
1. All 5 Critical Risk mitigations approved and resourced
2. Manual penetration testing budget secured
3. Monitoring infrastructure ready before deployment
4. Incident response runbook completed and team trained

**Overall Assessment:** Story is **READY FOR IMPLEMENTATION** with the caveat that additional security/operational tasks must be added to ensure critical risks are fully mitigated.

---

**Risk Profile Generated by:** Quinn (Test Architect) - Opus 4
**Date:** 2025-10-24
**Next Review:** After implementation complete, before production deployment
